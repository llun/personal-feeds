{"title":"0244 | ใช้ GPU intel transcode video ด้วย ffmpeg","link":"https://www.icez.net/blog/167400/ffmpeg-transcode-video-intel","date":1585133606000,"content":"<p>API ใหม่ๆ ของ ffmpeg จะทำงานบน vaapi (video accelerator api) เพราะงั้นเวลา transcode เลยต้องใช้ interface ของ vaapi ประมาณนี้</p>\n<pre lang=\"bash\">ffmpeg \\\n  -hwaccel vaapi -hwaccel_device /dev/dri/renderD128 -hwaccel_output_format vaapi \\\n  -i inputfile.mp4 \\\n  -c:v h264_vaapi -b:v 1500k -profile:v main -g 100 \\\n  -c:a aac -b:a 128k \\\n  -f mp4 output.mp4\n</pre>\n<ol>\n<li>สั่ง ffmpeg</li>\n<li>ตั้งค่าให้สัญญาณ video ขาเข้า ไป decode ด้วย vaapi (เพื่อให้เอาผลลัพท์ไปใช้ต่อใน vaapi ได้)</li>\n<li>ระบุสัญญาณ input</li>\n<li>ระบุการแปลง format ให้ใช้ vaapi h264 encoder ปรับ profile/bitrate ตามชอบ option อื่นๆ ไปดูใน docs</li>\n<li>ตั้ง codec เสียง</li>\n<li>เก็บ output เป็น format mp4 ลงไฟล์ output.mp4</li>\n</ol>\n<p>ref: https://trac.ffmpeg.org/wiki/Hardware/VAAPI</p>\n<p>แถม อันนี้ใช้ vlc clean สัญญาณกล้องวงจรปิด ก่อนส่งให้ ffmpeg transcode ต่อ (ไม่รู้ทำไม ffmpeg transcode ตรงๆ ไม่ได้)</p>\n<pre lang=\"bash\">vlc \\\n 'rtsp://192.168.1.102/user=admin&amp;password=&amp;channel=1&amp;stream=0.sdp?' \\\n  --sout '#duplicate{dst=std{access=file,mux=ts,dst=-}}' | \\\n  ffmpeg \\\n    -hwaccel vaapi -hwaccel_device /dev/dri/renderD128 -hwaccel_output_format vaapi \\\n    -i - \\\n    -c:v h264_vaapi -b:v 1500k -profile:v main -g 100  \\\n    -y -f flv rtmp://127.0.0.1/live/cctv2\n</pre>","author":"icez","siteTitle":"icez network","siteHash":"88787adba55f9deb5660f47c4b8baf580eb765815e4a6d536737656e8ab8bde4","entryHash":"41df99323c0e2355e5f7caf48ea33a4b99a84c379dd10071ad9a8e20884e0b46","category":"Thai"}