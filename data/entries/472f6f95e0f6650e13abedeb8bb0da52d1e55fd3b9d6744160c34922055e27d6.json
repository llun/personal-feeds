{"title":"How To Implement Authentication In Next.js With Auth0","link":"https://smashingmagazine.com/2021/05/implement-authentication-nextjs-auto0/","date":1621508400000,"content":"<p>“Authentication” is the action of validating that a user is who he or she claims to be. We usually do this by implementing a credentials system, like user/password, security questions, or even facial recognition.</p>\n<p>“Authorization” determines what a user can (or can’t) do. If we need to handle authentication and authorization in our web application, we will need a security platform or module. We can develop our own platform, implement it, and maintain it. Or we can take the advantage of existing authentication and authorization platforms in the market that are offered as services.</p>\n<p>When evaluating whether it’s better for us to create our own platform, or to use a third-party service, there are some things that we should consider:</p>\n<ul>\n<li>Designing and creating authentication services is not our core skill. There are people working specially focused on security topics that can create better and more secure platforms than us;</li>\n<li>We can save time relying on an existing authentication platform and spend it adding value to the products and services that we care about;</li>\n<li>We don’t store sensitive information in our databases. We separate it from all the data involved in our apps;</li>\n<li>The tools third-party services offer have improved usability and performance, which makes it easier for us to administrate the users of our application.</li>\n</ul>\n<p>Considering these factors, we can say that relying on third-party authentication platforms can be easier, cheaper, and even more secure than creating our own security module. </p>\n<p>In this article, we will see how to implement authentication and authorization in our Next.js applications using one of the existing products in the market: Auth0.</p>\n<h3>What Is Auth0?</h3>\n<p>It allows you to add security to apps developed using any programming language or technology.</p>\n<blockquote> “Auth0 is a flexible, drop-in solution to add authentication and authorization services to your applications.”<br /><br />— <a href=\"https://auth0.com/blog/developing-a-secure-api-with-nestjs-adding-authorization/\">Dan Arias</a>, auth0.com</blockquote>\n\n<p>Auth0 has several interesting features, such as:</p>\n<ul>\n<li><strong>Single Sign-On</strong>: Once you log into an application that uses Auth0, you won’t have to enter your credentials again when entering another one that also uses it. You will be automatically logged in to all of them;</li>\n<li><strong>Social login</strong>: Authenticate using your preferred social network profile;</li>\n<li><strong>Multi-Factor Authentication</strong>;</li>\n<li><strong>Multiple standard protocols</strong> are allowed, such as OpenID Connect, JSON Web Token, or OAuth 2.0;</li>\n<li><strong>Reporting and analytics tools</strong>.</li>\n</ul>\n<p>There is a free plan that you can use to start securing your web applications, covering up to 7000 monthly active users. You will start paying when the amount of users increases.</p>\n<p>Another cool thing about Auth0 is that we have a <a href=\"https://github.com/auth0/nextjs-auth0\">Next.js SDK</a> available to use in our app. With this library, created especially for Next.js, we can easily connect to the Auth0 API.</p>\n<h3>Auth0 SDK For Next.js</h3>\n<p>As we mentioned before, Auth0 created (and maintains) a Next.js focused SDK, among other SDKs available to connect to the API using various programming languages. We just need to download the <a href=\"https://www.npmjs.com/package/@auth0/nextjs-auth0\">NPM package</a>, configure some details about our Auth0 account and connection, and we are good to go. </p>\n<p>This SDK gives us tools to implement authentication and authorization with both client-side and server-side methods, using API Routes on the backend and React Context with React Hooks on the frontend. </p>\n<p>Let’s see how some of them work in an example Next.js application.</p>\n<h3>Example Next.js App Using Auth0</h3>\n<p>Let’s go back to our previous video platform example, and create a small app to show how to use Auth0 Next.js SDK. We will set up <a href=\"https://auth0.com/universal-login/\">Auth0’s Universal Login</a>. We will have some YouTube video URLs. They will be hidden under an authentication platform. Only registered users will be able to see the list of videos through our web application.</p>\n<p><strong>Note</strong>: <em>This article focuses on the configuration and use of Auth0 in your Next.js application. We won’t get into details like CSS styling or database usage. If you want to see the complete code of the example app, you can go to <a href=\"https://github.com/smashingmagazine/next-auth0-example\">this GitHub repository</a>.</em></p>\n<h4>Create Auth0 Account And Configure App Details</h4>\n<p>First of all, we need to create an Auth0 account using the <a href=\"https://auth0.com/signup\">Sign Up page</a>. </p>\n<p><img src=\"https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/bd629a09-ac90-4338-ac63-b1be242fc97d/1-authentication-authorization-next-js-auth0.png\" /></p>\n<p>After that, let’s go to the <a href=\"https://manage.auth0.com/\">Auth0 Dashboard</a>. Go to <strong>Applications</strong> and create a new app of type [\"Regular Web Applications\"].</p>\n<p><img src=\"https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/1fcbac0b-b1a0-4ae2-9a86-29199c915284/2-authentication-authorization-next-js-auth0.png\" /></p>\n<p>Now let’s go to the <strong>Settings</strong> tab of the application and, under the <strong>Application URIs</strong> section, configure the following details and save the changes:</p>\n<ul>\n<li><strong>Allowed Callback URLs</strong>: add <code>http://localhost:3000/api/auth/callback</code></li>\n<li><strong>Allowed Logout URLs</strong>: add <code>http://localhost:3000/</code></li>\n</ul>\n<p><img src=\"https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/104b4c0f-8c6b-48c9-b63f-b19743ab0a7e/4-authentication-authorization-next-js-auth0.png\" /></p>\n<p>By doing this, we are configuring the URL where we want to redirect the users after they login our site (Callback), and the URL where we redirect the users after they log out (Logout). We should add the production URLs when we deploy the final version of our app to the hosting server.</p>\n<p>Auth0 Dashboard has many configurations and customizations we can apply to our projects. We can change the type of authentication we use, the login/sign-up page, the data we request for the users, enable/disable new registrations, configure users' databases, and so on.</p>\n<h4>Create Next.js App</h4>\n<p>To create a brand new Next.js app, we will use <a href=\"https://www.npmjs.com/package/create-next-app\">create-next-app</a>, which sets up everything automatically for you. To create the project, run:</p>\n<pre><code>npx create-next-app [name-of-the-app]\n</code></pre>\n\n<p>Or</p>\n<pre><code>yarn create next-app [name-of-the-app]\n</code></pre>\n\n<p>To start the develop server locally and see the site just created in your browser, go to the new folder that you created:</p>\n<pre><code>cd [name-of-the-app]</code></pre>\n\n<p>And run:</p>\n<pre><code>npm run dev\n</code></pre>\n\n<p>Or</p>\n<pre><code>yarn dev\n</code></pre>\n\n<h4>Install And Configure The Auth0 Next.js SDK</h4>\n<p>Let’s install the Auth0 Next.js SDK in our app:</p>\n<pre><code>npm install @auth0/nextjs-auth0\n</code></pre>\n\n<p>Or</p>\n<pre><code>yarn add @auth0/nextjs-auth0\n</code></pre>\n\n<p>Now, in our env.local file (or the environment variables menu of our hosting platform), let’s add these variables:</p>\n<div>\n<pre><code>AUTH0_SECRET=\"[A 32 characters secret used to encrypt the cookies]\"\nAUTH0_BASE_URL=\"<a href=\"http://localhost:3000&quot;\">http://localhost:3000\"</a>\nAUTH0_ISSUER_BASE_URL=\"https://[Your tenant domain. Can be found in the Auth0 dashboard under settings]\"\nAUTH0_CLIENT_ID=\"[Can be found in the Auth0 dashboard under settings]\"\nAUTH0_CLIENT_SECRET=\"[Can be found in the Auth0 dashboard under settings]\"\n</code></pre>\n</div>\n\n<p><img src=\"https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/23ca996e-3e47-4acd-9855-9d7b5236c03b/3-authentication-authorization-next-js-auth0.png\" /></p>\n<p>If you want more configuration options, you can <a href=\"https://auth0.github.io/nextjs-auth0/modules/config.html\">take a look at the docs</a>.</p>\n<h4>Create the Dynamic API Route</h4>\n<p>Next.js offers a way to create serverless APIs: <a href=\"https://nextjs.org/docs/api-routes/introduction\">API Routes</a>. With this feature, we can create code that will be executed in every user request to our routes. We can define fixed routes, like <code>/api/index.js</code>. But we can also have <a href=\"https://nextjs.org/docs/api-routes/dynamic-api-routes\">dynamic API routes</a>, with params that we can use in our API routes code, like <code>/api/blog/[postId].js</code>.</p>\n<p>Let’s create the file <code>/pages/api/auth/[...auth0].js</code>, which will be a dynamic API route. Inside of the file, let’s import the <code>handleAuth</code> method from the Auth0 SDK, and export the result:</p>\n<pre><code>import { handleAuth } from '@auth0/nextjs-auth0';\n\nexport default handleAuth();</code></pre>\n\n<p>This will create and handle the following routes:</p>\n<ul>\n<li><code>/api/auth/login</code><br />To perform login or sign up with Auth0.</li>\n<li><code>/api/auth/logout</code><br />To log the user out.</li>\n<li><code>/api/auth/callback</code><br />To redirect the user after a successful login.</li>\n<li><code>/api/auth/me</code><br />To get the user profile information.</li>\n</ul>\n<p>And that would be the server-side part of our app. If we want to log in to our application or sign up for a new account, we should visit <code>http://localhost:3000/api/auth/login</code>. We should add a link to that route in our app. Same for logging out from our site: Add a link to <code>http://localhost:3000/api/auth/logout</code>.</p>\n<h4>Add The UserProvider Component</h4>\n<p>To handle user authentication state on the frontend of our web application we can use <code>UserProvider</code> React component, available on Auth0 Next.js SDK. the component uses <a href=\"https://reactjs.org/docs/context.html\">React Context</a> internally.</p>\n<p>If you want to access the user authentication state on a Component, you should wrap it with a <code>UserProvider</code> component.</p>\n<pre><code>&lt;UserProvider&gt;\n  &lt;Component {...props} /&gt;\n&lt;/UserProvider&gt;</code></pre>\n\n<p>If we want to access all of the pages in our application, we should add the component to the <code>pages/_app.js</code> file. <code>pages/_app.js</code> overrides the React <code>App</code> component. It’s a feature that Next.js exposes to customize our application. You can read more about it <a href=\"https://nextjs.org/docs/advanced-features/custom-app\">here</a>.</p>\n<pre><code>import React from 'react';\nimport { UserProvider } from '@auth0/nextjs-auth0';\n\nexport default function App({ Component, pageProps }) {\n  return (\n    &lt;UserProvider&gt;\n      &lt;Component {...pageProps} /&gt;\n    &lt;/UserProvider&gt;\n  );\n}</code></pre>\n\n<p>We have a React hook <code>useUser</code> that accesses to the authentication state exposed by <code>UserProvider</code>. We can use it, for instance, to create a kind of welcome page. Let’s change the code of the <code>pages/index.js</code> file:</p>\n<pre><code>import { useUser } from \"@auth0/nextjs-auth0\";\n\nexport default () =&gt; {\n const { user, error, isLoading } = useUser();\n\n if (isLoading) return &lt;div&gt;Loading...&lt;/div&gt;;\n\n if (error) return &lt;div&gt;{error.message}&lt;/div&gt;;\n\n if (user) {\n   return (\n     &lt;div&gt;\n       &lt;h2&gt;{user.name}&lt;/h2&gt;\n       &lt;p&gt;{user.email}&lt;/p&gt;\n       &lt;a href=\"/api/auth/logout\"&gt;Logout&lt;/a&gt;\n     &lt;/div&gt;\n   );\n }\n return &lt;a href=\"/api/auth/login\"&gt;Login&lt;/a&gt;;\n};</code></pre>\n\n<p>The <code>user</code> object contains information related to the user’s identity. If the person visiting the page is not logged in (we don’t have a <code>user</code> object available), we will display a link to the login page. If the user is already authenticated, we will display <code>user.name</code> and <code>user.email</code> properties on the page, and a Logout link.</p>\n<p>Let’s create a videos.js file, with a list of three YouTube video URLs that will only be visible for registered people. To only allow logged users to see this page, we will use <code>withPageAuthRequired</code> method from the SDK.</p>\n<div>\n<pre><code>import { withPageAuthRequired } from \"@auth0/nextjs-auth0\";\n\nexport default () =&gt; {\n return (\n   &lt;div&gt;\n     &lt;a href=\"<a href=\"https://www.youtube.com/watch?v=5qap5aO4i9A&quot;&gt;LoFi\">https://www.youtube.com/watch?v=5qap5aO4i9A\"&gt;LoFi</a> Music&lt;/a&gt;\n     &lt;a href=\"<a href=\"https://www.youtube.com/watch?v=fEvM-OUbaKs&quot;&gt;Jazz\">https://www.youtube.com/watch?v=fEvM-OUbaKs\"&gt;Jazz</a> Music&lt;/a&gt;\n     &lt;a href=\"<a href=\"https://www.youtube.com/watch?v=XULUBg_ZcAU&quot;&gt;Piano\">https://www.youtube.com/watch?v=XULUBg_ZcAU\"&gt;Piano</a> Music&lt;/a&gt;\n   &lt;/div&gt;\n );\n};\n\nexport const getServerSideProps = withPageAuthRequired();</code></pre>\n</div>\n\n<p>Take into consideration that our web application allows any person to sign up for an account, using the Auth0 platform. The user can also re-use an existing Auth0 account, as we’re implementing Universal Login.</p>\n<p>We can create our own registration page to request more details about the user or add payment information to bill them monthly for our service. We can also use the methods exposed in the SDK to handle authorization in an automatic way.</p>\n<h3>Conclusion</h3>\n<p>In this article, we saw how to secure our Next.js applications using Auth0, an authentication and authorization platform. We evaluate the benefits of using a third-party service for the authentication of our web applications compared to creating our own security platform. We created an example Next.js app and we secured it using Auth0 free plan and Auth0 Next.js SDK.</p>\n<p>If you want to deploy an Auth0 example application to <a href=\"https://vercel.com/\">Vercel</a>, you can do it <a href=\"https://github.com/vercel/next.js/tree/canary/examples/auth0\">here</a>.</p>\n<h4>Further Reading And Resources</h4>\n<ul>\n<li><a href=\"https://github.com/auth0/nextjs-auth0#documentation\">Auth0 Next.js SDK</a> GitHub repository, Auth0, GitHub</li>\n<li>“<a href=\"https://auth0.com/blog/ultimate-guide-nextjs-authentication-auth0\">The Ultimate Guide To Next.js Authentication With Auth0</a>,” Sandrino Di Mattia, Auth0 Blog<br /><em>In our example app, we used server-side rendering, with API routes and a serverless approach. If you’re using Next.js for a static site, or a custom server to host your app, this article has some details about how to implement authentication.</em></li>\n<li>“<a href=\"https://auth0.com/docs/universal-login/new-experience\">New Universal Login Experience</a>,” Auth0 Universal Login, Auth0 Docs</li>\n<li>“<a href=\"https://auth0.com/docs/universal-login/universal-vs-embedded-login\">Centralized Universal Login vs. Embedded Login</a>,” Auth0 Universal Login, Auth0 Docs</li>\n</ul>","author":"","siteTitle":"Articles on Smashing Magazine — For Web Designers And Developers","siteHash":"ab069ca35bf300e9db0da36f49701f66485a5b0d2db0471dfeee07cef6204939","entryHash":"472f6f95e0f6650e13abedeb8bb0da52d1e55fd3b9d6744160c34922055e27d6","category":"Tech"}