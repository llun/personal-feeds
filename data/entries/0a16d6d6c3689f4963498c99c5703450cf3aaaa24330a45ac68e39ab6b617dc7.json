{"title":"First Steps with HCP Consul on AWS","link":"https://www.hashicorp.com/blog/first-steps-with-hcp-consul-on-aws","date":1612287000000,"content":"<p>With HashiCorp Cloud Platform (HCP) Consul on AWS moving into general availability, we’re seeing a lot of interest around how users can get started with service discovery and consuming service mesh within their AWS environments. We want to highlight how users can get started using HCP to deploy and consume HashiCorp Consul natively within AWS.</p>\n<p>In this blog, we’ll go through an initial exploration of the HashiCorp Cloud Platform, and show what the overall navigation experience is like. We’ll dig into the HashiCorp Virtual Network (HVN) and explain what the networking model between HCP and existing AWS VPC environments looks like. We’ll also explore getting our first VPC peered with the HVN and configuring the security groups and routing tables for our desired connectivity. Finally, we’ll get HCP Consul deployed and conclude with information on how you can start bringing workloads into Consul’s service mesh. For readers who are interested in a video tour of this blog, at the end we'll have a few getting started videos that will take you through the content we cover in this blog.</p>\n<p>Let's get started!</p><h2><a class=\"__permalink-h\" href=\"#log-in-and-explore-hcp\" aria-label=\"log in and explore hcp permalink\">»</a><a class=\"__target-h\" id=\"log-in-and-explore-hcp\" aria-hidden></a>Log in and Explore HCP</h2>\n<p>When you first navigate to <a href=\"https://portal.cloud.hashicorp.com\">https://portal.cloud.hashicorp.com</a> you’ll be presented with a prompt that asks you to sign into your HCP account. If you haven’t set one up before, you’ll note the option to sign up for a free account on the bottom of the page.</p><img src=https://www.datocms-assets.com/2885/1612213265-1-hcp-login.png alt=HCP Login><p>When signing up for an HCP account, you’ll notice that this account uses GitHub credentials as your login to the platform. You’ll need to allow this access to your GitHub account as part of the registration process for HCP.</p>\n<p>Once you have signed up or logged into HCP, you’ll be presented with a landing page that allows you to perform basic operations across the platform.</p><img src=https://www.datocms-assets.com/2885/1612213299-2-hcp-landing-page.png alt=HCP Dashboard><p>These operations include things like viewing and managing your HashiCorp Virtual Networks (HVNs), as well as deploying both HashiCorp Consul and Vault (this blog assumes that you have signed up for the <a href=\"https://www.hashicorp.com/blog/vault-on-the-hashicorp-cloud-platform-public-beta%5D\">public beta</a>. Once deployed, these resources live in the HCP AWS environment where their platform operations are managed by the HashiCorp SRE team. This is one of the benefits of leveraging HCP to deploy the HashiCorp tools: the care and feeding of these platforms are managed by HashiCorp, allowing you to focus more on consumption of the platform instead of the ground-floor build of the Consul environment.</p><h2><a class=\"__permalink-h\" href=\"#exploring-the-hashicorp-virtual-network-hvn\" aria-label=\"exploring the hashicorp virtual network hvn permalink\">»</a><a class=\"__target-h\" id=\"exploring-the-hashicorp-virtual-network-hvn\" aria-hidden></a>Exploring the HashiCorp Virtual Network (HVN)</h2>\n<p>One of the magic pieces of HCP is the implementation of the HashiCorp Virtual Network (HVN). This network is the environment where the Consul and Vault product workloads are deployed today.</p><img src=https://www.datocms-assets.com/2885/1612213413-3-hvn-1.png alt=HVN><p>During the deployment of an HVN, we select the CIDR block (an IP address range within the HCP platform) that will be used for the environment. You’ll want to be sure you pick a unique CIDR block compared to the environments you plan on connecting to HCP. Today, environments are limited to a single HVN per HCP environment. These HVNs are deployed to a specific cloud provider (AWS in this case) and region within that environment. As you can see in the screenshot above, I’ve deployed my HVN to us-west-2.</p>\n<p>When operators look to bring their workloads into HCP, they’ll execute a peering operation between the HVN environment as well as the end user’s AWS account and VPC. Let’s dig in a bit more on HCP peering.</p><h2><a class=\"__permalink-h\" href=\"#understanding-and-peering-with-the-hvn\" aria-label=\"understanding and peering with the hvn permalink\">»</a><a class=\"__target-h\" id=\"understanding-and-peering-with-the-hvn\" aria-hidden></a>Understanding and Peering with the HVN</h2>\n<p>Peering is an activity we expect cloud teams to perform often within the HCP environment because it truly allows a multi-tenant experience to exist for user workloads. Peering gives a simple path for users to connect the HashiCorp platforms deployed within HCP to the workloads deployed in their AWS VPCs. This action must be taken before you can start to bring workloads into the environment.</p>\n<p>To get started peering a VPC, select the “Create peering connection” button in the center of the “Peering Connections” screen.</p><img src=https://www.datocms-assets.com/2885/1612213470-4-peering-hvn.png alt=HVN Peering><p>Within the “Create peering connection” screen, you’ll be prompted for a few pieces of information around your existing AWS environment.</p>\n<ul>\n<li>Your AWS account ID</li>\n<li>VPC ID</li>\n<li>VPC region</li>\n<li>And the CIDR block for your VPC</li>\n</ul><img src=https://www.datocms-assets.com/2885/1612213524-5-peering-details.png alt=Create Peering Connection><p>We’ve provided tips within the HCP UI on where you can find this data from inside your AWS account. Note that one of the most important things to remember is that the network ranges you are peering with HCP cannot be overlapping ranges.</p>\n<p>Once you select “Create Connection” on the bottom of the screen, you’ll land on a screen that shows you the status of current peering connections within your environment. You should see a new entry that indicates it is “Pending Acceptance.”</p><img src=https://www.datocms-assets.com/2885/1612213545-6-pending-acceptance.png alt=Viewing HVN Peering><p>From here, we need to accept the peering request in our AWS account. If we select the peering connection, HCP provides steps for how to update your VPC with this peering data both from a CLI/Terminal perspective as well as a web console perspective.</p><img src=https://www.datocms-assets.com/2885/1612213568-7-accept-peer.png alt=HVN completed peering ><p>In my example, I leveraged the AWS CLI to execute the peering acceptance. Once the acceptance completes (which can take a few moments), you’ll see an “Active” peering status on the Peering connections screen within HCP.</p><img src=https://www.datocms-assets.com/2885/1612213596-8-peered.png alt=Active peering connection><p>In order to leverage this VPC peering connectivity, we’ll need to update some of our security groups and routing tables within the AWS environment. Select the peering connection again and you’ll be able to view instructions for updating the VPC’s connectivity details.</p><img src=https://www.datocms-assets.com/2885/1612213651-9-update-sg-and-rt.png alt=CLI for updating security groups and route tables><p>This set of instructions includes updating the security groups to include the necessary ports for communication with HCP Consul as well as setting up the route table to traverse the peering connection for communicating within HCP.</p>\n<p>Fill in your AWS security group ID and route table ID and the page will automatically update, providing you with the correct CLI command to update your AWS VPC configuration.</p>\n<p>At this point, we’ve successfully peered our VPC to the HCP HVN, as well as allowed network communications. Any workloads that are deployed into this VPC should now be able to communicate with the HCP resources. Let's take a look at how we actually deploy HashiCorp Consul within HCP.</p><h2><a class=\"__permalink-h\" href=\"#deploying-hcp-consul\" aria-label=\"deploying hcp consul permalink\">»</a><a class=\"__target-h\" id=\"deploying-hcp-consul\" aria-hidden></a>Deploying HCP Consul</h2>\n<p>On the left navigation bar, we can select the Overview section to return to the main landing page. On the top, you’ll see the “Create a Consul cluster” navigation box (you can also jump straight into Consul by selecting Consul from the menu on the left as well). Select the Deploy Consul button beneath it.</p><img src=https://www.datocms-assets.com/2885/1612214293-10-deploy-consul-cluster.png alt=Deploy HCP Resources><p>This drops us into the guided process for deploying out a HashiCorp Consul cluster within HCP.</p>\n<p>Here we can set the name of our cluster, our HCP Consul tier (Development in my case), whether this cluster should be externally accessible (i.e., given an external address for the user interface and API interactions), and finally the Consul version to deploy. At the time of this announcement, HCP Consul supports both 1.9.1 as well as 1.9.2.</p><img src=https://www.datocms-assets.com/2885/1612214314-11-create-consul-cluster.png alt=Details for HCP Consul><p>In the case of a development cluster, we’re deploying a single-node server environment for Consul. The outcome of this choice is reduced redundancy, but at a significantly reduced cost. This option is extremely viable for operators looking to take HCP Consul for a test drive without paying for the full-scale Consul service.</p>\n<p>Use caution when choosing whether to enable or leave disabled the external network accessibility for Consul. This can pose a security risk to organizations, and you may not want to leave the control plane accessible outside of AWS.</p>\n<p>Select “Create cluster” and our cluster will begin to deploy. After a short while, you’ll be presented with the completion window below.</p><img src=https://www.datocms-assets.com/2885/1612214341-12-done-building.png alt=Deployed HCP Consul cluster><p>Contained within the client configuration download is the certificate file for your environment as well as the client_configuration file, which contains the following configuration details:</p>\n<ul>\n<li>ACL configuration details (not the ACL itself, though)</li>\n<li>Encryption configuration details</li>\n<li>Datacenter name</li>\n<li>Consul server join configuration (specifically, the private DNS address)</li>\n<li>Assorted cluster settings</li>\n</ul>\n<p>You will need this information in order to connect client workloads (i.e., Elastic Kubernetes Service (EKS) clusters or EC2 instances) to the Consul control plane.</p>\n<p>With this file in hand, and your cluster provisioning completed, you’re able to get started connecting workloads to HCP.</p><h2><a class=\"__permalink-h\" href=\"#next-steps-with-hcp-consul\" aria-label=\"next steps with hcp consul permalink\">»</a><a class=\"__target-h\" id=\"next-steps-with-hcp-consul\" aria-hidden></a>Next Steps with HCP Consul</h2>\n<p>With your fully functional Consul environment in hand, you’re ready to start connecting workloads.</p>\n<p>Our Learn team has created several tutorials to help you get started with connecting platforms like EKS, as well as EC2 instances.\nTo get started, we recommend taking a tour of the HashiCorp Learn section specifically surrounding HashiCorp Cloud Platform <a href=\"https://learn.hashicorp.com/collections/cloud/consul-cloud\">here</a>. In this track you should check out:</p>\n<ul>\n<li><a href=\"https://learn.hashicorp.com/tutorials/cloud/consul-client-virtual-machines?in=cloud/consul-cloud\">Connecting a Client to HCP</a> - This Learn guide takes you through how to configure a client to connect to HCP. Most commonly this is going to be an EC2 instance.</li>\n<li><a href=\"https://learn.hashicorp.com/tutorials/cloud/consul-client-eks?in=cloud/consul-cloud\">Connecting EKS to HCP</a> - This Learn guide takes users through configuring an EKS cluster to join the HCP control plane. We see this being an extremely important guide for users looking to consume service mesh in microservices environments.</li>\n</ul>\n<p>Each of these guides gives users a step-by-step process for adding resources to HCP. They also provide a solid foundation for growing your Consul environment and consuming Consul as a managed service.</p>\n<p>More interested in a video tour of HCP and the getting started process? Take a look at these videos below!</p>\n<ul>\n<li><a href=\"https://youtu.be/qU5lZ8oHPZ0\">HCP Consul - Overview and Tour</a></li>\n<li><a href=\"https://youtu.be/hA73hFZIYuI\">HCP - Peering AWS VPC's with HCP</a></li>\n<li><a href=\"https://youtu.be/b_9Cf_twsE0\">HCP - Joining an AWS EKS Cluster to HashiCorp Cloud Platform</a></li>\n</ul>","author":"Cody DeArkland","siteTitle":"HashiCorp Blog","siteHash":"219aa6310b3388f2335eba49871f4df9581f2c58eaeb5e498363b54e835b7001","entryHash":"0a16d6d6c3689f4963498c99c5703450cf3aaaa24330a45ac68e39ab6b617dc7","category":"Tech"}