{"title":"RabbitMQ :: ทำการ route message ด้วย key แบบ dynamic","link":"https://www.somkiat.cc/rabbitmq-with-consistent-hash-exchange/","date":1619751654000,"content":"<p><img src=\"https://www.somkiat.cc/wp-content/uploads/2021/04/rabbitmq-routing-150x150.png\" /></p>\n<p>คำถามที่น่าสนใจเกี่ยวการจัดการ message ด้วย <a href=\"https://www.rabbitmq.com/\" target=\"_blank\">RabbitMQ</a><br />ถ้าต้องการ route message ด้วย key ที่ต้องการ<br />แต่ key นั้นมัน dynamic เราไม่สามารถกำหนดได้<br />ต้องการให้ message ที่มี key เดียวกันเข้าไปทำงานที่ consumer เดียวกัน<br />เพื่อให้สามารถทำงานได้ตามที่ต้องการทาง business นั่นเอง</p>\n\n\n\n<span></span>\n\n\n\n<p><strong>แนวทางใน RabbitMQ คือการทำ routing นั่นเอง</strong></p>\n\n\n\n<p>ซึ่งจะมีรูปแบบต่าง ๆ ให้เลือกใช้งานดังนี้</p>\n\n\n\n<ul><li>Fanout</li><li>Direct</li><li>Topic</li><li>Header</li><li>Consistent Hashing</li></ul>\n\n\n\n<figure><img src=\"https://www.somkiat.cc/wp-content/uploads/2021/04/rabbitmq-routing.png\" /></figure>\n\n\n\n<p><strong>แต่จาก use case นั้น น่าจะต้องใช้งาน Consistent Hashing</strong></p>\n\n\n\n<p>เนื่องจากเราไม่สามารถรู้เลยว่า key ที่ส่งเข้ามามีค่าอะไรบ้าง<br />ดังนั้นจำเป็นต้องใช้ <strong>Hashing function</strong> เข้ามาช่วย<br />สำหรับการ route message ไปยัง consumer ต่าง ๆ<br />ส่วนฝั่ง consumer จะต้องทำการ binding key ด้วยตัวเลขเท่านั้น<br />กำหนดได้เท่าที่เราต้องการ สามารถเพิ่มหรือลดได้เสมอ</p>\n\n\n\n<figure><img src=\"https://www.somkiat.cc/wp-content/uploads/2021/04/consistent-hashing.png\" /></figure>\n\n\n\n<p><strong>ทำให้มั่นใจได้ว่า message ที่มี key เดียวกัน</strong></p>\n\n\n\n<p>จะเข้าทำงานที่ consumer เดียวกันแน่นอน<br />และถ้าต้องการให้เรียงลำดับการทำงานแบบ <strong>FIFO</strong><br />โดยไม่ทำงานสลับกันทั้งเริ่มและสิ้นสุด<br />จำเป็นต้องกำหนดค่า prefetch=1 <br />และกำหนด noAck=false เพื่อกำหนดการส่ง acknowledge กลับเอง</p>\n\n\n\n<p>แต่การใช้งานจำเป็นต้องติดตั้ง plugin เพิ่ม<br />ชื่อว่า <strong><a href=\"https://github.com/rabbitmq/rabbitmq-server/blob/master/deps/rabbitmq_consistent_hash_exchange/README.md\" target=\"_blank\">RabbitMQ Consistent Hash Exchange</a></strong><br />เพียงเท่านี้ก็สามารถกำหนดให้ RabbitMQ ทำงานตามที่ต้องการแล้ว</p>\n\n\n\n<p><strong><em>ปล. ถ้าเป็น Apache Kafka จบไปนานแล้ว !!</em></strong></p>\n","author":"somkiat","siteTitle":"cc :: somkiat","siteHash":"3a23a5a4389e1e40c6fbb16520a8cc20df5b3591c25145ce72aaa18b19e48201","entryHash":"7bbb1ba0aa86fa72fc05f0ee58976905996ce752b70335e367ef3abec4663fef","category":"Thai"}