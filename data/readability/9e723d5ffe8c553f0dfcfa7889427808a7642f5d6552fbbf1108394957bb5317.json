{"title":"[Golang] มาลองใช้งาน Dockertest สำหรับการทดสอบ","link":"https://www.somkiat.cc/golang-integration-test-with-dockertest/","date":1612084260000,"content":"<div id=\"readability-page-1\" class=\"page\"><div id=\"page\"><article><div id=\"content_box\"><header><div><p><time>January 31, 2021</time> <span><a href=\"https://www.somkiat.cc/category/programming/\" rel=\"category tag\">Programming</a></span></p></div></header><div><figure><img src=\"https://www.somkiat.cc/wp-content/uploads/2021/01/dockertest-1024x684.png\" alt=\"\" srcset=\"https://www.somkiat.cc/wp-content/uploads/2021/01/dockertest-1024x684.png 1024w, https://www.somkiat.cc/wp-content/uploads/2021/01/dockertest-300x200.png 300w, https://www.somkiat.cc/wp-content/uploads/2021/01/dockertest-768x513.png 768w, https://www.somkiat.cc/wp-content/uploads/2021/01/dockertest-1536x1026.png 1536w, https://www.somkiat.cc/wp-content/uploads/2021/01/dockertest.png 1600w\" sizes=\"(max-width: 1024px) 100vw, 1024px\"></figure><p>ในการทดสอบระดับ integration กับ Database ต่าง ๆ นั้น<br>บ่อยครั้งการจะทำการจำลองหรือ mock database<br>ทั้งผ่าน interface หรืออาจจะใช้งาน SQLMock ก็ได้<br>หรือบางคนใช้งาน Docker อยู่แล้ว<br>ก็เขียน script หรือ Make file มาใช้งาน<br>แต่เจอว่า มี package ชื่อว่า <strong><a href=\"https://github.com/ory/dockertest\" target=\"_blank\" rel=\"noreferrer noopener\">Dockertest</a></strong><br>มาช่วยให้การทดสอบกับ database ผ่าน Docker container ได้สะดวกขึ้น<br>มาลองทำความรู้จักกันหน่อย</p><p><strong>Dockertest เป็น package เล็ก ๆ</strong></p><p>ที่ช่วยให้เราสามารถสร้างและลบ Docker container ด้วย code ได้เลย<br>เช่นการสร้าง Database container ต่าง ๆ ขึ้นมา<br>ก่อนที่จะทำการทดสอบตาม test case และ test scenario ที่ต้องการ<br></p><p><strong>การใช้งานก็ไม่ยาก เขียนใน test ได้เลย</strong></p><p>โดยแยกส่วนการทำงานนิดหน่อย</p><ul><li>ทำการ initial database ผ่าน <a href=\"https://golang.org/pkg/testing/#hdr-Main\" target=\"_blank\" rel=\"noreferrer noopener\">TestMain</a> สำหรับการ setup และ teardown ของแต่ละ test case</li><li>เขียน test case เพื่อใช้งาน</li></ul><p><strong>ขั้นตอนที่ 1 ทำการ initial container ก่อน</strong></p><div itemprop=\"text\" id=\"gist107660749\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-1-go-L1\" data-line-number=\"1\"></td><td id=\"file-1-go-LC1\"><span>var</span> <span>pool</span> <span>*</span>dockertest.<span>Pool</span></td></tr><tr><td id=\"file-1-go-L2\" data-line-number=\"2\"></td><td id=\"file-1-go-LC2\"></td></tr><tr><td id=\"file-1-go-L3\" data-line-number=\"3\"></td><td id=\"file-1-go-LC3\"><span>func</span> <span>TestMain</span>(<span>m</span> <span>*</span>testing.<span>M</span>) {</td></tr><tr><td id=\"file-1-go-L4\" data-line-number=\"4\"></td><td id=\"file-1-go-LC4\"><span>var</span> <span>err</span> <span>error</span></td></tr><tr><td id=\"file-1-go-L5\" data-line-number=\"5\"></td><td id=\"file-1-go-LC5\"><span>pool</span>, <span>err</span> <span>=</span> <span>dockertest</span>.<span>NewPool</span>(<span>\"\"</span>)</td></tr><tr><td id=\"file-1-go-L6\" data-line-number=\"6\"></td><td id=\"file-1-go-LC6\"><span>if</span> <span>err</span> <span>!=</span> <span>nil</span> {</td></tr><tr><td id=\"file-1-go-L7\" data-line-number=\"7\"></td><td id=\"file-1-go-LC7\"><span>log</span>.<span>Fatalf</span>(<span>\"Could not connect to docker: %s\"</span>, <span>err</span>)</td></tr><tr><td id=\"file-1-go-L8\" data-line-number=\"8\"></td><td id=\"file-1-go-LC8\"><span>os</span>.<span>Exit</span>(<span>1</span>)</td></tr><tr><td id=\"file-1-go-L9\" data-line-number=\"9\"></td><td id=\"file-1-go-LC9\">}</td></tr><tr><td id=\"file-1-go-L10\" data-line-number=\"10\"></td><td id=\"file-1-go-LC10\"><span>code</span> <span>:=</span> <span>m</span>.<span>Run</span>()</td></tr><tr><td id=\"file-1-go-L11\" data-line-number=\"11\"></td><td id=\"file-1-go-LC11\"><span>os</span>.<span>Exit</span>(<span>code</span>)</td></tr><tr><td id=\"file-1-go-L12\" data-line-number=\"12\"></td><td id=\"file-1-go-LC12\">}</td></tr></tbody></table></div><p><strong>ขั้นตอนที่ 2 ทำการทดสอบกับ container</strong></p><div itemprop=\"text\" id=\"gist107660749\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-2-go-L1\" data-line-number=\"1\"></td><td id=\"file-2-go-LC1\"><span>func</span> <span>TestWorkingWithDocker</span>(<span>t</span> <span>*</span>testing.<span>T</span>) {</td></tr><tr><td id=\"file-2-go-L2\" data-line-number=\"2\"></td><td id=\"file-2-go-LC2\"><span>for</span> <span>i</span> <span>:=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>10</span>; <span>i</span><span>++</span> {</td></tr><tr><td id=\"file-2-go-L3\" data-line-number=\"3\"></td><td id=\"file-2-go-LC3\"><span>t</span>.<span>Run</span>(<span>fmt</span>.<span>Sprintf</span>(<span>\"%d\"</span>, <span>i</span>), <span>func</span>(<span>t</span> <span>*</span>testing.<span>T</span>) {</td></tr><tr><td id=\"file-2-go-L4\" data-line-number=\"4\"></td><td id=\"file-2-go-LC4\"><span>t</span>.<span>Parallel</span>()</td></tr><tr><td id=\"file-2-go-L5\" data-line-number=\"5\"></td><td id=\"file-2-go-LC5\"><span>db</span> <span>:=</span> <span>connectToDatabase</span>(<span>t</span>)</td></tr><tr><td id=\"file-2-go-L6\" data-line-number=\"6\"></td><td id=\"file-2-go-LC6\"><span>db</span>.<span>Ping</span>()</td></tr><tr><td id=\"file-2-go-L7\" data-line-number=\"7\"></td><td id=\"file-2-go-LC7\"><span>time</span>.<span>Sleep</span>(<span>2</span> <span>*</span> <span>time</span>.<span>Second</span>)</td></tr><tr><td id=\"file-2-go-L8\" data-line-number=\"8\"></td><td id=\"file-2-go-LC8\">})</td></tr><tr><td id=\"file-2-go-L9\" data-line-number=\"9\"></td><td id=\"file-2-go-LC9\">}</td></tr><tr><td id=\"file-2-go-L10\" data-line-number=\"10\"></td><td id=\"file-2-go-LC10\">}</td></tr></tbody></table></div><p><strong>เพียงเท่านี้ก็สามารถทดสอบระบบงานบน Docker container แบบง่าย ๆ ได้แล้ว</strong><br>ใช้ resource เยอะตาม Docker นั่นเอง<br>เป็นอีกทางเลือกที่น่าสนใจ</p><p>มีแนวคิดคล้าย ๆ กันที่เคยแนะนำไปแล้วคือ <strong><a href=\"https://www.somkiat.cc/go-integration-test-with-testcontainer/\" target=\"_blank\" rel=\"noreferrer noopener\">Testing with testcontainer</a></strong></p></div><div><p><img alt=\"\" src=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=90&amp;d=mm&amp;r=g\" srcset=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=180&amp;d=mm&amp;r=g 2x\" height=\"90\" width=\"90\"></p><h4>Article by <a href=\"https://www.facebook.com/somkiatspns\">Somkiat Puisungnoen</a></h4><p>To be Craftmanship</p></div></div></article></div></div>","author":"somkiat","siteTitle":"cc :: somkiat","siteHash":"3a23a5a4389e1e40c6fbb16520a8cc20df5b3591c25145ce72aaa18b19e48201","entryHash":"9e723d5ffe8c553f0dfcfa7889427808a7642f5d6552fbbf1108394957bb5317","category":"Thai"}