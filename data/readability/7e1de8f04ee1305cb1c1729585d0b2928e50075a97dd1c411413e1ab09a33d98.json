{"title":"บันทึกปัญหาเรื่อง Network ใน Docker compose","link":"https://www.somkiat.cc/problem-network-in-docker-compose/","date":1620467516000,"content":"<div id=\"readability-page-1\" class=\"page\"><div id=\"page\"><article><div id=\"content_box\"><header></header><div><figure><img src=\"https://www.somkiat.cc/wp-content/uploads/2021/05/docker-network.jpg\" alt=\"\" width=\"556\" height=\"317\" srcset=\"https://www.somkiat.cc/wp-content/uploads/2021/05/docker-network.jpg 900w, https://www.somkiat.cc/wp-content/uploads/2021/05/docker-network-300x172.jpg 300w, https://www.somkiat.cc/wp-content/uploads/2021/05/docker-network-768x439.jpg 768w\" sizes=\"(max-width: 556px) 100vw, 556px\"></figure><p><strong>ปัญหา</strong></p><p>ทำการพัฒนาระบบงานด้วย NodeJS<br>ทำงานร่วมกับ MySQL ผ่าน ORM library ชื่อว่า <a rel=\"noreferrer noopener\" href=\"https://sequelize.org/\" target=\"_blank\">Sequelize</a><br>ในการ build และ run สำหรับการพัฒนา จะใช้งาน Docker compose<br>แต่ตอน run เจอปัญหา การเชื่อมต่อไปยัง MySQL ดังนี้</p><div itemprop=\"text\" id=\"gist109400215\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-1-txt-L1\" data-line-number=\"1\"></td><td id=\"file-1-txt-LC1\">backend_1 | ConnectionRefusedError [SequelizeConnectionRefusedError]: connect ECONNREFUSED 127.0.0.1:3306</td></tr><tr><td id=\"file-1-txt-L2\" data-line-number=\"2\"></td><td id=\"file-1-txt-LC2\">backend_1 | at ConnectionManager.connect (/src/node_modules/sequelize/lib/dialects/mysql/connection-manager.js:116:17)</td></tr><tr><td id=\"file-1-txt-L3\" data-line-number=\"3\"></td><td id=\"file-1-txt-LC3\">backend_1 | at processTicksAndRejections (node:internal/process/task_queues:96:5)</td></tr><tr><td id=\"file-1-txt-L4\" data-line-number=\"4\"></td><td id=\"file-1-txt-LC4\">backend_1 | at async ConnectionManager._connect (/src/node_modules/sequelize/lib/dialects/abstract/connection-manager.js:318:24)</td></tr><tr><td id=\"file-1-txt-L5\" data-line-number=\"5\"></td><td id=\"file-1-txt-LC5\">backend_1 | at async /src/node_modules/sequelize/lib/dialects/abstract/connection-manager.js:250:32</td></tr><tr><td id=\"file-1-txt-L6\" data-line-number=\"6\"></td><td id=\"file-1-txt-LC6\">backend_1 | at async ConnectionManager.getConnection (/src/node_modules/sequelize/lib/dialects/abstract/connection-manager.js:280:7)</td></tr><tr><td id=\"file-1-txt-L7\" data-line-number=\"7\"></td><td id=\"file-1-txt-LC7\">backend_1 | at async /src/node_modules/sequelize/lib/sequelize.js:613:26</td></tr><tr><td id=\"file-1-txt-L8\" data-line-number=\"8\"></td><td id=\"file-1-txt-LC8\">backend_1 | at async MySQLQueryInterface.createTable (/src/node_modules/sequelize/lib/dialects/abstract/query-interface.js:225:12)</td></tr><tr><td id=\"file-1-txt-L9\" data-line-number=\"9\"></td><td id=\"file-1-txt-LC9\">backend_1 | at async Function.sync (/src/node_modules/sequelize/lib/model.js:1300:5)</td></tr><tr><td id=\"file-1-txt-L10\" data-line-number=\"10\"></td><td id=\"file-1-txt-LC10\">backend_1 | at async Sequelize.sync (/src/node_modules/sequelize/lib/sequelize.js:793:35)</td></tr><tr><td id=\"file-1-txt-L11\" data-line-number=\"11\"></td><td id=\"file-1-txt-LC11\">backend_1 | at async initialize (/src/_helpers/db.js:29:3) {</td></tr><tr><td id=\"file-1-txt-L12\" data-line-number=\"12\"></td><td id=\"file-1-txt-LC12\">backend_1 | parent: Error: connect ECONNREFUSED 127.0.0.1:3306</td></tr><tr><td id=\"file-1-txt-L13\" data-line-number=\"13\"></td><td id=\"file-1-txt-LC13\">backend_1 | at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1133:16) {</td></tr><tr><td id=\"file-1-txt-L14\" data-line-number=\"14\"></td><td id=\"file-1-txt-LC14\">backend_1 | errno: -111,</td></tr><tr><td id=\"file-1-txt-L15\" data-line-number=\"15\"></td><td id=\"file-1-txt-LC15\">backend_1 | code: 'ECONNREFUSED',</td></tr><tr><td id=\"file-1-txt-L16\" data-line-number=\"16\"></td><td id=\"file-1-txt-LC16\">backend_1 | syscall: 'connect',</td></tr><tr><td id=\"file-1-txt-L17\" data-line-number=\"17\"></td><td id=\"file-1-txt-LC17\">backend_1 | address: '127.0.0.1',</td></tr><tr><td id=\"file-1-txt-L18\" data-line-number=\"18\"></td><td id=\"file-1-txt-LC18\">backend_1 | port: 3306,</td></tr><tr><td id=\"file-1-txt-L19\" data-line-number=\"19\"></td><td id=\"file-1-txt-LC19\">backend_1 | fatal: true</td></tr><tr><td id=\"file-1-txt-L20\" data-line-number=\"20\"></td><td id=\"file-1-txt-LC20\">backend_1 | },</td></tr><tr><td id=\"file-1-txt-L21\" data-line-number=\"21\"></td><td id=\"file-1-txt-LC21\">backend_1 | original: Error: connect ECONNREFUSED 127.0.0.1:3306</td></tr><tr><td id=\"file-1-txt-L22\" data-line-number=\"22\"></td><td id=\"file-1-txt-LC22\">backend_1 | at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1133:16) {</td></tr><tr><td id=\"file-1-txt-L23\" data-line-number=\"23\"></td><td id=\"file-1-txt-LC23\">backend_1 | errno: -111,</td></tr><tr><td id=\"file-1-txt-L24\" data-line-number=\"24\"></td><td id=\"file-1-txt-LC24\">backend_1 | code: 'ECONNREFUSED',</td></tr><tr><td id=\"file-1-txt-L25\" data-line-number=\"25\"></td><td id=\"file-1-txt-LC25\">backend_1 | syscall: 'connect',</td></tr><tr><td id=\"file-1-txt-L26\" data-line-number=\"26\"></td><td id=\"file-1-txt-LC26\">backend_1 | address: '127.0.0.1',</td></tr><tr><td id=\"file-1-txt-L27\" data-line-number=\"27\"></td><td id=\"file-1-txt-LC27\">backend_1 | port: 3306,</td></tr><tr><td id=\"file-1-txt-L28\" data-line-number=\"28\"></td><td id=\"file-1-txt-LC28\">backend_1 | fatal: true</td></tr><tr><td id=\"file-1-txt-L29\" data-line-number=\"29\"></td><td id=\"file-1-txt-LC29\">backend_1 | }</td></tr><tr><td id=\"file-1-txt-L30\" data-line-number=\"30\"></td><td id=\"file-1-txt-LC30\">backend_1 | }</td></tr></tbody></table></div><p><strong>เพิ่มเติมเกี่ยวกับ config การเชื่อมต่อไปยัง MySQL จาก NodeJS ดังนี้</strong></p><div itemprop=\"text\" id=\"gist109400215\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-config-json-L1\" data-line-number=\"1\"></td><td id=\"file-config-json-LC1\">{</td></tr><tr><td id=\"file-config-json-L2\" data-line-number=\"2\"></td><td id=\"file-config-json-LC2\"><span><span>\"</span>database<span>\"</span></span>: {</td></tr><tr><td id=\"file-config-json-L3\" data-line-number=\"3\"></td><td id=\"file-config-json-LC3\"><span><span>\"</span>host<span>\"</span></span>: <span><span>\"</span>db<span>\"</span></span>,</td></tr><tr><td id=\"file-config-json-L4\" data-line-number=\"4\"></td><td id=\"file-config-json-LC4\"><span><span>\"</span>port<span>\"</span></span>: <span>3306</span>,</td></tr><tr><td id=\"file-config-json-L5\" data-line-number=\"5\"></td><td id=\"file-config-json-LC5\"><span><span>\"</span>user<span>\"</span></span>: <span><span>\"</span>&lt;db user&gt;<span>\"</span></span>,</td></tr><tr><td id=\"file-config-json-L6\" data-line-number=\"6\"></td><td id=\"file-config-json-LC6\"><span><span>\"</span>password<span>\"</span></span>: <span><span>\"</span>&lt;db password&gt;<span>\"</span></span>,</td></tr><tr><td id=\"file-config-json-L7\" data-line-number=\"7\"></td><td id=\"file-config-json-LC7\"><span><span>\"</span>database<span>\"</span></span>: <span><span>\"</span>&lt;db name&gt;<span>\"</span></span></td></tr><tr><td id=\"file-config-json-L8\" data-line-number=\"8\"></td><td id=\"file-config-json-LC8\">},</td></tr><tr><td id=\"file-config-json-L9\" data-line-number=\"9\"></td><td id=\"file-config-json-LC9\"><span><span>\"</span>secret<span>\"</span></span>: <span><span>\"</span>xxx<span>\"</span></span></td></tr><tr><td id=\"file-config-json-L10\" data-line-number=\"10\"></td><td id=\"file-config-json-LC10\">}</td></tr></tbody></table></div><p><strong>ส่วน Docker compose file เป็นดังนี้</strong></p><div itemprop=\"text\" id=\"gist109400215\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-docker-compose-yml-L1\" data-line-number=\"1\"></td><td id=\"file-docker-compose-yml-LC1\"><span>version</span>: <span><span>\"</span>3.9<span>\"</span></span></td></tr><tr><td id=\"file-docker-compose-yml-L2\" data-line-number=\"2\"></td><td id=\"file-docker-compose-yml-LC2\"><span>services</span>:</td></tr><tr><td id=\"file-docker-compose-yml-L3\" data-line-number=\"3\"></td><td id=\"file-docker-compose-yml-LC3\"></td></tr><tr><td id=\"file-docker-compose-yml-L4\" data-line-number=\"4\"></td><td id=\"file-docker-compose-yml-LC4\"><span>backend</span>:</td></tr><tr><td id=\"file-docker-compose-yml-L5\" data-line-number=\"5\"></td><td id=\"file-docker-compose-yml-LC5\"><span>build</span>: <span>./backend</span></td></tr><tr><td id=\"file-docker-compose-yml-L6\" data-line-number=\"6\"></td><td id=\"file-docker-compose-yml-LC6\"></td></tr><tr><td id=\"file-docker-compose-yml-L7\" data-line-number=\"7\"></td><td id=\"file-docker-compose-yml-LC7\"><span>db</span>:</td></tr><tr><td id=\"file-docker-compose-yml-L8\" data-line-number=\"8\"></td><td id=\"file-docker-compose-yml-LC8\"><span>image</span>: <span>mysql:8</span></td></tr><tr><td id=\"file-docker-compose-yml-L9\" data-line-number=\"9\"></td><td id=\"file-docker-compose-yml-LC9\"><span>environment</span>:</td></tr><tr><td id=\"file-docker-compose-yml-L10\" data-line-number=\"10\"></td><td id=\"file-docker-compose-yml-LC10\"><span>MYSQL_DATABASE</span>: <span>&lt;db name&gt;</span></td></tr><tr><td id=\"file-docker-compose-yml-L11\" data-line-number=\"11\"></td><td id=\"file-docker-compose-yml-LC11\"><span>MYSQL_USER</span>: <span>&lt;db user&gt;</span></td></tr><tr><td id=\"file-docker-compose-yml-L12\" data-line-number=\"12\"></td><td id=\"file-docker-compose-yml-LC12\"><span>MYSQL_PASSWORD</span>: <span>&lt;db password&gt;</span></td></tr></tbody></table></div><p><strong>Environment ที่ใช้งาน ประกอบไปด้วย</strong></p><ul><li>Mac OS</li><li>Docker Desktop 3.3.1</li></ul><p><strong>วิธีการแก้ไขเบื้องต้น</strong></p><p>เป็นปัญหาที่แปลกดี เพราะว่า<br>การใช้ docker compose นั้น ทุก ๆ service นั้น<br>จะใช้งาน network เดียวกันอยู่แล้ว<br>น่าจะติดต่อสื่อสารกันได้สิ<br>เพราะว่าใน configuration file ก็อ้างถึงชื่อ service เลย</p><p>แต่จาก error message แล้ว แสดงว่า<br>ตัว sequlize พยายาม resolve IP ไปยัง 127.0.0.1 เสมอ<br>หรือว่าเป็นเพราะตัว sequlize เอง !!</p><p>ส่วนการแก้ไขปัญหาเฉพาะหน้าหรือง่าย ๆ คือ<br>การเพิ่ม <strong><a rel=\"noreferrer noopener\" href=\"https://docs.docker.com/compose/compose-file/compose-file-v3/#network_mode\" target=\"_blank\">network_mode ใน Docker compose file</a></strong> ไปเลย<br>ซึ่งทำการ config ได้หลายรูปแบบ ดังนี้</p><ul><li>container:&lt;container id&gt;</li><li>service:&lt;service name&gt;</li><li>bridge/host/none</li></ul><p>ส่วนที่เลือกใช้คือ service ไปเลย ดังนี้</p><div itemprop=\"text\" id=\"gist109400215\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-docker-compose1-yml-L1\" data-line-number=\"1\"></td><td id=\"file-docker-compose1-yml-LC1\"><span>version</span>: <span><span>\"</span>3.9<span>\"</span></span></td></tr><tr><td id=\"file-docker-compose1-yml-L2\" data-line-number=\"2\"></td><td id=\"file-docker-compose1-yml-LC2\"><span>services</span>:</td></tr><tr><td id=\"file-docker-compose1-yml-L3\" data-line-number=\"3\"></td><td id=\"file-docker-compose1-yml-LC3\"><span>backend</span>:</td></tr><tr><td id=\"file-docker-compose1-yml-L4\" data-line-number=\"4\"></td><td id=\"file-docker-compose1-yml-LC4\"><span>build</span>: <span>./backend</span></td></tr><tr><td id=\"file-docker-compose1-yml-L5\" data-line-number=\"5\"></td><td id=\"file-docker-compose1-yml-LC5\"><span>network_mode</span>: <span><span>\"</span>service:db<span>\"</span></span></td></tr><tr><td id=\"file-docker-compose1-yml-L6\" data-line-number=\"6\"></td><td id=\"file-docker-compose1-yml-LC6\"><span>db</span>:</td></tr><tr><td id=\"file-docker-compose1-yml-L7\" data-line-number=\"7\"></td><td id=\"file-docker-compose1-yml-LC7\"><span>...</span></td></tr></tbody></table></div><p>ทำให้สามารถทำงานต่อไปได้แล้ว</p></div><div><p><img alt=\"\" src=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=90&amp;d=mm&amp;r=g\" srcset=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=180&amp;d=mm&amp;r=g 2x\" height=\"90\" width=\"90\"></p><h4>Article by <a href=\"https://www.facebook.com/somkiatspns\">Somkiat Puisungnoen</a></h4><p>To be Craftmanship</p></div></div></article></div></div>","author":"somkiat","siteTitle":"cc :: somkiat","siteHash":"3a23a5a4389e1e40c6fbb16520a8cc20df5b3591c25145ce72aaa18b19e48201","entryHash":"7e1de8f04ee1305cb1c1729585d0b2928e50075a97dd1c411413e1ab09a33d98","category":"Thai"}