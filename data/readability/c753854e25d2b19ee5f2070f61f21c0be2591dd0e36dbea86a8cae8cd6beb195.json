{"title":"ลองเขียน Lua script ใน Redis เพื่อแก้ไขปัญหา","link":"https://www.somkiat.cc/use-lua-script-in-redis/","date":1625395660000,"content":"<div id=\"readability-page-1\" class=\"page\"><div id=\"page\"><article><div id=\"content_box\"><header></header><div><figure><img src=\"https://www.somkiat.cc/wp-content/uploads/2021/07/redis-lua.jpeg\" alt=\"\" srcset=\"https://www.somkiat.cc/wp-content/uploads/2021/07/redis-lua.jpeg 771w, https://www.somkiat.cc/wp-content/uploads/2021/07/redis-lua-300x126.jpeg 300w, https://www.somkiat.cc/wp-content/uploads/2021/07/redis-lua-768x323.jpeg 768w\" sizes=\"(max-width: 771px) 100vw, 771px\"></figure><p>ปัญหาที่พบเจอ หรือ use case ที่ต้องทำในระบบงาน เป็นดังนี้<br>ต้องการข้อมูลของ Top 10 user ที่ทำการสั่งซื้อสินค้ามากที่สุด<br>โดยการทำงานปกติมีขั้นตอนดังนี้</p><ul><li>ทำการเพิ่มข้อมูลการสั่งซื้อของผู้ใช้งาน</li><li>ทำการนับจำนวน order ของผู้ใช้งานแต่ละคนไปเรื่อย ๆ โดยใน counter</li><li>ทำการดึงข้อมูลผู้ใช้งานที่สั่งมากที่สุด 10 คน (Top 10 และ sorting)</li></ul><p><strong>จากขั้นตอนการทำงานดังกล่าว</strong><br>เมื่อไปดูระบบงานท่ีสร้างขึ้นมา<br>พบว่ามีการใช้งาน RDBMS ดังนี้</p><div itemprop=\"text\" id=\"gist110469680\" translate=\"no\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-1-sql-L1\" data-line-number=\"1\"></td><td id=\"file-1-sql-LC1\"><span><span>#</span> เพิ่มข้อมูล order</span></td></tr><tr><td id=\"file-1-sql-L2\" data-line-number=\"2\"></td><td id=\"file-1-sql-LC2\"><span>Begin</span> transaction</td></tr><tr><td id=\"file-1-sql-L3\" data-line-number=\"3\"></td><td id=\"file-1-sql-LC3\"></td></tr><tr><td id=\"file-1-sql-L4\" data-line-number=\"4\"></td><td id=\"file-1-sql-LC4\"><span>INSERT INTO</span> ORDERS ...</td></tr><tr><td id=\"file-1-sql-L5\" data-line-number=\"5\"></td><td id=\"file-1-sql-LC5\"><span>UPDATE</span> USERS <span>SET</span> order_count <span>=</span> order_count<span>+</span><span>1</span></td></tr><tr><td id=\"file-1-sql-L6\" data-line-number=\"6\"></td><td id=\"file-1-sql-LC6\"></td></tr><tr><td id=\"file-1-sql-L7\" data-line-number=\"7\"></td><td id=\"file-1-sql-LC7\"><span>Commit</span> transaction</td></tr><tr><td id=\"file-1-sql-L8\" data-line-number=\"8\"></td><td id=\"file-1-sql-LC8\"></td></tr><tr><td id=\"file-1-sql-L9\" data-line-number=\"9\"></td><td id=\"file-1-sql-LC9\"><span><span>#</span> ดึงข้อมูล Top 10</span></td></tr><tr><td id=\"file-1-sql-L10\" data-line-number=\"10\"></td><td id=\"file-1-sql-LC10\"><span>SELECT</span> ... <span>FROM</span> USERS <span>ORDER BY</span> order_count <span>DESC</span> <span>LIMIT</span> <span>10</span></td></tr></tbody></table></div><p><strong>ดูเหมือนว่าจะปกติ แต่พบว่ามีปัญหาเมื่อจำนวนคนใช้งานมากขึ้น</strong></p><p>ต้องดึงข้อมูลมากขึ้นdatabase ถูกใช้งานมากขึ้น<br>ดังนั้นจึงลองหาวิธีอื่น ๆ มาแก้ไขหน่อย<br>หนึ่งในวิธีที่ชอบใช้คือ <strong><a rel=\"noreferrer noopener\" href=\"https://redis.io/\" target=\"_blank\">Redis</a></strong> มาเก็บข้อมูล</p><p><strong>แนวคิดในการใช้งานคือ</strong></p><p>ทุกครั้งที่มีการเพิ่ม order เข้ามาของแต่ละ user<br>ต้องทำการเพิ่มจำนวนการสั่งซื้อของ user ด้วยเสมอ<br>นั่นคือ 2 operation เกิดขึ้นด้วยการเรียก Redis ครั้งเดียว<br>เพราะว่า ไม่ต้องการส่ง command มายัง redis 2 ครั้ง<br>จึงคิดว่า เขียน <strong><a rel=\"noreferrer noopener\" href=\"https://redislabs.com/ebook/part-3-next-steps/chapter-11-scripting-redis-with-lua/\" target=\"_blank\">Lua script ไปใน Redis</a></strong> กันไปเลย<br>จะช่วยให้การทำงานง่ายขึ้นมา</p><p><strong><em>โดยสามารถ Run หรือ เก็บ Lua script ใน Redis ได้เลย<br>แต่การเก็บไว้ใน Redis จะมี performance ดีกว่า</em></strong></p><p><strong>ตัวอย่างการใช้งานเป็นดังนี้</strong></p><p>Data structure ที่ใช้ใน use case นี้คือ <strong><a href=\"https://redis.io/commands#sorted_set\" target=\"_blank\" rel=\"noreferrer noopener\">Sorted Set</a></strong><br>เพื่อเก็บข้อมูลที่ไม่ซ้ำกัน รวมทั้งทำการเรียงลำดับจากมากไปน้อยให้เลยโดยที่ command ที่ใช้คือ</p><ul><li>ZADD สำหรับเพิ่มข้อมูล</li><li>ZRANGE สำหรับดึงข้อมูล</li><li>เมื่อเพิ่มข้อมูลก็ทำการ INCR เพื่อนับจำนวนไปเลย</li></ul><p>เขียน Lua script ง่าย ๆ ได้ดังนี้</p><div itemprop=\"text\" id=\"gist110469680\" translate=\"no\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-counter-lua-L1\" data-line-number=\"1\"></td><td id=\"file-counter-lua-LC1\"><span>if</span> <span>tonumber</span>(redis.<span>call</span>(<span><span>'</span>ZADD<span>'</span></span>, KEYS[<span>1</span>], ARGV[<span>1</span>], ARGV[<span>2</span>])) <span>==</span> <span>1</span> <span>then</span></td></tr><tr><td id=\"file-counter-lua-L2\" data-line-number=\"2\"></td><td id=\"file-counter-lua-LC2\"><span>return</span> redis.<span>call</span>(<span><span>'</span>INCR<span>'</span></span>, KEYS[<span>2</span>])</td></tr><tr><td id=\"file-counter-lua-L3\" data-line-number=\"3\"></td><td id=\"file-counter-lua-LC3\"><span>else</span></td></tr><tr><td id=\"file-counter-lua-L4\" data-line-number=\"4\"></td><td id=\"file-counter-lua-LC4\"><span>return</span> redis.<span>call</span>(<span><span>'</span>GET<span>'</span></span>, KEYS[<span>2</span>])</td></tr><tr><td id=\"file-counter-lua-L5\" data-line-number=\"5\"></td><td id=\"file-counter-lua-LC5\"><span>end</span></td></tr></tbody></table></div><p><strong>คำอธิบาย</strong></p><ul><li>ทำการส่ง 2 มา 2 key ประกอบไปด้วย ข้อมูลของ order และ counter ของแต่ละ user</li><li>ถ้าเพิ่ม order ใหม่เข้ามา จะทำการเพิ่มข้อมูลด้วย ZADD และเพิ่มข้อมูลจำนวน order ด้วย INCR</li></ul><p><strong>ลองใช้งานผ่าน docker นิดหน่อย</strong></p><div itemprop=\"text\" id=\"gist110469680\" translate=\"no\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-1-txt-L1\" data-line-number=\"1\"></td><td id=\"file-1-txt-LC1\"># Start Redis server</td></tr><tr><td id=\"file-1-txt-L2\" data-line-number=\"2\"></td><td id=\"file-1-txt-LC2\">$docker container run -d --name redis redis</td></tr><tr><td id=\"file-1-txt-L3\" data-line-number=\"3\"></td><td id=\"file-1-txt-LC3\">$docker container exec -it redis redis-cli</td></tr><tr><td id=\"file-1-txt-L4\" data-line-number=\"4\"></td><td id=\"file-1-txt-LC4\"></td></tr><tr><td id=\"file-1-txt-L5\" data-line-number=\"5\"></td><td id=\"file-1-txt-LC5\"># Store lua script into Redis</td></tr><tr><td id=\"file-1-txt-L6\" data-line-number=\"6\"></td><td id=\"file-1-txt-LC6\">127.0.0.1:6379&gt;SCRIPT LOAD \"if tonumber(redis.call('ZADD', KEYS[1], ARGV[1], ARGV[2])) == 1 then return redis.call('INCR', KEYS[2]) else return redis.call('GET', KEYS[2]) end\"</td></tr><tr><td id=\"file-1-txt-L7\" data-line-number=\"7\"></td><td id=\"file-1-txt-LC7\">\"fdc6c979951ed9e8402cb397493bdf4f96aa95ca\"</td></tr><tr><td id=\"file-1-txt-L8\" data-line-number=\"8\"></td><td id=\"file-1-txt-LC8\"></td></tr><tr><td id=\"file-1-txt-L9\" data-line-number=\"9\"></td><td id=\"file-1-txt-LC9\"># Testing</td></tr><tr><td id=\"file-1-txt-L10\" data-line-number=\"10\"></td><td id=\"file-1-txt-LC10\">127.0.0.1:6379&gt;EVALSHA \"fdc6c979951ed9e8402cb397493bdf4f96aa95ca\" 2 {User:1}:OrderByTime {User:1}:OrderCount 100 \"{ OrderId: 100}\"</td></tr><tr><td id=\"file-1-txt-L11\" data-line-number=\"11\"></td><td id=\"file-1-txt-LC11\">127.0.0.1:6379&gt;EVALSHA \"fdc6c979951ed9e8402cb397493bdf4f96aa95ca\" 2 {User:1}:OrderByTime {User:1}:OrderCount 101 \"{ OrderId: 101}\"</td></tr><tr><td id=\"file-1-txt-L12\" data-line-number=\"12\"></td><td id=\"file-1-txt-LC12\"></td></tr><tr><td id=\"file-1-txt-L13\" data-line-number=\"13\"></td><td id=\"file-1-txt-LC13\">127.0.0.1:6379&gt;KEYS *</td></tr><tr><td id=\"file-1-txt-L14\" data-line-number=\"14\"></td><td id=\"file-1-txt-LC14\">1) \"{User:1}:OrderByTime\"</td></tr><tr><td id=\"file-1-txt-L15\" data-line-number=\"15\"></td><td id=\"file-1-txt-LC15\">2) \"{User:1}:OrderCount\"</td></tr><tr><td id=\"file-1-txt-L16\" data-line-number=\"16\"></td><td id=\"file-1-txt-LC16\"></td></tr><tr><td id=\"file-1-txt-L17\" data-line-number=\"17\"></td><td id=\"file-1-txt-LC17\">127.0.0.1:6379&gt;GET {User:1}:OrderCount</td></tr><tr><td id=\"file-1-txt-L18\" data-line-number=\"18\"></td><td id=\"file-1-txt-LC18\">2</td></tr></tbody></table></div><p>เพียงเท่านี้ก็สามารถจัดการปัญหาด้วย Redis ได้แล้ว<br>ได้ลองเขียน Lua script เพิ่มด้วย สนุกดี</p></div><div><p><img alt=\"\" src=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=90&amp;d=mm&amp;r=g\" srcset=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=180&amp;d=mm&amp;r=g 2x\" height=\"90\" width=\"90\"></p><h4>Article by <a href=\"https://www.facebook.com/somkiatspns\">Somkiat Puisungnoen</a></h4><p>To be Craftmanship</p></div></div></article></div></div>","author":"somkiat","siteTitle":"cc :: somkiat","siteHash":"3a23a5a4389e1e40c6fbb16520a8cc20df5b3591c25145ce72aaa18b19e48201","entryHash":"c753854e25d2b19ee5f2070f61f21c0be2591dd0e36dbea86a8cae8cd6beb195","category":"Thai"}