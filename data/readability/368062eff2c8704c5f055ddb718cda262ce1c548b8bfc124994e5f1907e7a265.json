{"title":"ว่าด้วยเรื่อง ID ของ document ใน ElasticSearch","link":"https://www.somkiat.cc/id-in-elasticsearch/","date":1624376729000,"content":"<div id=\"readability-page-1\" class=\"page\"><div id=\"page\"><article><div id=\"content_box\"><header></header><div><figure><img src=\"https://www.somkiat.cc/wp-content/uploads/2021/06/elasticsearch.jpg\" alt=\"\" width=\"560\" height=\"295\" srcset=\"https://www.somkiat.cc/wp-content/uploads/2021/06/elasticsearch.jpg 820w, https://www.somkiat.cc/wp-content/uploads/2021/06/elasticsearch-300x159.jpg 300w, https://www.somkiat.cc/wp-content/uploads/2021/06/elasticsearch-768x406.jpg 768w\" sizes=\"(max-width: 560px) 100vw, 560px\"></figure><p>วันนี้เจอปัญหาเรื่อง _id field ของ document ใน ElasticSearch<br>พบว่าในการย้ายเอกสารจาก version ที่ต่ำกว่า 5.0 มายัง version เกิน 5.0<br>อาจจะทำการ dump หรือ reindex ก็ได้<br>จะเจอ error ที่น่าสนใจคือ <strong><em>“id is too long, must be no longer than 512 bytes but was: 513”</em></strong></p><p>คำถามคือ มีสาเหตุมาจากอะไร ?<br>เมื่อไปดูเอกสารใน <strong><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-id-field.html\">Elasticsearch :: _id field</a></strong><br>ก็บอกไว้ว่า ความยาวของ _id ต้องไปเกิน 512 bytes<br>ดังนั้นถ้ายาวเกิน 512 จะถูก reject</p><p>เมื่อไปดูใน <strong><a href=\"https://github.com/elastic/elasticsearch/blob/68c33dc7137bc303664b4322dbb63be649b30782/server/src/main/java/org/elasticsearch/action/index/IndexRequest.java#L209\">source code</a></strong> ก็พบว่าทำการ hard code ไว้เลย</p><div itemprop=\"text\" id=\"gist110244010\" translate=\"no\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-1-java-L1\" data-line-number=\"1\"></td><td id=\"file-1-java-LC1\"><span>if</span> (id <span>!=</span> <span>null</span> <span>&amp;&amp;</span> id<span>.</span>getBytes(<span>StandardCharsets</span><span><span>.</span>UTF_8</span>)<span>.</span>length <span>&gt;</span> <span>512</span>) {</td></tr><tr><td id=\"file-1-java-L2\" data-line-number=\"2\"></td><td id=\"file-1-java-LC2\">validationException <span>=</span> addValidationError(<span><span>\"</span>id [<span>\"</span></span> <span>+</span> id <span>+</span> <span><span>\"</span>] is too long, must be no longer than 512 bytes but was: <span>\"</span></span> <span>+</span></td></tr><tr><td id=\"file-1-java-L3\" data-line-number=\"3\"></td><td id=\"file-1-java-LC3\">id<span>.</span>getBytes(<span>StandardCharsets</span><span><span>.</span>UTF_8</span>)<span>.</span>length, validationException);</td></tr><tr><td id=\"file-1-java-L4\" data-line-number=\"4\"></td><td id=\"file-1-java-LC4\">}</td></tr></tbody></table></div><p><strong>คำถามคือ จะแก้ไขปัญหานี้อย่างไร ?</strong></p><p>การแก้ไขไม่ยากคือ การลบ _id ทิ้ง หรือ ทำการ กำหนด _id ให้เป็น null ก่อน<br>จากนั้นจึงทำการ dump หรือ reindex นั้นเอง<br>ยกตัวอย่างการเขียน <strong><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/master/modules-scripting-painless.html\" target=\"_blank\" rel=\"noreferrer noopener\">painless script</a></strong> ได้เลย</p><div itemprop=\"text\" id=\"gist110244010\" translate=\"no\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-1-txt-L1\" data-line-number=\"1\"></td><td id=\"file-1-txt-LC1\">\"script\": {</td></tr><tr><td id=\"file-1-txt-L2\" data-line-number=\"2\"></td><td id=\"file-1-txt-LC2\">\"source\": \"if (ctx._id.length() &gt; 512) {ctx._id = 'null'}\",</td></tr><tr><td id=\"file-1-txt-L3\" data-line-number=\"3\"></td><td id=\"file-1-txt-LC3\">\"lang\": \"painless\"</td></tr><tr><td id=\"file-1-txt-L4\" data-line-number=\"4\"></td><td id=\"file-1-txt-LC4\">}</td></tr></tbody></table></div><p><strong>Reference Websites</strong></p><p><a href=\"https://www.joshmlwood.com/elasticsearch-ids-are-hard/\" target=\"_blank\" rel=\"noreferrer noopener\">https://www.joshmlwood.com/elasticsearch-ids-are-hard/</a><br><a href=\"https://discuss.elastic.co/t/reindexing-failed-validation-failed-1-id-is-too-long-must-be-no-longer-than-512-bytes-but-was-672/185650/4\" target=\"_blank\" rel=\"noreferrer noopener\">https://discuss.elastic.co/t/reindexing-failed-validation-failed-1-id-is-too-long-must-be-no-longer-than-512-bytes-but-was-672/185650/4</a></p></div><div><p><img alt=\"\" src=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=90&amp;d=mm&amp;r=g\" srcset=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=180&amp;d=mm&amp;r=g 2x\" height=\"90\" width=\"90\"></p><h4>Article by <a href=\"https://www.facebook.com/somkiatspns\">Somkiat Puisungnoen</a></h4><p>To be Craftmanship</p></div></div></article></div></div>","author":"somkiat","siteTitle":"cc :: somkiat","siteHash":"3a23a5a4389e1e40c6fbb16520a8cc20df5b3591c25145ce72aaa18b19e48201","entryHash":"368062eff2c8704c5f055ddb718cda262ce1c548b8bfc124994e5f1907e7a265","category":"Thai"}