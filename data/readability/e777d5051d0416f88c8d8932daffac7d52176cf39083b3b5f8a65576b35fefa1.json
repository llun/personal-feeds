{"title":"วิธีแก้ไขปัญหา ความช้าใน request แรกของระบบที่พัฒนาด้วย .Net","link":"https://www.somkiat.cc/dotnet-slow-in-first-request/","date":1619528858000,"content":"<div id=\"readability-page-1\" class=\"page\"><div id=\"page\"><article><div id=\"content_box\"><header><div><p><time>April 27, 2021</time> <span><a href=\"https://www.somkiat.cc/category/programming/\" rel=\"category tag\">Programming</a></span></p></div></header><div><figure><img src=\"https://www.somkiat.cc/wp-content/uploads/2021/04/dotnet-5.jpeg\" alt=\"\" width=\"550\" height=\"303\" srcset=\"https://www.somkiat.cc/wp-content/uploads/2021/04/dotnet-5.jpeg 900w, https://www.somkiat.cc/wp-content/uploads/2021/04/dotnet-5-300x166.jpeg 300w, https://www.somkiat.cc/wp-content/uploads/2021/04/dotnet-5-768x425.jpeg 768w\" sizes=\"(max-width: 550px) 100vw, 550px\"></figure><p><strong>ปัญหาที่เจอ</strong><br>ในระบบ Web หรือ API ที่พัฒนาด้วย .Net + C# นั้น<br>พบว่าเมื่อเราทำการ start server ขึ้นมาแล้ว<br>request แรกที่เข้ามาจะช้ามาก ๆ<br>เมื่อเทียบกับ request ต่อ ๆ มา<br>จะแก้ไขอย่างไรดี ?</p><p><strong>ตัวอย่างของปัญหา ซึ่งความเร็วต่างกันมาก ๆ</strong></p><p>เป็น code ที่ถูกสร้างมาจาก default project<br>เพื่อทำการ reproduce ปัญหา ดังนี้</p><div itemprop=\"text\" id=\"gist109217457\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-1-txt-L1\" data-line-number=\"1\"></td><td id=\"file-1-txt-LC1\">$curl -o /dev/null -s -w %{time_total}\\\\n https://localhost:5001</td></tr><tr><td id=\"file-1-txt-L2\" data-line-number=\"2\"></td><td id=\"file-1-txt-LC2\">0.470427</td></tr><tr><td id=\"file-1-txt-L3\" data-line-number=\"3\"></td><td id=\"file-1-txt-LC3\"></td></tr><tr><td id=\"file-1-txt-L4\" data-line-number=\"4\"></td><td id=\"file-1-txt-LC4\">$curl -o /dev/null -s -w %{time_total}\\\\n https://localhost:5001</td></tr><tr><td id=\"file-1-txt-L5\" data-line-number=\"5\"></td><td id=\"file-1-txt-LC5\">0.034931</td></tr><tr><td id=\"file-1-txt-L6\" data-line-number=\"6\"></td><td id=\"file-1-txt-LC6\"></td></tr><tr><td id=\"file-1-txt-L7\" data-line-number=\"7\"></td><td id=\"file-1-txt-LC7\">$curl -o /dev/null -s -w %{time_total}\\\\n https://localhost:5001</td></tr><tr><td id=\"file-1-txt-L8\" data-line-number=\"8\"></td><td id=\"file-1-txt-LC8\">0.037043</td></tr></tbody></table></div><p><strong>วิธีการแก้ไขปัญหามีอะไรบ้าง ?</strong></p><p>ลองคิดกันดูครับ ก่อนดูในบรรทัดต่อไป …</p><p><strong>จากที่คิดคือ ถ้าง่ายสุด ๆ ก็ทำการยิง request แรกก่อนเลย</strong></p><p>ซึ่งเป็นการยิงจากระบบของเราเองในขั้นตอนสุดท้าย<br>หลังจากการ deployก่อนที่จะเปิดให้ใช้งาน<br>ผมคิดว่า น่าจะเป็น workaround มากกว่านะ<br>แต่ก็ง่ายที่สุดแล้ว !!</p><p><strong>การทำก็ง่าย ๆ คือ สร้าง endpoint ขึ้นมา</strong></p><p>เพื่อใช้สำหรับตรวจสอบความพร้อมของ Web หรือ API<br>หรือจะเรียกว่า Health Check แบบ readiness นั่นเอง<br>จากนั้นถ้าใช้พวก Docker หรือ Kubernetes ก็สามารถนำไปใส่ได้</p><ul><li>Docker ใช้&nbsp; <a href=\"https://docs.docker.com/engine/reference/builder/\" target=\"_blank\" rel=\"noreferrer noopener\">Health check</a></li><li>Kubernetes ใช้งาน <a href=\"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/\" target=\"_blank\" rel=\"noreferrer noopener\">ReadinessProbe</a></li></ul><p>แน่นอนว่า จะทำการส่ง request ไปยัง endpoint ก่อนเลย<br>เท่านี้ก็จบแล้ว</p><p><strong><em>แต่ถ้าไม่ได้ใช้ Docker หรือ Kubernetes ละ ทำอย่างไร ?</em></strong></p><p><strong>ลองทำการ warmup หรือเรียก endpoint ที่กำหนดไว้เองเลย</strong></p><p>โดยทำการสร้าง class ที่ implements <strong>IHostedService</strong> มา<br>จากนั้นทำการเรียก endpoint หลังจากที่ server ทำการ start เรียบร้อยแล้ว<br>ด้วยการใช้งาน HTTPClient นั่นเอง<br>ซึ่งวิธีการนี้ก็ง่ายดี<br>แต่ต้องเข้าในลำดับของการ start server นิดหน่อย</p><p><strong>มาดู code ง่าย ๆ กัน</strong><br>สร้าง Warmup service สำหรับส่ง request ไปยัง Endpoint URL ที่ต้องการ</p><div itemprop=\"text\" id=\"gist109217457\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-warmupservices-cs-L1\" data-line-number=\"1\"></td><td id=\"file-warmupservices-cs-LC1\"><span>public</span> <span>class</span> <span>WarmupServices</span> : <span>IHostedService</span>, <span>IDisposable</span></td></tr><tr><td id=\"file-warmupservices-cs-L2\" data-line-number=\"2\"></td><td id=\"file-warmupservices-cs-LC2\">{</td></tr><tr><td id=\"file-warmupservices-cs-L3\" data-line-number=\"3\"></td><td id=\"file-warmupservices-cs-LC3\"><span>private</span> <span>readonly</span> <span>ILogger</span> <span>_logger</span>;</td></tr><tr><td id=\"file-warmupservices-cs-L4\" data-line-number=\"4\"></td><td id=\"file-warmupservices-cs-LC4\"><span>private</span> <span>readonly</span> <span>HttpClient</span> <span>httpClient</span>;</td></tr><tr><td id=\"file-warmupservices-cs-L5\" data-line-number=\"5\"></td><td id=\"file-warmupservices-cs-LC5\"></td></tr><tr><td id=\"file-warmupservices-cs-L6\" data-line-number=\"6\"></td><td id=\"file-warmupservices-cs-LC6\"><span>public</span> <span>WarmupServices</span>(<span>ILogger</span>&lt;<span>WarmupServices</span>&gt; <span>logger</span>)</td></tr><tr><td id=\"file-warmupservices-cs-L7\" data-line-number=\"7\"></td><td id=\"file-warmupservices-cs-LC7\">{</td></tr><tr><td id=\"file-warmupservices-cs-L8\" data-line-number=\"8\"></td><td id=\"file-warmupservices-cs-LC8\"><span>_logger</span> <span>=</span> <span>logger</span>;</td></tr><tr><td id=\"file-warmupservices-cs-L9\" data-line-number=\"9\"></td><td id=\"file-warmupservices-cs-LC9\"><span>httpClient</span> <span>=</span> <span>new</span> <span>HttpClient</span>();</td></tr><tr><td id=\"file-warmupservices-cs-L10\" data-line-number=\"10\"></td><td id=\"file-warmupservices-cs-LC10\">}</td></tr><tr><td id=\"file-warmupservices-cs-L11\" data-line-number=\"11\"></td><td id=\"file-warmupservices-cs-LC11\"></td></tr><tr><td id=\"file-warmupservices-cs-L12\" data-line-number=\"12\"></td><td id=\"file-warmupservices-cs-LC12\"><span>public</span> <span>Task</span> <span>StartAsync</span>(<span>CancellationToken</span> <span>cancellationToken</span>)</td></tr><tr><td id=\"file-warmupservices-cs-L13\" data-line-number=\"13\"></td><td id=\"file-warmupservices-cs-LC13\">{</td></tr><tr><td id=\"file-warmupservices-cs-L14\" data-line-number=\"14\"></td><td id=\"file-warmupservices-cs-LC14\"><span>_logger</span>.<span>LogInformation</span>(<span><span>\"</span>Starting IHostedService...<span>\"</span></span>);</td></tr><tr><td id=\"file-warmupservices-cs-L15\" data-line-number=\"15\"></td><td id=\"file-warmupservices-cs-LC15\"></td></tr><tr><td id=\"file-warmupservices-cs-L16\" data-line-number=\"16\"></td><td id=\"file-warmupservices-cs-LC16\"><span>httpClient</span>.<span>GetAsync</span>(<span><span>\"</span>&lt;Endpoint URL&gt;<span>\"</span></span>);</td></tr><tr><td id=\"file-warmupservices-cs-L17\" data-line-number=\"17\"></td><td id=\"file-warmupservices-cs-LC17\"></td></tr><tr><td id=\"file-warmupservices-cs-L18\" data-line-number=\"18\"></td><td id=\"file-warmupservices-cs-LC18\"><span>return</span> <span>Task</span>.<span>CompletedTask</span>;</td></tr><tr><td id=\"file-warmupservices-cs-L19\" data-line-number=\"19\"></td><td id=\"file-warmupservices-cs-LC19\">}</td></tr><tr><td id=\"file-warmupservices-cs-L20\" data-line-number=\"20\"></td><td id=\"file-warmupservices-cs-LC20\"></td></tr><tr><td id=\"file-warmupservices-cs-L21\" data-line-number=\"21\"></td><td id=\"file-warmupservices-cs-LC21\"><span>public</span> <span>Task</span> <span>StopAsync</span>(<span>CancellationToken</span> <span>cancellationToken</span>)</td></tr><tr><td id=\"file-warmupservices-cs-L22\" data-line-number=\"22\"></td><td id=\"file-warmupservices-cs-LC22\">{</td></tr><tr><td id=\"file-warmupservices-cs-L23\" data-line-number=\"23\"></td><td id=\"file-warmupservices-cs-LC23\"><span>_logger</span>.<span>LogInformation</span>(<span><span>\"</span>StoppingIHostedService...<span>\"</span></span>);</td></tr><tr><td id=\"file-warmupservices-cs-L24\" data-line-number=\"24\"></td><td id=\"file-warmupservices-cs-LC24\"><span>return</span> <span>Task</span>.<span>CompletedTask</span>;</td></tr><tr><td id=\"file-warmupservices-cs-L25\" data-line-number=\"25\"></td><td id=\"file-warmupservices-cs-LC25\">}</td></tr><tr><td id=\"file-warmupservices-cs-L26\" data-line-number=\"26\"></td><td id=\"file-warmupservices-cs-LC26\"></td></tr><tr><td id=\"file-warmupservices-cs-L27\" data-line-number=\"27\"></td><td id=\"file-warmupservices-cs-LC27\"><span>public</span> <span>void</span> <span>Dispose</span>()</td></tr><tr><td id=\"file-warmupservices-cs-L28\" data-line-number=\"28\"></td><td id=\"file-warmupservices-cs-LC28\">{</td></tr><tr><td id=\"file-warmupservices-cs-L29\" data-line-number=\"29\"></td><td id=\"file-warmupservices-cs-LC29\"><span>httpClient</span><span>?</span>.<span>Dispose</span>();</td></tr><tr><td id=\"file-warmupservices-cs-L30\" data-line-number=\"30\"></td><td id=\"file-warmupservices-cs-LC30\">}</td></tr><tr><td id=\"file-warmupservices-cs-L31\" data-line-number=\"31\"></td><td id=\"file-warmupservices-cs-LC31\">}</td></tr></tbody></table></div><p><strong>ทำการ start service หลังจากที่ server start เสร็จแล้ว</strong></p><div itemprop=\"text\" id=\"gist109217457\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-program-cs-L1\" data-line-number=\"1\"></td><td id=\"file-program-cs-LC1\"><span>public</span> <span>class</span> <span>Program</span></td></tr><tr><td id=\"file-program-cs-L2\" data-line-number=\"2\"></td><td id=\"file-program-cs-LC2\">{</td></tr><tr><td id=\"file-program-cs-L3\" data-line-number=\"3\"></td><td id=\"file-program-cs-LC3\"><span>public</span> <span>static</span> <span>void</span> <span>Main</span>(<span>string</span>[] <span>args</span>)</td></tr><tr><td id=\"file-program-cs-L4\" data-line-number=\"4\"></td><td id=\"file-program-cs-LC4\">{</td></tr><tr><td id=\"file-program-cs-L5\" data-line-number=\"5\"></td><td id=\"file-program-cs-LC5\"><span>CreateHostBuilder</span>(<span>args</span>).<span>Build</span>().<span>Run</span>();</td></tr><tr><td id=\"file-program-cs-L6\" data-line-number=\"6\"></td><td id=\"file-program-cs-LC6\">}</td></tr><tr><td id=\"file-program-cs-L7\" data-line-number=\"7\"></td><td id=\"file-program-cs-LC7\"></td></tr><tr><td id=\"file-program-cs-L8\" data-line-number=\"8\"></td><td id=\"file-program-cs-LC8\"><span>public</span> <span>static</span> <span>IHostBuilder</span> <span>CreateHostBuilder</span>(<span>string</span>[] <span>args</span>) <span>=&gt;</span></td></tr><tr><td id=\"file-program-cs-L9\" data-line-number=\"9\"></td><td id=\"file-program-cs-LC9\"><span>Host</span>.<span>CreateDefaultBuilder</span>(<span>args</span>)</td></tr><tr><td id=\"file-program-cs-L10\" data-line-number=\"10\"></td><td id=\"file-program-cs-LC10\">.<span>ConfigureWebHostDefaults</span>(<span>webBuilder</span> <span>=&gt;</span></td></tr><tr><td id=\"file-program-cs-L11\" data-line-number=\"11\"></td><td id=\"file-program-cs-LC11\">{</td></tr><tr><td id=\"file-program-cs-L12\" data-line-number=\"12\"></td><td id=\"file-program-cs-LC12\"><span>webBuilder</span>.<span>UseStartup</span>&lt;<span>Startup</span>&gt;();</td></tr><tr><td id=\"file-program-cs-L13\" data-line-number=\"13\"></td><td id=\"file-program-cs-LC13\">})</td></tr><tr><td id=\"file-program-cs-L14\" data-line-number=\"14\"></td><td id=\"file-program-cs-LC14\">.<span>ConfigureServices</span>(</td></tr><tr><td id=\"file-program-cs-L15\" data-line-number=\"15\"></td><td id=\"file-program-cs-LC15\"><span>services</span> <span>=&gt;</span> <span>services</span>.<span>AddHostedService</span>&lt;<span>WarmupServices</span>&gt;());</td></tr><tr><td id=\"file-program-cs-L16\" data-line-number=\"16\"></td><td id=\"file-program-cs-LC16\"></td></tr><tr><td id=\"file-program-cs-L17\" data-line-number=\"17\"></td><td id=\"file-program-cs-LC17\">}</td></tr></tbody></table></div><p><strong>ผลการทดสอบเป็นดังนี้</strong></p><div itemprop=\"text\" id=\"gist109217457\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-2-txt-L1\" data-line-number=\"1\"></td><td id=\"file-2-txt-LC1\"># Start server</td></tr><tr><td id=\"file-2-txt-L2\" data-line-number=\"2\"></td><td id=\"file-2-txt-LC2\"></td></tr><tr><td id=\"file-2-txt-L3\" data-line-number=\"3\"></td><td id=\"file-2-txt-LC3\">$dotnet dist/test.dll</td></tr><tr><td id=\"file-2-txt-L4\" data-line-number=\"4\"></td><td id=\"file-2-txt-LC4\">info: Microsoft.Hosting.Lifetime[0]</td></tr><tr><td id=\"file-2-txt-L5\" data-line-number=\"5\"></td><td id=\"file-2-txt-LC5\">Now listening on: http://localhost:5000</td></tr><tr><td id=\"file-2-txt-L6\" data-line-number=\"6\"></td><td id=\"file-2-txt-LC6\">info: Microsoft.Hosting.Lifetime[0]</td></tr><tr><td id=\"file-2-txt-L7\" data-line-number=\"7\"></td><td id=\"file-2-txt-LC7\">Now listening on: https://localhost:5001</td></tr><tr><td id=\"file-2-txt-L8\" data-line-number=\"8\"></td><td id=\"file-2-txt-LC8\"></td></tr><tr><td id=\"file-2-txt-L9\" data-line-number=\"9\"></td><td id=\"file-2-txt-LC9\">info: Application.WarmupServices[0]</td></tr><tr><td id=\"file-2-txt-L10\" data-line-number=\"10\"></td><td id=\"file-2-txt-LC10\">Starting IHostedService...</td></tr><tr><td id=\"file-2-txt-L11\" data-line-number=\"11\"></td><td id=\"file-2-txt-LC11\"></td></tr><tr><td id=\"file-2-txt-L12\" data-line-number=\"12\"></td><td id=\"file-2-txt-LC12\">info: Microsoft.Hosting.Lifetime[0]</td></tr><tr><td id=\"file-2-txt-L13\" data-line-number=\"13\"></td><td id=\"file-2-txt-LC13\">Application started. Press Ctrl+C to shut down.</td></tr><tr><td id=\"file-2-txt-L14\" data-line-number=\"14\"></td><td id=\"file-2-txt-LC14\">info: Microsoft.Hosting.Lifetime[0]</td></tr><tr><td id=\"file-2-txt-L15\" data-line-number=\"15\"></td><td id=\"file-2-txt-LC15\">Hosting environment: Production</td></tr><tr><td id=\"file-2-txt-L16\" data-line-number=\"16\"></td><td id=\"file-2-txt-LC16\">info: Microsoft.Hosting.Lifetime[0]</td></tr><tr><td id=\"file-2-txt-L17\" data-line-number=\"17\"></td><td id=\"file-2-txt-LC17\"></td></tr><tr><td id=\"file-2-txt-L18\" data-line-number=\"18\"></td><td id=\"file-2-txt-LC18\"># Result</td></tr><tr><td id=\"file-2-txt-L19\" data-line-number=\"19\"></td><td id=\"file-2-txt-LC19\"></td></tr><tr><td id=\"file-2-txt-L20\" data-line-number=\"20\"></td><td id=\"file-2-txt-LC20\">$curl -o /dev/null -s -w %{time_total}\\\\n https://localhost:5001</td></tr><tr><td id=\"file-2-txt-L21\" data-line-number=\"21\"></td><td id=\"file-2-txt-LC21\">0.040194</td></tr><tr><td id=\"file-2-txt-L22\" data-line-number=\"22\"></td><td id=\"file-2-txt-LC22\"></td></tr><tr><td id=\"file-2-txt-L23\" data-line-number=\"23\"></td><td id=\"file-2-txt-LC23\">$curl -o /dev/null -s -w %{time_total}\\\\n https://localhost:5001</td></tr><tr><td id=\"file-2-txt-L24\" data-line-number=\"24\"></td><td id=\"file-2-txt-LC24\">0.035138</td></tr><tr><td id=\"file-2-txt-L25\" data-line-number=\"25\"></td><td id=\"file-2-txt-LC25\"></td></tr><tr><td id=\"file-2-txt-L26\" data-line-number=\"26\"></td><td id=\"file-2-txt-LC26\">$curl -o /dev/null -s -w %{time_total}\\\\n https://localhost:5001</td></tr><tr><td id=\"file-2-txt-L27\" data-line-number=\"27\"></td><td id=\"file-2-txt-LC27\">0.028956</td></tr></tbody></table></div><p><strong>รวม ๆ แล้วคือการกระตุ้นการทำงานของ request แรกนั่นเอง</strong></p><p>ก็น่าจะช่วยให้แก้ไขปัญหาที่พบเจอได้เช่นกัน<br>ตามจริงเราสามารถ initial service ต่าง ๆ<br>ทั้ง singleton และ non-singleton ได้อีกนะ<br>หรือถ้ายิง Endpoint ที่ต้องการหรือทั้งหมดก็ได้<br>แต่คิดว่า น่าจะซับซ้อนเกินไปหน่อย</p><p>อาจจะเขียน script สำหรับการ start service อีกก็ได้<br>ซึ่งทั้งหมดนี้ น่าจะเป็นเพียง workaround เท่านั้น</p></div><div><p><img alt=\"\" src=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=90&amp;d=mm&amp;r=g\" srcset=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=180&amp;d=mm&amp;r=g 2x\" height=\"90\" width=\"90\"></p><h4>Article by <a href=\"https://www.facebook.com/somkiatspns\">Somkiat Puisungnoen</a></h4><p>To be Craftmanship</p></div></div></article></div></div>","author":"somkiat","siteTitle":"cc :: somkiat","siteHash":"3a23a5a4389e1e40c6fbb16520a8cc20df5b3591c25145ce72aaa18b19e48201","entryHash":"e777d5051d0416f88c8d8932daffac7d52176cf39083b3b5f8a65576b35fefa1","category":"Thai"}