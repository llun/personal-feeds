{"title":"สิ่งที่เปลี่ยนแปลงใน Golang 1.16 กับ Docker","link":"https://www.somkiat.cc/docker-with-golang-1-16/","date":1615958679000,"content":"<div id=\"readability-page-1\" class=\"page\"><div id=\"page\"><article><div id=\"content_box\"><header><div><p><time>March 17, 2021</time> <span><a href=\"https://www.somkiat.cc/category/dev-ops/\" rel=\"category tag\">dev-ops</a>, <a href=\"https://www.somkiat.cc/category/tools/\" rel=\"category tag\">Tools</a></span></p></div></header><div><figure><img src=\"https://www.somkiat.cc/wp-content/uploads/2021/03/golang-docker-1024x568.jpg\" alt=\"\" width=\"571\" height=\"316\" srcset=\"https://www.somkiat.cc/wp-content/uploads/2021/03/golang-docker-1024x568.jpg 1024w, https://www.somkiat.cc/wp-content/uploads/2021/03/golang-docker-300x166.jpg 300w, https://www.somkiat.cc/wp-content/uploads/2021/03/golang-docker-768x426.jpg 768w, https://www.somkiat.cc/wp-content/uploads/2021/03/golang-docker.jpg 1280w\" sizes=\"(max-width: 571px) 100vw, 571px\"></figure><p>วันนี้ลองเปลี่ยน Docker Image ของ Golang เป็น version 1.16<br>พบว่าจะทำการ build ไม่ผ่านนะ<br>เนื่องจาก Golang 1.16 นั้นใช้ Go Module เป็นค่า default แล้ว<br>ดังนั้นจึงแก้ไขขั้นตอนการสร้าง Docker Image ใหม่ดังนี้</p><p>ก่อนอื่น project ต้องเป็น Go Module<br>ด้วยการใช้คำสั่ง $go mod init &lt;name&gt;</p><p><strong>ส่วนใน Dockerfile เพิ่มส่วนของ $go mod tidy ไปด้วย</strong></p><div itemprop=\"text\" id=\"gist108497988\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-dockerfile-L1\" data-line-number=\"1\"></td><td id=\"file-dockerfile-LC1\"><span>FROM</span> golang:1.16.2-stretch AS builder</td></tr><tr><td id=\"file-dockerfile-L2\" data-line-number=\"2\"></td><td id=\"file-dockerfile-LC2\"><span>WORKDIR</span> /src</td></tr><tr><td id=\"file-dockerfile-L3\" data-line-number=\"3\"></td><td id=\"file-dockerfile-LC3\"><span>COPY</span> . .</td></tr><tr><td id=\"file-dockerfile-L4\" data-line-number=\"4\"></td><td id=\"file-dockerfile-LC4\"><span>RUN</span> go mod tidy</td></tr><tr><td id=\"file-dockerfile-L5\" data-line-number=\"5\"></td><td id=\"file-dockerfile-LC5\"><span>RUN</span> CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main .</td></tr><tr><td id=\"file-dockerfile-L6\" data-line-number=\"6\"></td><td id=\"file-dockerfile-LC6\"></td></tr><tr><td id=\"file-dockerfile-L7\" data-line-number=\"7\"></td><td id=\"file-dockerfile-LC7\"><span>FROM</span> alpine:latest</td></tr><tr><td id=\"file-dockerfile-L8\" data-line-number=\"8\"></td><td id=\"file-dockerfile-LC8\"><span>RUN</span> apk --no-cache add ca-certificates</td></tr><tr><td id=\"file-dockerfile-L9\" data-line-number=\"9\"></td><td id=\"file-dockerfile-LC9\"><span>WORKDIR</span> /root/</td></tr><tr><td id=\"file-dockerfile-L10\" data-line-number=\"10\"></td><td id=\"file-dockerfile-LC10\"><span>COPY</span> --from=builder /src/main .</td></tr><tr><td id=\"file-dockerfile-L11\" data-line-number=\"11\"></td><td id=\"file-dockerfile-LC11\"><span>CMD</span> [<span>\"./main\"</span>]</td></tr></tbody></table></div><p><strong>เพิ่งสังเกตว่า Docker version ใหม่เปลี่ยน log การ build ดังนี้</strong></p><div itemprop=\"text\" id=\"gist108497988\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-1-txt-L1\" data-line-number=\"1\"></td><td id=\"file-1-txt-LC1\">$docker image build -t demo .</td></tr><tr><td id=\"file-1-txt-L2\" data-line-number=\"2\"></td><td id=\"file-1-txt-LC2\"></td></tr><tr><td id=\"file-1-txt-L3\" data-line-number=\"3\"></td><td id=\"file-1-txt-LC3\">[+] Building 5.0s (16/16) FINISHED</td></tr><tr><td id=\"file-1-txt-L4\" data-line-number=\"4\"></td><td id=\"file-1-txt-LC4\">=&gt; [internal] load build definition from Dockerfile 0.0s</td></tr><tr><td id=\"file-1-txt-L5\" data-line-number=\"5\"></td><td id=\"file-1-txt-LC5\">=&gt; =&gt; transferring dockerfile: 37B 0.0s</td></tr><tr><td id=\"file-1-txt-L6\" data-line-number=\"6\"></td><td id=\"file-1-txt-LC6\">=&gt; [internal] load .dockerignore 0.0s</td></tr><tr><td id=\"file-1-txt-L7\" data-line-number=\"7\"></td><td id=\"file-1-txt-LC7\">=&gt; =&gt; transferring context: 2B 0.0s</td></tr><tr><td id=\"file-1-txt-L8\" data-line-number=\"8\"></td><td id=\"file-1-txt-LC8\">=&gt; [internal] load metadata for docker.io/library/golang:1.16.2-stretch 0.0s</td></tr><tr><td id=\"file-1-txt-L9\" data-line-number=\"9\"></td><td id=\"file-1-txt-LC9\">=&gt; [internal] load metadata for docker.io/library/alpine:latest 4.8s</td></tr><tr><td id=\"file-1-txt-L10\" data-line-number=\"10\"></td><td id=\"file-1-txt-LC10\">=&gt; [auth] library/alpine:pull token for registry-1.docker.io 0.0s</td></tr><tr><td id=\"file-1-txt-L11\" data-line-number=\"11\"></td><td id=\"file-1-txt-LC11\">=&gt; [stage-1 1/4] FROM docker.io/library/alpine:latest@sha256:a75afd8b57e7f34e4dad 0.0s</td></tr><tr><td id=\"file-1-txt-L12\" data-line-number=\"12\"></td><td id=\"file-1-txt-LC12\">=&gt; [builder 1/5] FROM docker.io/library/golang:1.16.2-stretch 0.0s</td></tr><tr><td id=\"file-1-txt-L13\" data-line-number=\"13\"></td><td id=\"file-1-txt-LC13\">=&gt; [internal] load build context 0.0s</td></tr><tr><td id=\"file-1-txt-L14\" data-line-number=\"14\"></td><td id=\"file-1-txt-LC14\">=&gt; =&gt; transferring context: 84B 0.0s</td></tr><tr><td id=\"file-1-txt-L15\" data-line-number=\"15\"></td><td id=\"file-1-txt-LC15\">=&gt; CACHED [stage-1 2/4] RUN apk --no-cache add ca-certificates 0.0s</td></tr><tr><td id=\"file-1-txt-L16\" data-line-number=\"16\"></td><td id=\"file-1-txt-LC16\">=&gt; CACHED [stage-1 3/4] WORKDIR /root/ 0.0s</td></tr><tr><td id=\"file-1-txt-L17\" data-line-number=\"17\"></td><td id=\"file-1-txt-LC17\">=&gt; CACHED [builder 2/5] WORKDIR /src 0.0s</td></tr><tr><td id=\"file-1-txt-L18\" data-line-number=\"18\"></td><td id=\"file-1-txt-LC18\">=&gt; CACHED [builder 3/5] COPY . . 0.0s</td></tr><tr><td id=\"file-1-txt-L19\" data-line-number=\"19\"></td><td id=\"file-1-txt-LC19\">=&gt; CACHED [builder 4/5] RUN go mod tidy 0.0s</td></tr><tr><td id=\"file-1-txt-L20\" data-line-number=\"20\"></td><td id=\"file-1-txt-LC20\">=&gt; CACHED [builder 5/5] RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix c 0.0s</td></tr><tr><td id=\"file-1-txt-L21\" data-line-number=\"21\"></td><td id=\"file-1-txt-LC21\">=&gt; CACHED [stage-1 4/4] COPY --from=builder /src/main . 0.0s</td></tr><tr><td id=\"file-1-txt-L22\" data-line-number=\"22\"></td><td id=\"file-1-txt-LC22\">=&gt; exporting to image 0.0s</td></tr><tr><td id=\"file-1-txt-L23\" data-line-number=\"23\"></td><td id=\"file-1-txt-LC23\">=&gt; =&gt; exporting layers 0.0s</td></tr><tr><td id=\"file-1-txt-L24\" data-line-number=\"24\"></td><td id=\"file-1-txt-LC24\">=&gt; =&gt; writing image sha256:1c0ad4e05bf709c8a451ffc2ab56f73e1203d0847d60c2fc290238 0.0s</td></tr><tr><td id=\"file-1-txt-L25\" data-line-number=\"25\"></td><td id=\"file-1-txt-LC25\">=&gt; =&gt; naming to docker.io/library/demo 0.0s</td></tr></tbody></table></div><p>แก้ไขแบบง่าย ๆ เรียบร้อยแล้ว</p></div><div><p><img alt=\"\" src=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=90&amp;d=mm&amp;r=g\" srcset=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=180&amp;d=mm&amp;r=g 2x\" height=\"90\" width=\"90\"></p><h4>Article by <a href=\"https://www.facebook.com/somkiatspns\">Somkiat Puisungnoen</a></h4><p>To be Craftmanship</p></div></div></article></div></div>","author":"somkiat","siteTitle":"cc :: somkiat","siteHash":"3a23a5a4389e1e40c6fbb16520a8cc20df5b3591c25145ce72aaa18b19e48201","entryHash":"120d6f89709cf56b220b51148e9ccdbeff9e49d022e69ef7758a9923bdecc1a1","category":"Thai"}