{"title":"RabbitMQ :: ทำการ route message ด้วย key แบบ dynamic","link":"https://www.somkiat.cc/rabbitmq-with-consistent-hash-exchange/","date":1619751654000,"content":"<div id=\"readability-page-1\" class=\"page\"><div id=\"page\"><article><div id=\"content_box\"><header><div><p><time>April 30, 2021</time> <span><a href=\"https://www.somkiat.cc/category/programming/\" rel=\"category tag\">Programming</a>, <a href=\"https://www.somkiat.cc/category/tools/\" rel=\"category tag\">Tools</a></span></p></div></header><div><p>คำถามที่น่าสนใจเกี่ยวการจัดการ message ด้วย <a href=\"https://www.rabbitmq.com/\" target=\"_blank\" rel=\"noreferrer noopener\">RabbitMQ</a><br>ถ้าต้องการ route message ด้วย key ที่ต้องการ<br>แต่ key นั้นมัน dynamic เราไม่สามารถกำหนดได้<br>ต้องการให้ message ที่มี key เดียวกันเข้าไปทำงานที่ consumer เดียวกัน<br>เพื่อให้สามารถทำงานได้ตามที่ต้องการทาง business นั่นเอง</p><p><strong>แนวทางใน RabbitMQ คือการทำ routing นั่นเอง</strong></p><p>ซึ่งจะมีรูปแบบต่าง ๆ ให้เลือกใช้งานดังนี้</p><ul><li>Fanout</li><li>Direct</li><li>Topic</li><li>Header</li><li>Consistent Hashing</li></ul><figure><img src=\"https://www.somkiat.cc/wp-content/uploads/2021/04/rabbitmq-routing.png\" alt=\"\" width=\"501\" height=\"301\" srcset=\"https://www.somkiat.cc/wp-content/uploads/2021/04/rabbitmq-routing.png 809w, https://www.somkiat.cc/wp-content/uploads/2021/04/rabbitmq-routing-300x181.png 300w, https://www.somkiat.cc/wp-content/uploads/2021/04/rabbitmq-routing-768x462.png 768w\" sizes=\"(max-width: 501px) 100vw, 501px\"></figure><p><strong>แต่จาก use case นั้น น่าจะต้องใช้งาน Consistent Hashing</strong></p><p>เนื่องจากเราไม่สามารถรู้เลยว่า key ที่ส่งเข้ามามีค่าอะไรบ้าง<br>ดังนั้นจำเป็นต้องใช้ <strong>Hashing function</strong> เข้ามาช่วย<br>สำหรับการ route message ไปยัง consumer ต่าง ๆ<br>ส่วนฝั่ง consumer จะต้องทำการ binding key ด้วยตัวเลขเท่านั้น<br>กำหนดได้เท่าที่เราต้องการ สามารถเพิ่มหรือลดได้เสมอ</p><figure><img src=\"https://www.somkiat.cc/wp-content/uploads/2021/04/consistent-hashing.png\" alt=\"\" width=\"413\" height=\"282\" srcset=\"https://www.somkiat.cc/wp-content/uploads/2021/04/consistent-hashing.png 530w, https://www.somkiat.cc/wp-content/uploads/2021/04/consistent-hashing-300x205.png 300w\" sizes=\"(max-width: 413px) 100vw, 413px\"></figure><p><strong>ทำให้มั่นใจได้ว่า message ที่มี key เดียวกัน</strong></p><p>จะเข้าทำงานที่ consumer เดียวกันแน่นอน<br>และถ้าต้องการให้เรียงลำดับการทำงานแบบ <strong>FIFO</strong><br>โดยไม่ทำงานสลับกันทั้งเริ่มและสิ้นสุด<br>จำเป็นต้องกำหนดค่า prefetch=1<br>และกำหนด noAck=false เพื่อกำหนดการส่ง acknowledge กลับเอง</p><p>แต่การใช้งานจำเป็นต้องติดตั้ง plugin เพิ่ม<br>ชื่อว่า <strong><a href=\"https://github.com/rabbitmq/rabbitmq-server/blob/master/deps/rabbitmq_consistent_hash_exchange/README.md\" target=\"_blank\" rel=\"noreferrer noopener\">RabbitMQ Consistent Hash Exchange</a></strong><br>เพียงเท่านี้ก็สามารถกำหนดให้ RabbitMQ ทำงานตามที่ต้องการแล้ว</p><p><strong><em>ปล. ถ้าเป็น Apache Kafka จบไปนานแล้ว !!</em></strong></p></div><div><p><img alt=\"\" src=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=90&amp;d=mm&amp;r=g\" srcset=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=180&amp;d=mm&amp;r=g 2x\" height=\"90\" width=\"90\"></p><h4>Article by <a href=\"https://www.facebook.com/somkiatspns\">Somkiat Puisungnoen</a></h4><p>To be Craftmanship</p></div></div></article></div></div>","author":"somkiat","siteTitle":"cc :: somkiat","siteHash":"3a23a5a4389e1e40c6fbb16520a8cc20df5b3591c25145ce72aaa18b19e48201","entryHash":"7bbb1ba0aa86fa72fc05f0ee58976905996ce752b70335e367ef3abec4663fef","category":"Thai"}