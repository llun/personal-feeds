{"title":"[Go] บันทึกแก้ไขปัญหาในการจัดการ JSON นิดหน่อย (JSON Serialization)","link":"https://www.somkiat.cc/not-go-with-json-serialization/","date":1620919839000,"content":"<div id=\"readability-page-1\" class=\"page\"><div id=\"page\"><article><div id=\"content_box\"><header></header><div><figure><img src=\"https://www.somkiat.cc/wp-content/uploads/2021/05/go-json.jpg\" alt=\"\" width=\"541\" height=\"332\" srcset=\"https://www.somkiat.cc/wp-content/uploads/2021/05/go-json.jpg 900w, https://www.somkiat.cc/wp-content/uploads/2021/05/go-json-300x184.jpg 300w, https://www.somkiat.cc/wp-content/uploads/2021/05/go-json-768x472.jpg 768w\" sizes=\"(max-width: 541px) 100vw, 541px\"></figure><p><strong>ปัญหา</strong><br>ในงานที่ทำ มีกรณีของการทำงานร่วมกับข้อมูลในรูปแบบ JSON<br>ซึ่งในบาง field/property อาจจะมีข้อมูลมาบ้าง ไม่มีบ้าง<br>แถมเป็น null/nill ได้อีก<br>ทำให้การแปลงข้อมูล JSON มาเป็น Struct<br>ไม่ตรงตามที่ต้องการเท่าไร<br>จึงลองหาวิธีการแก้ไขนิดหน่อย</p><p><strong>แนวทางการแก้ไข</strong></p><p>เริ่มจาก code ปกติงานได้ปกติ</p><div itemprop=\"text\" id=\"gist109490212\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-1-go-L1\" data-line-number=\"1\"></td><td id=\"file-1-go-LC1\"><span>type</span> <span>Data</span> <span>struct</span> {</td></tr><tr><td id=\"file-1-go-L2\" data-line-number=\"2\"></td><td id=\"file-1-go-LC2\"><span>Id</span> <span>int</span> <span>`json:\"id\"`</span></td></tr><tr><td id=\"file-1-go-L3\" data-line-number=\"3\"></td><td id=\"file-1-go-LC3\"><span>Name</span> <span>string</span> <span>`json:\"name\"`</span></td></tr><tr><td id=\"file-1-go-L4\" data-line-number=\"4\"></td><td id=\"file-1-go-LC4\"><span>Amount</span> <span>int</span> <span>`json:\"amount\"`</span></td></tr><tr><td id=\"file-1-go-L5\" data-line-number=\"5\"></td><td id=\"file-1-go-LC5\">}</td></tr><tr><td id=\"file-1-go-L6\" data-line-number=\"6\"></td><td id=\"file-1-go-LC6\"></td></tr><tr><td id=\"file-1-go-L7\" data-line-number=\"7\"></td><td id=\"file-1-go-LC7\"><span>func</span> <span>main</span>() {</td></tr><tr><td id=\"file-1-go-L8\" data-line-number=\"8\"></td><td id=\"file-1-go-LC8\"><span>res</span> <span>:=</span> <span>Data</span>{<span>Id</span>: <span>1</span>, <span>Name</span>: <span>\"somkiat\"</span>, <span>Amount</span>: <span>100</span>}</td></tr><tr><td id=\"file-1-go-L9\" data-line-number=\"9\"></td><td id=\"file-1-go-LC9\"></td></tr><tr><td id=\"file-1-go-L10\" data-line-number=\"10\"></td><td id=\"file-1-go-LC10\"><span>enc</span> <span>:=</span> <span>json</span>.<span>NewEncoder</span>(<span>os</span>.<span>Stdout</span>)</td></tr><tr><td id=\"file-1-go-L11\" data-line-number=\"11\"></td><td id=\"file-1-go-LC11\"><span>enc</span>.<span>Encode</span>(<span>res</span>)</td></tr><tr><td id=\"file-1-go-L12\" data-line-number=\"12\"></td><td id=\"file-1-go-LC12\">}</td></tr></tbody></table></div><p><strong>แต่เมื่อถ้าบาง property ไม่ได้กำหนดค่า</strong></p><p>จะมีค่าเป็น zero value<br>ยกตัวอย่างที่ property Amount</p><div itemprop=\"text\" id=\"gist109490212\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-2-go-L1\" data-line-number=\"1\"></td><td id=\"file-2-go-LC1\"><span>type</span> <span>Data</span> <span>struct</span> {</td></tr><tr><td id=\"file-2-go-L2\" data-line-number=\"2\"></td><td id=\"file-2-go-LC2\"><span>Id</span> <span>int</span> <span>`json:\"id\"`</span></td></tr><tr><td id=\"file-2-go-L3\" data-line-number=\"3\"></td><td id=\"file-2-go-LC3\"><span>Name</span> <span>string</span> <span>`json:\"name\"`</span></td></tr><tr><td id=\"file-2-go-L4\" data-line-number=\"4\"></td><td id=\"file-2-go-LC4\"><span>Amount</span> <span>int</span> <span>`json:\"amount\"`</span></td></tr><tr><td id=\"file-2-go-L5\" data-line-number=\"5\"></td><td id=\"file-2-go-LC5\">}</td></tr><tr><td id=\"file-2-go-L6\" data-line-number=\"6\"></td><td id=\"file-2-go-LC6\"></td></tr><tr><td id=\"file-2-go-L7\" data-line-number=\"7\"></td><td id=\"file-2-go-LC7\"><span>func</span> <span>main</span>() {</td></tr><tr><td id=\"file-2-go-L8\" data-line-number=\"8\"></td><td id=\"file-2-go-LC8\"><span>res</span> <span>:=</span> <span>Data</span>{<span>Id</span>: <span>1</span>, <span>Name</span>: <span>\"somkiat\"</span>}</td></tr><tr><td id=\"file-2-go-L9\" data-line-number=\"9\"></td><td id=\"file-2-go-LC9\"></td></tr><tr><td id=\"file-2-go-L10\" data-line-number=\"10\"></td><td id=\"file-2-go-LC10\"><span>enc</span> <span>:=</span> <span>json</span>.<span>NewEncoder</span>(<span>os</span>.<span>Stdout</span>)</td></tr><tr><td id=\"file-2-go-L11\" data-line-number=\"11\"></td><td id=\"file-2-go-LC11\"><span>enc</span>.<span>Encode</span>(<span>res</span>)</td></tr><tr><td id=\"file-2-go-L12\" data-line-number=\"12\"></td><td id=\"file-2-go-LC12\">}</td></tr><tr><td id=\"file-2-go-L13\" data-line-number=\"13\"></td><td id=\"file-2-go-LC13\"></td></tr><tr><td id=\"file-2-go-L14\" data-line-number=\"14\"></td><td id=\"file-2-go-LC14\"><span>// ผลการทำงาน</span></td></tr><tr><td id=\"file-2-go-L15\" data-line-number=\"15\"></td><td id=\"file-2-go-LC15\">{<span>\"id\"</span>:<span>1</span>,<span>\"name\"</span>:<span>\"somkiat\"</span>,<span>\"amount\"</span>:<span>0</span>}</td></tr></tbody></table></div><p><strong>สิ่งที่ต้องการคือ ถ้าไม่ทำการกำหนดค่าของ property Amount</strong></p><p>จะไม่แสดง property Amount มาด้วย<br>โดยเพิ่ม json literal ชื่อว่า <strong>omitempty</strong><br>ก็ทำตามนี้</p><div itemprop=\"text\" id=\"gist109490212\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-3-go-L1\" data-line-number=\"1\"></td><td id=\"file-3-go-LC1\"><span>type</span> <span>Data</span> <span>struct</span> {</td></tr><tr><td id=\"file-3-go-L2\" data-line-number=\"2\"></td><td id=\"file-3-go-LC2\"><span>Id</span> <span>int</span> <span>`json:\"id\"`</span></td></tr><tr><td id=\"file-3-go-L3\" data-line-number=\"3\"></td><td id=\"file-3-go-LC3\"><span>Name</span> <span>string</span> <span>`json:\"name\"`</span></td></tr><tr><td id=\"file-3-go-L4\" data-line-number=\"4\"></td><td id=\"file-3-go-LC4\"><span>Amount</span> <span>int</span> <span>`json:\"amount,omitempty\"`</span></td></tr><tr><td id=\"file-3-go-L5\" data-line-number=\"5\"></td><td id=\"file-3-go-LC5\">}</td></tr><tr><td id=\"file-3-go-L6\" data-line-number=\"6\"></td><td id=\"file-3-go-LC6\"></td></tr><tr><td id=\"file-3-go-L7\" data-line-number=\"7\"></td><td id=\"file-3-go-LC7\"><span>func</span> <span>main</span>() {</td></tr><tr><td id=\"file-3-go-L8\" data-line-number=\"8\"></td><td id=\"file-3-go-LC8\"><span>res</span> <span>:=</span> <span>Data</span>{<span>Id</span>: <span>1</span>, <span>Name</span>: <span>\"somkiat\"</span>}</td></tr><tr><td id=\"file-3-go-L9\" data-line-number=\"9\"></td><td id=\"file-3-go-LC9\"></td></tr><tr><td id=\"file-3-go-L10\" data-line-number=\"10\"></td><td id=\"file-3-go-LC10\"><span>enc</span> <span>:=</span> <span>json</span>.<span>NewEncoder</span>(<span>os</span>.<span>Stdout</span>)</td></tr><tr><td id=\"file-3-go-L11\" data-line-number=\"11\"></td><td id=\"file-3-go-LC11\"><span>enc</span>.<span>Encode</span>(<span>res</span>)</td></tr><tr><td id=\"file-3-go-L12\" data-line-number=\"12\"></td><td id=\"file-3-go-LC12\">}</td></tr><tr><td id=\"file-3-go-L13\" data-line-number=\"13\"></td><td id=\"file-3-go-LC13\"></td></tr><tr><td id=\"file-3-go-L14\" data-line-number=\"14\"></td><td id=\"file-3-go-LC14\"><span>// ผลการทำงาน</span></td></tr><tr><td id=\"file-3-go-L15\" data-line-number=\"15\"></td><td id=\"file-3-go-LC15\">{<span>\"id\"</span>:<span>1</span>,<span>\"name\"</span>:<span>\"somkiat\"</span>}</td></tr></tbody></table></div><p><strong>แต่ก็มีบางกรณี ที่มีกำหนดค่าเป็น nil มาด้วย มันจะซับซ้อนไปไหน ?</strong></p><p>จัดการข้อมูลต้นทางดี ๆ ไม่ได้หรือไง ?<br>ตอบเลย ไม่ได้ เศร้า !!<br>ดังนั้นแก้ไขกันหน่อย<br>ด้วยการให้ property ที่มีชนิดเป็น int ให้สามารถรับค่า nil ได้<br>ด้วยการเปลี่ยนเป็น pointer ดังนี้</p><div itemprop=\"text\" id=\"gist109490212\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-4-go-L1\" data-line-number=\"1\"></td><td id=\"file-4-go-LC1\"><span>type</span> <span>Data</span> <span>struct</span> {</td></tr><tr><td id=\"file-4-go-L2\" data-line-number=\"2\"></td><td id=\"file-4-go-LC2\"><span>Id</span> <span>int</span> <span>`json:\"id\"`</span></td></tr><tr><td id=\"file-4-go-L3\" data-line-number=\"3\"></td><td id=\"file-4-go-LC3\"><span>Name</span> <span>string</span> <span>`json:\"name\"`</span></td></tr><tr><td id=\"file-4-go-L4\" data-line-number=\"4\"></td><td id=\"file-4-go-LC4\"><span>Amount</span> <span>*</span><span>int</span> <span>`json:\"amount,omitempty\"`</span></td></tr><tr><td id=\"file-4-go-L5\" data-line-number=\"5\"></td><td id=\"file-4-go-LC5\">}</td></tr><tr><td id=\"file-4-go-L6\" data-line-number=\"6\"></td><td id=\"file-4-go-LC6\"></td></tr><tr><td id=\"file-4-go-L7\" data-line-number=\"7\"></td><td id=\"file-4-go-LC7\"><span>func</span> <span>main</span>() {</td></tr><tr><td id=\"file-4-go-L8\" data-line-number=\"8\"></td><td id=\"file-4-go-LC8\"><span>res</span> <span>:=</span> <span>Data</span>{<span>Id</span>: <span>1</span>, <span>Name</span>: <span>\"somkiat\"</span>, <span>Amount</span>: <span>nil</span>}</td></tr><tr><td id=\"file-4-go-L9\" data-line-number=\"9\"></td><td id=\"file-4-go-LC9\"></td></tr><tr><td id=\"file-4-go-L10\" data-line-number=\"10\"></td><td id=\"file-4-go-LC10\"><span>enc</span> <span>:=</span> <span>json</span>.<span>NewEncoder</span>(<span>os</span>.<span>Stdout</span>)</td></tr><tr><td id=\"file-4-go-L11\" data-line-number=\"11\"></td><td id=\"file-4-go-LC11\"><span>enc</span>.<span>Encode</span>(<span>res</span>)</td></tr><tr><td id=\"file-4-go-L12\" data-line-number=\"12\"></td><td id=\"file-4-go-LC12\">}</td></tr><tr><td id=\"file-4-go-L13\" data-line-number=\"13\"></td><td id=\"file-4-go-LC13\"></td></tr><tr><td id=\"file-4-go-L14\" data-line-number=\"14\"></td><td id=\"file-4-go-LC14\"><span>// ผลการทำงาน</span></td></tr><tr><td id=\"file-4-go-L15\" data-line-number=\"15\"></td><td id=\"file-4-go-LC15\">{<span>\"id\"</span>:<span>1</span>,<span>\"name\"</span>:<span>\"somkiat\"</span>}</td></tr></tbody></table></div><p>ก็พอแก้ไขให้ทำงานที่ต้องการได้บ้าง</p></div><div><p><img alt=\"\" src=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=90&amp;d=mm&amp;r=g\" srcset=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=180&amp;d=mm&amp;r=g 2x\" height=\"90\" width=\"90\"></p><h4>Article by <a href=\"https://www.facebook.com/somkiatspns\">Somkiat Puisungnoen</a></h4><p>To be Craftmanship</p></div></div></article></div></div>","author":"somkiat","siteTitle":"cc :: somkiat","siteHash":"3a23a5a4389e1e40c6fbb16520a8cc20df5b3591c25145ce72aaa18b19e48201","entryHash":"18ef3c7f20bf4ff58c53abee8c2558735ec4b463a26cedd32f5525427bbb4069","category":"Thai"}