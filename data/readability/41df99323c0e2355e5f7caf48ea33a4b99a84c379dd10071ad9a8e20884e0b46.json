{"title":"0244 | ใช้ GPU intel transcode video ด้วย ffmpeg","link":"https://www.icez.net/blog/167400/ffmpeg-transcode-video-intel","date":1585133606000,"content":"<div id=\"readability-page-1\" class=\"page\"><div id=\"wrap\"><h2><a href=\"https://www.icez.net/blog/167400/ffmpeg-transcode-video-intel\" rel=\"bookmark\" title=\"Permanent Link: 0244 | ใช้ GPU intel transcode video ด้วย ffmpeg\">0244 | ใช้ GPU intel transcode video ด้วย ffmpeg</a></h2><p>March 25th, 2020 by icez | Posted in <a href=\"https://www.icez.net/blog/topics/misc\" rel=\"category tag\">Misc</a> |</p><p>API ใหม่ๆ ของ ffmpeg จะทำงานบน vaapi (video accelerator api) เพราะงั้นเวลา transcode เลยต้องใช้ interface ของ vaapi ประมาณนี้</p><div><div><pre><span><span>ffmpeg</span></span><span> \\\n  </span><span><span>-</span><span>hwaccel</span></span><span> vaapi </span><span>-</span><span>hwaccel_device </span><span><span>/</span></span><span>dev</span><span><span>/</span></span><span>dri</span><span><span>/</span></span><span>renderD128 </span><span>-</span><span>hwaccel_output_format vaapi \\\n  </span><span><span>-</span><span>i</span></span><span> inputfile</span><span>.</span><span>mp4 \\\n  </span><span>-</span><span>c</span><span>:</span><span>v h264_vaapi </span><span>-</span><span>b</span><span>:</span><span>v </span><span>1500k</span><span> </span><span>-</span><span>profile</span><span>:</span><span>v main </span><span><span>-</span><span>g</span></span><span> </span><span><span>100</span></span><span> \\\n  </span><span>-</span><span>c</span><span>:</span><span>a aac </span><span>-</span><span>b</span><span>:</span><span>a </span><span>128k</span><span> \\\n  </span><span><span>-</span><span>f</span></span><span> mp4 output</span><span>.</span><span>mp4</span></pre></div><p>ffmpeg \\ -hwaccel vaapi -hwaccel_device /dev/dri/renderD128 -hwaccel_output_format vaapi \\ -i inputfile.mp4 \\ -c:v h264_vaapi -b:v 1500k -profile:v main -g 100 \\ -c:a aac -b:a 128k \\ -f mp4 output.mp4</p></div><ol><li>สั่ง ffmpeg</li><li>ตั้งค่าให้สัญญาณ video ขาเข้า ไป decode ด้วย vaapi (เพื่อให้เอาผลลัพท์ไปใช้ต่อใน vaapi ได้)</li><li>ระบุสัญญาณ input</li><li>ระบุการแปลง format ให้ใช้ vaapi h264 encoder ปรับ profile/bitrate ตามชอบ option อื่นๆ ไปดูใน docs</li><li>ตั้ง codec เสียง</li><li>เก็บ output เป็น format mp4 ลงไฟล์ output.mp4</li></ol><p>ref: https://trac.ffmpeg.org/wiki/Hardware/VAAPI</p><p>แถม อันนี้ใช้ vlc clean สัญญาณกล้องวงจรปิด ก่อนส่งให้ ffmpeg transcode ต่อ (ไม่รู้ทำไม ffmpeg transcode ตรงๆ ไม่ได้)</p><div><div><pre><span>vlc \\\n </span><span><span>'rtsp://192.168.1.102/user=admin&amp;amp;password=&amp;amp;channel=1&amp;amp;stream=0.sdp?'</span></span><span> \\\n  </span><span><span>--</span><span>sout</span></span><span> </span><span><span>'#duplicate{dst=std{access=file,mux=ts,dst=-}}'</span></span><span> </span><span><span>|</span></span><span> \\\n  </span><span><span>ffmpeg</span></span><span> \\\n    </span><span><span>-</span><span>hwaccel</span></span><span> vaapi </span><span>-</span><span>hwaccel_device </span><span><span>/</span></span><span>dev</span><span><span>/</span></span><span>dri</span><span><span>/</span></span><span>renderD128 </span><span>-</span><span>hwaccel_output_format vaapi \\\n    </span><span><span>-</span><span>i</span></span><span> </span><span>-</span><span> \\\n    </span><span>-</span><span>c</span><span>:</span><span>v h264_vaapi </span><span>-</span><span>b</span><span>:</span><span>v </span><span>1500k</span><span> </span><span>-</span><span>profile</span><span>:</span><span>v main </span><span><span>-</span><span>g</span></span><span> </span><span><span>100</span></span><span>  \\\n    </span><span><span>-</span><span>y</span></span><span> </span><span><span>-</span><span>f</span></span><span> flv rtmp</span><span>:</span><span><span>//</span></span><span>127.0.0.1</span><span><span>/</span></span><span>live</span><span><span>/</span></span><span>cctv2</span></pre></div><p>vlc \\ 'rtsp://192.168.1.102/user=admin&amp;amp;password=&amp;amp;channel=1&amp;amp;stream=0.sdp?' \\ --sout '#duplicate{dst=std{access=file,mux=ts,dst=-}}' | \\ ffmpeg \\ -hwaccel vaapi -hwaccel_device /dev/dri/renderD128 -hwaccel_output_format vaapi \\ -i - \\ -c:v h264_vaapi -b:v 1500k -profile:v main -g 100 \\ -y -f flv rtmp://127.0.0.1/live/cctv2</p></div></div></div>","author":"icez","siteTitle":"icez network","siteHash":"88787adba55f9deb5660f47c4b8baf580eb765815e4a6d536737656e8ab8bde4","entryHash":"41df99323c0e2355e5f7caf48ea33a4b99a84c379dd10071ad9a8e20884e0b46","category":"Thai"}