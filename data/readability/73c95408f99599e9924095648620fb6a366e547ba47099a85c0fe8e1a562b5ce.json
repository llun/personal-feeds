{"title":"Dashboard as a Code ด้วย Grafonnet","link":"https://www.somkiat.cc/grafana-dashboard-as-a-code/","date":1626021119000,"content":"<div id=\"readability-page-1\" class=\"page\"><div id=\"page\"><article><div id=\"content_box\"><header></header><div><figure><img src=\"https://www.somkiat.cc/wp-content/uploads/2021/07/grafana-dashboard-demo-1024x487.png\" alt=\"\" srcset=\"https://www.somkiat.cc/wp-content/uploads/2021/07/grafana-dashboard-demo-1024x487.png 1024w, https://www.somkiat.cc/wp-content/uploads/2021/07/grafana-dashboard-demo-300x143.png 300w, https://www.somkiat.cc/wp-content/uploads/2021/07/grafana-dashboard-demo-768x365.png 768w, https://www.somkiat.cc/wp-content/uploads/2021/07/grafana-dashboard-demo-1536x730.png 1536w, https://www.somkiat.cc/wp-content/uploads/2021/07/grafana-dashboard-demo.png 1919w\" sizes=\"(max-width: 1024px) 100vw, 1024px\"></figure><p>ในการสร้าง Dashboard ใน Grafana นั้นต้องสร้างในรูปแบบของ JSON<br>ซึ่งมีตัวอย่าง และ community ให้เยอะมาก ๆ<br>แต่ปัญหาคือ การสร้าง ทดสอบ และดูแลไม่ง่ายเลย</p><p>จัดการ version ของ dashboard น่าจะอยู่ใน version control ด้วย<br>ควรต้องมีการ review code ของการสร้าง dashboard<br>สามารถ integrate กับระบบ CI/CDได้ง่าย<br>สามารถ reuse ในรูปแบบ component ได้</p><figure><img src=\"https://www.somkiat.cc/wp-content/uploads/2021/07/GrafanaAsCode1-1024x576.jpg\" alt=\"\" width=\"572\" height=\"322\" srcset=\"https://www.somkiat.cc/wp-content/uploads/2021/07/GrafanaAsCode1-1024x576.jpg 1024w, https://www.somkiat.cc/wp-content/uploads/2021/07/GrafanaAsCode1-300x169.jpg 300w, https://www.somkiat.cc/wp-content/uploads/2021/07/GrafanaAsCode1-768x432.jpg 768w, https://www.somkiat.cc/wp-content/uploads/2021/07/GrafanaAsCode1-1536x864.jpg 1536w, https://www.somkiat.cc/wp-content/uploads/2021/07/GrafanaAsCode1-2048x1152.jpg 2048w\" sizes=\"(max-width: 572px) 100vw, 572px\"><figcaption><a href=\"https://grafana.com/blog/2020/02/26/how-to-configure-grafana-as-code/\">https://grafana.com/blog/2020/02/26/how-to-configure-grafana-as-code/</a></figcaption></figure><p><strong>แนวทางแก้ไขปัญหาของ Grafana dashboard ที่น่าสนใจ</strong>คือ</p><p>Dashboard as a Code ด้วย <strong><a href=\"https://grafana.github.io/grafonnet-lib/\" target=\"_blank\" rel=\"noreferrer noopener\">Grafonnet</a></strong><br>ซึ่งใช้งานร่วมกับ</p><ul><li><strong>jsonnet</strong> คือ JSON template language</li><li><strong>grafonnet</strong> คือ Grafana jsonnet library</li></ul><p>ทำการ<a rel=\"noreferrer noopener\" href=\"https://grafana.github.io/grafonnet-lib/getting-started/\" target=\"_blank\">ติดตั้งตามเอกสาร</a><br>จากนั้นทำการสร้าง project ของ dashboard ดังนี้</p><p><strong>ขั้นตอนที่ 1 สร้าง project</strong></p><div itemprop=\"text\" id=\"gist110597255\" translate=\"no\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-1-txt-L1\" data-line-number=\"1\"></td><td id=\"file-1-txt-LC1\">$jb init</td></tr><tr><td id=\"file-1-txt-L2\" data-line-number=\"2\"></td><td id=\"file-1-txt-LC2\">$jb install https://github.com/grafana/grafonnet-lib/grafonnet</td></tr><tr><td id=\"file-1-txt-L3\" data-line-number=\"3\"></td><td id=\"file-1-txt-LC3\"></td></tr><tr><td id=\"file-1-txt-L4\" data-line-number=\"4\"></td><td id=\"file-1-txt-LC4\">$tree -L 1 .</td></tr><tr><td id=\"file-1-txt-L5\" data-line-number=\"5\"></td><td id=\"file-1-txt-LC5\">.</td></tr><tr><td id=\"file-1-txt-L6\" data-line-number=\"6\"></td><td id=\"file-1-txt-LC6\">├── dashboard.json</td></tr><tr><td id=\"file-1-txt-L7\" data-line-number=\"7\"></td><td id=\"file-1-txt-LC7\">├── dashboard.jsonnet</td></tr><tr><td id=\"file-1-txt-L8\" data-line-number=\"8\"></td><td id=\"file-1-txt-LC8\">├── demo-grafana</td></tr><tr><td id=\"file-1-txt-L9\" data-line-number=\"9\"></td><td id=\"file-1-txt-LC9\">├── grafonnet-lib</td></tr><tr><td id=\"file-1-txt-L10\" data-line-number=\"10\"></td><td id=\"file-1-txt-LC10\">├── package.json</td></tr><tr><td id=\"file-1-txt-L11\" data-line-number=\"11\"></td><td id=\"file-1-txt-LC11\">└── run.sh</td></tr><tr><td id=\"file-1-txt-L12\" data-line-number=\"12\"></td><td id=\"file-1-txt-LC12\"></td></tr><tr><td id=\"file-1-txt-L13\" data-line-number=\"13\"></td><td id=\"file-1-txt-LC13\">2 directories, 4 files</td></tr></tbody></table></div><p><strong>ขั้นตอนที่ 2 สร้างไฟล์ run.sh สำหรับส่งไฟล์ JSON ของ dashboard ไปยัง Grafana server</strong></p><div itemprop=\"text\" id=\"gist110597255\" translate=\"no\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-run-sh-L1\" data-line-number=\"1\"></td><td id=\"file-run-sh-LC1\"><span><span>#!</span>/usr/bin/env bash</span></td></tr><tr><td id=\"file-run-sh-L2\" data-line-number=\"2\"></td><td id=\"file-run-sh-LC2\"></td></tr><tr><td id=\"file-run-sh-L3\" data-line-number=\"3\"></td><td id=\"file-run-sh-LC3\">JSONNET_PATH=grafonnet-lib \\</td></tr><tr><td id=\"file-run-sh-L4\" data-line-number=\"4\"></td><td id=\"file-run-sh-LC4\">jsonnet dashboard.jsonnet <span>&gt;</span> dashboard.json</td></tr><tr><td id=\"file-run-sh-L5\" data-line-number=\"5\"></td><td id=\"file-run-sh-LC5\"></td></tr><tr><td id=\"file-run-sh-L6\" data-line-number=\"6\"></td><td id=\"file-run-sh-LC6\">payload=<span><span>\"</span>{<span>\\\"</span>dashboard<span>\\\"</span>: <span><span>$(</span>jq <span>.</span> dashboard.json<span>)</span></span>, <span>\\\"</span>overwrite<span>\\\"</span>: true}<span>\"</span></span></td></tr><tr><td id=\"file-run-sh-L7\" data-line-number=\"7\"></td><td id=\"file-run-sh-LC7\"></td></tr><tr><td id=\"file-run-sh-L8\" data-line-number=\"8\"></td><td id=\"file-run-sh-LC8\">curl -X POST <span>$BASIC_AUTH</span> \\</td></tr><tr><td id=\"file-run-sh-L9\" data-line-number=\"9\"></td><td id=\"file-run-sh-LC9\">-H <span><span>'</span>Content-Type: application/json<span>'</span></span> \\</td></tr><tr><td id=\"file-run-sh-L10\" data-line-number=\"10\"></td><td id=\"file-run-sh-LC10\">-d <span><span>\"</span><span>${payload}</span><span>\"</span></span> \\</td></tr><tr><td id=\"file-run-sh-L11\" data-line-number=\"11\"></td><td id=\"file-run-sh-LC11\"><span><span>\"</span>http://admin:admin@localhost:3000/api/dashboards/db<span>\"</span></span></td></tr></tbody></table></div><p><strong>ขั้นตอนที่ 3 ทำการสร้างไฟล์ JSON จาก grafannet</strong></p><div itemprop=\"text\" id=\"gist110597255\" translate=\"no\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-2-txt-L1\" data-line-number=\"1\"></td><td id=\"file-2-txt-LC1\">// 1. สร้างไฟล์ JSON</td></tr><tr><td id=\"file-2-txt-L2\" data-line-number=\"2\"></td><td id=\"file-2-txt-LC2\">$jsonnet -J grafonnet-lib dashboard.jsonnet</td></tr><tr><td id=\"file-2-txt-L3\" data-line-number=\"3\"></td><td id=\"file-2-txt-LC3\"></td></tr><tr><td id=\"file-2-txt-L4\" data-line-number=\"4\"></td><td id=\"file-2-txt-LC4\">{</td></tr><tr><td id=\"file-2-txt-L5\" data-line-number=\"5\"></td><td id=\"file-2-txt-LC5\">\"__inputs\": [ ],</td></tr><tr><td id=\"file-2-txt-L6\" data-line-number=\"6\"></td><td id=\"file-2-txt-LC6\">\"__requires\": [ ],</td></tr><tr><td id=\"file-2-txt-L7\" data-line-number=\"7\"></td><td id=\"file-2-txt-LC7\">\"annotations\": {</td></tr><tr><td id=\"file-2-txt-L8\" data-line-number=\"8\"></td><td id=\"file-2-txt-LC8\">\"list\": [ ]</td></tr><tr><td id=\"file-2-txt-L9\" data-line-number=\"9\"></td><td id=\"file-2-txt-LC9\">},</td></tr><tr><td id=\"file-2-txt-L10\" data-line-number=\"10\"></td><td id=\"file-2-txt-LC10\">\"editable\": false,</td></tr><tr><td id=\"file-2-txt-L11\" data-line-number=\"11\"></td><td id=\"file-2-txt-LC11\">\"gnetId\": null,</td></tr><tr><td id=\"file-2-txt-L12\" data-line-number=\"12\"></td><td id=\"file-2-txt-LC12\">\"graphTooltip\": 0,</td></tr><tr><td id=\"file-2-txt-L13\" data-line-number=\"13\"></td><td id=\"file-2-txt-LC13\">\"hideControls\": false,</td></tr><tr><td id=\"file-2-txt-L14\" data-line-number=\"14\"></td><td id=\"file-2-txt-LC14\">\"id\": null,</td></tr><tr><td id=\"file-2-txt-L15\" data-line-number=\"15\"></td><td id=\"file-2-txt-LC15\">\"links\": [ ],</td></tr><tr><td id=\"file-2-txt-L16\" data-line-number=\"16\"></td><td id=\"file-2-txt-LC16\">\"refresh\": \"\",</td></tr><tr><td id=\"file-2-txt-L17\" data-line-number=\"17\"></td><td id=\"file-2-txt-LC17\">\"rows\": [ ],</td></tr><tr><td id=\"file-2-txt-L18\" data-line-number=\"18\"></td><td id=\"file-2-txt-LC18\">\"schemaVersion\": 14,</td></tr><tr><td id=\"file-2-txt-L19\" data-line-number=\"19\"></td><td id=\"file-2-txt-LC19\">\"style\": \"dark\",</td></tr><tr><td id=\"file-2-txt-L20\" data-line-number=\"20\"></td><td id=\"file-2-txt-LC20\">\"tags\": [ ],</td></tr><tr><td id=\"file-2-txt-L21\" data-line-number=\"21\"></td><td id=\"file-2-txt-LC21\">\"templating\": {</td></tr><tr><td id=\"file-2-txt-L22\" data-line-number=\"22\"></td><td id=\"file-2-txt-LC22\">\"list\": [ ]</td></tr><tr><td id=\"file-2-txt-L23\" data-line-number=\"23\"></td><td id=\"file-2-txt-LC23\">},</td></tr><tr><td id=\"file-2-txt-L24\" data-line-number=\"24\"></td><td id=\"file-2-txt-LC24\">\"time\": {</td></tr><tr><td id=\"file-2-txt-L25\" data-line-number=\"25\"></td><td id=\"file-2-txt-LC25\">\"from\": \"now-6h\",</td></tr><tr><td id=\"file-2-txt-L26\" data-line-number=\"26\"></td><td id=\"file-2-txt-LC26\">\"to\": \"now\"</td></tr><tr><td id=\"file-2-txt-L27\" data-line-number=\"27\"></td><td id=\"file-2-txt-LC27\">},</td></tr><tr><td id=\"file-2-txt-L28\" data-line-number=\"28\"></td><td id=\"file-2-txt-LC28\">\"timepicker\": {</td></tr><tr><td id=\"file-2-txt-L29\" data-line-number=\"29\"></td><td id=\"file-2-txt-LC29\">\"refresh_intervals\": [</td></tr><tr><td id=\"file-2-txt-L30\" data-line-number=\"30\"></td><td id=\"file-2-txt-LC30\">\"5s\",</td></tr><tr><td id=\"file-2-txt-L31\" data-line-number=\"31\"></td><td id=\"file-2-txt-LC31\">\"10s\",</td></tr><tr><td id=\"file-2-txt-L32\" data-line-number=\"32\"></td><td id=\"file-2-txt-LC32\">\"30s\",</td></tr><tr><td id=\"file-2-txt-L33\" data-line-number=\"33\"></td><td id=\"file-2-txt-LC33\">\"1m\",</td></tr><tr><td id=\"file-2-txt-L34\" data-line-number=\"34\"></td><td id=\"file-2-txt-LC34\">\"5m\",</td></tr><tr><td id=\"file-2-txt-L35\" data-line-number=\"35\"></td><td id=\"file-2-txt-LC35\">\"15m\",</td></tr><tr><td id=\"file-2-txt-L36\" data-line-number=\"36\"></td><td id=\"file-2-txt-LC36\">\"30m\",</td></tr><tr><td id=\"file-2-txt-L37\" data-line-number=\"37\"></td><td id=\"file-2-txt-LC37\">\"1h\",</td></tr><tr><td id=\"file-2-txt-L38\" data-line-number=\"38\"></td><td id=\"file-2-txt-LC38\">\"2h\",</td></tr><tr><td id=\"file-2-txt-L39\" data-line-number=\"39\"></td><td id=\"file-2-txt-LC39\">\"1d\"</td></tr><tr><td id=\"file-2-txt-L40\" data-line-number=\"40\"></td><td id=\"file-2-txt-LC40\">],</td></tr><tr><td id=\"file-2-txt-L41\" data-line-number=\"41\"></td><td id=\"file-2-txt-LC41\">\"time_options\": [</td></tr><tr><td id=\"file-2-txt-L42\" data-line-number=\"42\"></td><td id=\"file-2-txt-LC42\">\"5m\",</td></tr><tr><td id=\"file-2-txt-L43\" data-line-number=\"43\"></td><td id=\"file-2-txt-LC43\">\"15m\",</td></tr><tr><td id=\"file-2-txt-L44\" data-line-number=\"44\"></td><td id=\"file-2-txt-LC44\">\"1h\",</td></tr><tr><td id=\"file-2-txt-L45\" data-line-number=\"45\"></td><td id=\"file-2-txt-LC45\">\"6h\",</td></tr><tr><td id=\"file-2-txt-L46\" data-line-number=\"46\"></td><td id=\"file-2-txt-LC46\">\"12h\",</td></tr><tr><td id=\"file-2-txt-L47\" data-line-number=\"47\"></td><td id=\"file-2-txt-LC47\">\"24h\",</td></tr><tr><td id=\"file-2-txt-L48\" data-line-number=\"48\"></td><td id=\"file-2-txt-LC48\">\"2d\",</td></tr><tr><td id=\"file-2-txt-L49\" data-line-number=\"49\"></td><td id=\"file-2-txt-LC49\">\"7d\",</td></tr><tr><td id=\"file-2-txt-L50\" data-line-number=\"50\"></td><td id=\"file-2-txt-LC50\">\"30d\"</td></tr><tr><td id=\"file-2-txt-L51\" data-line-number=\"51\"></td><td id=\"file-2-txt-LC51\">]</td></tr><tr><td id=\"file-2-txt-L52\" data-line-number=\"52\"></td><td id=\"file-2-txt-LC52\">},</td></tr><tr><td id=\"file-2-txt-L53\" data-line-number=\"53\"></td><td id=\"file-2-txt-LC53\">\"timezone\": \"browser\",</td></tr><tr><td id=\"file-2-txt-L54\" data-line-number=\"54\"></td><td id=\"file-2-txt-LC54\">\"title\": \"Empty Dashboard\",</td></tr><tr><td id=\"file-2-txt-L55\" data-line-number=\"55\"></td><td id=\"file-2-txt-LC55\">\"version\": 0</td></tr><tr><td id=\"file-2-txt-L56\" data-line-number=\"56\"></td><td id=\"file-2-txt-LC56\">}</td></tr><tr><td id=\"file-2-txt-L57\" data-line-number=\"57\"></td><td id=\"file-2-txt-LC57\"></td></tr><tr><td id=\"file-2-txt-L58\" data-line-number=\"58\"></td><td id=\"file-2-txt-LC58\">// 2. Start Grafana Server</td></tr><tr><td id=\"file-2-txt-L59\" data-line-number=\"59\"></td><td id=\"file-2-txt-LC59\">$docker container run --rm -d -p 3000:3000 grafana/grafana</td></tr><tr><td id=\"file-2-txt-L60\" data-line-number=\"60\"></td><td id=\"file-2-txt-LC60\"></td></tr><tr><td id=\"file-2-txt-L61\" data-line-number=\"61\"></td><td id=\"file-2-txt-LC61\">// 3. ทำการส่งไฟล์ JSON ของ dashboard ไปยัง Grafana</td></tr><tr><td id=\"file-2-txt-L62\" data-line-number=\"62\"></td><td id=\"file-2-txt-LC62\">$sh run.sh</td></tr><tr><td id=\"file-2-txt-L63\" data-line-number=\"63\"></td><td id=\"file-2-txt-LC63\"></td></tr><tr><td id=\"file-2-txt-L64\" data-line-number=\"64\"></td><td id=\"file-2-txt-LC64\">{\"id\":2,\"slug\":\"empty-dashboard\",\"status\":\"success\",\"uid\":\"1X68upi7k\",\"url\":\"/d/1X68upi7k/empty-dashboard\",\"version\":2}%</td></tr></tbody></table></div><p><strong>จากนั้นไปดูผลการทำงานที่ Grafana server</strong><br>จะเจอ Dashboard ที่เราสร้างขึ้นมา ดังรูป</p><figure><img src=\"https://www.somkiat.cc/wp-content/uploads/2021/07/Screen-Shot-2564-07-11-at-23.24.10-1024x564.png\" alt=\"\" width=\"491\" height=\"270\" srcset=\"https://www.somkiat.cc/wp-content/uploads/2021/07/Screen-Shot-2564-07-11-at-23.24.10-1024x564.png 1024w, https://www.somkiat.cc/wp-content/uploads/2021/07/Screen-Shot-2564-07-11-at-23.24.10-300x165.png 300w, https://www.somkiat.cc/wp-content/uploads/2021/07/Screen-Shot-2564-07-11-at-23.24.10-768x423.png 768w, https://www.somkiat.cc/wp-content/uploads/2021/07/Screen-Shot-2564-07-11-at-23.24.10-1536x846.png 1536w, https://www.somkiat.cc/wp-content/uploads/2021/07/Screen-Shot-2564-07-11-at-23.24.10.png 1660w\" sizes=\"(max-width: 491px) 100vw, 491px\"></figure><p>น่าจะสนกับ Dashboard as a Code มาก ๆ</p></div><div><p><img alt=\"\" src=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=90&amp;d=mm&amp;r=g\" srcset=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=180&amp;d=mm&amp;r=g 2x\" height=\"90\" width=\"90\"></p><h4>Article by <a href=\"https://www.facebook.com/somkiatspns\">Somkiat Puisungnoen</a></h4><p>To be Craftmanship</p></div></div></article></div></div>","author":"somkiat","siteTitle":"cc :: somkiat","siteHash":"3a23a5a4389e1e40c6fbb16520a8cc20df5b3591c25145ce72aaa18b19e48201","entryHash":"73c95408f99599e9924095648620fb6a366e547ba47099a85c0fe8e1a562b5ce","category":"Thai"}