{"title":"[MQTT] ลอง MQTT บน NodeJS เถอะครับ","link":"https://thanapon.info/nodejs-mqtt/","date":1573996290000,"content":"<div id=\"readability-page-1\" class=\"page\"><div id=\"post-94\"><div><p><span>November 17, 2019</span> <span><a href=\"https://thanapon.info/category/mqtt/\" rel=\"category tag\">MQTT</a>, <a href=\"https://thanapon.info/category/nodejs/\" rel=\"category tag\">NodeJs</a>, <a href=\"https://thanapon.info/category/sonoff/\" rel=\"category tag\">SONOFF</a></span></p></div><p><img width=\"800\" height=\"375\" src=\"https://thanapon.info/wp-content/uploads/2020/04/New-Project2.png\" alt=\"[MQTT] ลอง MQTT บน NodeJS เถอะครับ\" loading=\"lazy\" srcset=\"https://thanapon.info/wp-content/uploads/2020/04/New-Project2.png 800w, https://thanapon.info/wp-content/uploads/2020/04/New-Project2-300x141.png 300w, https://thanapon.info/wp-content/uploads/2020/04/New-Project2-768x360.png 768w, https://thanapon.info/wp-content/uploads/2020/04/New-Project2-600x281.png 600w\" sizes=\"(max-width: 800px) 100vw, 800px\"></p><div><p>ก่อนอื่นต้องบอกต้องอธิบายโปรโตคอล MQTT ก่อนนะครับว่าคืออะไร สำหรับคนที่เคยเล่นพวก IoT อะไรพวกนี้คงจะรู้จักดีเลยครับเพราะ MQTT กับตัว ESP32 หรือ ESP8266 นี้คือของคู่กันเลยครับ</p><p>MQTT คืออะไร</p><p id=\"7502\">MQTT (Message Queueing Telemetry Transport protocol)คือโปรโตคอลที่ใช้สำหรับสื่อสารกันระหว่าง m2m หรือ machine to machine ซึ่งถูกออกแบบมาเพื่อรับส่งข้อมูลกันโดยจะมีตัวกลางในการรับส่งนั้นก็คือ MQTT Broker นั้นเองครับ ภายในโปรโตคอลจะมีรูปแบบการส่งแบบ publish(ผู้ส่ง) และ subscribe(ผู้รับ) การทำงานคือ ทั้ง subscribe และ publish จะต้องทำการเข้าร่วม topic เดียวกันก่อน ซึ่งสมมติ ผมเป็น publish เข้าร่วม topic ที่ชื่อว่า test, subscribe จะต้องเข้าร่วม topic ชื่อว่า test เช่นกัน ส่วนการส่งนั้น publish ก็แค่ทำหน้าที่ publish message ออกมาแล้ว message ก็จะถูกส่งไปหาตามผู้ที่ subscribe topic นั้นทั้งหมดเองครับ</p><p id=\"be64\">MQTT จะแบ่ง QOS สำหรับการรับส่งได้เป็น 3 ประเภทคือ</p><ul><li>QOS0&nbsp;: (at most once) คือส่งไปอย่างเดียวจะไม่รอรับ ACK จากปลายทาง</li><li>QOS1&nbsp;: (at least once) คือหลังจากส่งไปแล้วจะรอรับ ACK ก่อนแล้วค่อยลบ message</li><li>QOS2&nbsp;: (exactly once) หลังจากส่งข้อมูลไปแล้วจะรอรับ ACK จากปลายทางก่อนแล้วหลังจากนั้นจะทำการส่ง recheck flag ไปอีกรอบหนึ่ง</li></ul><p id=\"3bf7\">และเนื่องด้วยความสามารถทางด้าน physical ของ MQTT ที่มีขนาดเล็กอีกทั้งยังใช้ bandwidth ที่ต่ำกว่าพวก HTTP ทำให้ MQTT นั้นจะถูกประยุกต์ใช้กับอุปกรณ์ IoT ด้วยครับ</p><h2 id=\"6bbe\">Mosquitto MQTT Broker</h2><p id=\"35ba\">เมื่อพูดถึง MQTT Broker ทางด้านสาย IoT เราจะต้องนึกถึง Mosquitto เป็นอันดับต้นๆเสมอครับโดย Mosquitto นั้นเป็น MQTT Broker ซึ่งจะเป็นตัวจัดการ Data Broker Middleware สำหรับ Publish และ Subscribe โดยที่เราไม่ต้องไปยุ่งยากทำอะไรกับข้อมูลของเรา แค่ทำการติดตั้งแล้วก็สามารถใช้งานได้เลยครับ</p><p id=\"eb6c\">เริ่มต้นติดตั้ง Mosquitto เลยละกัน</p><ul><li>อันดับแรกให้เราติดตั้งผ่าน terminal นะครับโดยเครื่องที่ผมจะติดตั้งเป็น Ubuntu OS นะครับ</li></ul><pre>sudo apt-get install mosquitto mosquitto-client</pre><ul><li>จากนั้นทำการทดสอบ subscribe topic โดยให้ทำการเปิดหน้า terminal ขึ้นมา 2 หน้าต่างด้วยกันนะครับซึ่งจะตั้งให้ terminal ตัวที่ 1 subscribe topic “test” ส่วนอีก terminal ตัวที่ 2 ให้ทำการ publish message “hello world” ผ่าน topic “test”</li></ul><pre>//terminal 1\nmosquitto_sub -h localhost -t test\n//terminal 2\nmosquitto_pub -h localhost -t test -m \"hello world\" </pre><p id=\"f095\">ผลลัพท์ที่ได้คือ terminal ตัวที่ 1 จะมี message “hello world” ขึ้นมานะครับ</p><div><pre data-lang=\"JavaScript\"><code data-hcb-clip=\"1\"><span>var</span> mqtt <span>=</span> <span>require</span><span>(</span><span>'mqtt'</span><span>)</span><span>;</span>\n\n<span>const</span> <span>MQTT_SERVER</span> <span>=</span> <span>\"Your Server Address\"</span><span>;</span>\n<span>const</span> <span>MQTT_PORT</span> <span>=</span> <span>\"1883\"</span><span>;</span>\n<span>//if your server don't have username and password let blank.</span>\n<span>const</span> <span>MQTT_USER</span> <span>=</span> <span>\"\"</span><span>;</span> \n<span>const</span> <span>MQTT_PASSWORD</span> <span>=</span> <span>\"\"</span><span>;</span>\n\n<span>// Connect MQTT</span>\n<span>var</span> client <span>=</span> mqtt<span>.</span><span>connect</span><span>(</span><span>{</span>\n    host<span>:</span> <span>MQTT_SERVER</span><span>,</span>\n    port<span>:</span> <span>MQTT_PORT</span><span>,</span>\n    username<span>:</span> <span>MQTT_USER</span><span>,</span>\n    password<span>:</span> <span>MQTT_PASSWORD</span>\n<span>}</span><span>)</span><span>;</span>\n\nclient<span>.</span><span>on</span><span>(</span><span>'connect'</span><span>,</span> <span>function</span> <span>(</span><span>)</span> <span>{</span>\n    <span>// Subscribe any topic</span>\n    console<span>.</span><span>log</span><span>(</span><span>\"MQTT Connect\"</span><span>)</span><span>;</span>\n    client<span>.</span><span>subscribe</span><span>(</span><span>'test'</span><span>,</span> <span>function</span> <span>(</span><span>err</span><span>)</span> <span>{</span>\n        <span>if</span> <span>(</span>err<span>)</span> <span>{</span>\n            console<span>.</span><span>log</span><span>(</span>err<span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span><span>)</span><span>;</span>\n<span>}</span><span>)</span><span>;</span>\n\n<span>// Receive Message and print on terminal</span>\nclient<span>.</span><span>on</span><span>(</span><span>'message'</span><span>,</span> <span>function</span> <span>(</span><span>topic<span>,</span> message</span><span>)</span> <span>{</span>\n    <span>// message is Buffer</span>\n    console<span>.</span><span>log</span><span>(</span>message<span>.</span><span>toString</span><span>(</span><span>)</span><span>)</span><span>;</span>\n<span>}</span><span>)</span><span>;</span>\n\n<span>setInterval</span><span>(</span><span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>\n    client<span>.</span><span>publish</span><span>(</span><span>\"test\"</span><span>,</span> <span>\"hello from NodeJS\"</span><span>)</span><span>;</span>\n<span>}</span><span>,</span> <span>5000</span><span>)</span><span>;</span></code></pre></div><ul><li>จากโปรแกรมด้านบนจะเป็นตัวอย่างสำหรับเชื่อมต่อเข้ากับ MQTT Broker ซึ่งหลังจากที่ MQTT เชื่อมต่อเข้ากับ Broker เสร็จแล้วตัวโปรแกรมจะทำการ subscribe topic “test” แล้วทำการวนลูปส่งข้อความ “hello from NodeJS” ทุกๆ 5 วินาทีครับ</li></ul><div><figure><img src=\"https://miro.medium.com/max/1655/1*p99DrnSj2VIo8LvI-a17LQ.png\" alt=\"Image for post\"></figure></div><ul><li>ซึ่งการทำงานของ MQTT จากรูปด้านบนเราจะเห็นได้ว่า ไม่ว่าตัวไหนก็ตามที่ทำการ subscribe topic นั้นๆ ใครที่ส่งข้อมูลอะไรมาก MQTT ก็จะทำการ broadcast ข้อมูลออกไปยังเครื่องที่ subscribe ไว้ไม่ว่าจะเป็น 10 เครื่อง หรือ 100 เครื่องก็จะได้รับข้อมูลทั้งหมดนะครับ</li></ul><p id=\"6d31\">ก็เสร็จสิ้นสำหรับการส่งข้อความผ่าน MQTT กันนะครับผม สำหรับการประยุกต์ใช้ MQTT นั้นจริงๆจะมีอยู่มากมายเลยครับไม่ว่าจะเป็น Smart home โดยใช้ ESP32 หรือ ESP8266 ทำหน้าที่เป็น microcontroller ควบคุม relay ผ่าน MQTT ซึ่งใครที่มีพื้นฐานที่เป็น web developer หน่อยก็สามารถทำ web application สำหรับควบคุมไฟฟ้าในบ้านได้ง่ายๆด้วย MQTT + กับ <a href=\"https://medium.com/@thanapontapala/esp8266-sonoff-%E0%B8%A1%E0%B8%B2%E0%B8%A5%E0%B8%AD%E0%B8%87-tasmota-firmware-%E0%B8%AA%E0%B8%B3%E0%B8%AB%E0%B8%A3%E0%B8%B1%E0%B8%9A-sonoff-%E0%B8%81%E0%B8%B1%E0%B8%99%E0%B8%84%E0%B8%A3%E0%B8%B1%E0%B8%9A-97fbbbe18498\">Tasmota firmware</a> จากเรื่องคราวก่อนด้วยนะครับเพราะเนื่องจากว่า Tasmota firmware รองรับ MQTT อยู่แล้วด้วยเพียงแค่เราเข้าไปตั้งค่าตรงหัวข้อ configuration แล้วชี้มายัง MQTT Broker ของเราเท่านี้ก็สามารถใช้งาน MQTT ควบคุมได้แล้วครับ</p><h2 id=\"42c9\">สำหรับวันนี้ขอบคุณและสวัสดีครับ <img draggable=\"false\" role=\"img\" alt=\"🙂\" src=\"https://s.w.org/images/core/emoji/13.0.0/svg/1f642.svg\"></h2><blockquote><p><a href=\"https://thanapon.info/?p=92\">[ESP8266-Sonoff] มาลอง TASMOTA firmware สำหรับ Sonoff กันครับ</a></p><cite>พอดีได้มีโอกาสไปลองเล่น Sonoff มา ซึ่งรุ่นที่ได้ลองจะเป็น Module Sonoff Basic ลักษณะจะคล้ายๆกับบัลลาสต์เลยครับแต่ขนาดตัวจะเล็กกว่าประมาณครึ่งเลยที่เดียวครับ</cite></blockquote><blockquote><p><a href=\"https://www.npmjs.com/package/mqtt\" target=\"_blank\" rel=\"noreferrer noopener\">mqtt</a></p><cite>MQTT.js is a client library for the <a href=\"https://mqtt.org/\">MQTT</a> protocol, written in JavaScript for node.js and the browser.</cite></blockquote></div></div></div>","author":"thanapon.tap","siteTitle":"Thanapon","siteHash":"6a039c2f54d76e4c49227d80968f2a30de5427cc57525c047c383ea3563cde5f","entryHash":"16ee470dbd3c6f472f3fc4f99a9c58a12536572418292d1c85b36484a3f14c02","category":"Thai"}