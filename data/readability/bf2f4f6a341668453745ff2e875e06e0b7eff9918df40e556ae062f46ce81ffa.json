{"title":"NodeJS :: บันทึก code แบบ blocking และ non-blocking ไว้นิดหน่อย","link":"https://www.somkiat.cc/nodejs-blocking-vs-non-blocking/","date":1612686136000,"content":"<div id=\"readability-page-1\" class=\"page\"><div id=\"page\"><article><div id=\"content_box\"><header><div><p><time>February 7, 2021</time> <span><a href=\"https://www.somkiat.cc/category/programming/\" rel=\"category tag\">Programming</a></span></p></div></header><div><figure><img src=\"https://www.somkiat.cc/wp-content/uploads/2021/02/Event-Loop-1024x664.png\" alt=\"\" width=\"548\" height=\"355\" srcset=\"https://www.somkiat.cc/wp-content/uploads/2021/02/Event-Loop-1024x664.png 1024w, https://www.somkiat.cc/wp-content/uploads/2021/02/Event-Loop-300x194.png 300w, https://www.somkiat.cc/wp-content/uploads/2021/02/Event-Loop-768x498.png 768w, https://www.somkiat.cc/wp-content/uploads/2021/02/Event-Loop.png 1029w\" sizes=\"(max-width: 548px) 100vw, 548px\"></figure><p>พอดีได้คุยเรื่องของ code ที่พัฒนาด้วย NodeJS + Express เล็กน้อย<br>ซึ่งมี code บางตัวที่น่าสนใจ<br>เนื่องจากเป็น code ที่ทำให้การทำงานมันเป็น Blocking IO ซะงั้น<br>เลยสรุปตัวอย่างไว้นิดหน่อย<br>เพื่อทำให้เห็นว่ NodeJS มันทำงานอย่างไร<br>เมื่อมีจำนวน concurrent ของผู้ใช้งานเยอะ ๆ</p><p><strong>ตัวอย่าง code ง่าย ๆ</strong></p><p>แยกเป็น</p><ul><li>/ คือ router หลัก</li><li>/block คือ code ที่ทำงานแบบ blocking ซึ่งจะรอไปจบกว่าเวลาจะเกิน 1 วินาที</li><li>/non-block คือ code ที่ทำงานแบบ non-blocking แน่นอนว่าจะรอ 1 วินาทีเช่นเดียวกัน</li></ul><div itemprop=\"text\" id=\"gist107794715\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-server-js-L1\" data-line-number=\"1\"></td><td id=\"file-server-js-LC1\"><span>const</span> <span>express</span> <span>=</span> <span>require</span><span>(</span><span>\"express\"</span><span>)</span><span>;</span></td></tr><tr><td id=\"file-server-js-L2\" data-line-number=\"2\"></td><td id=\"file-server-js-LC2\"><span>const</span> <span>app</span> <span>=</span> <span>express</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id=\"file-server-js-L3\" data-line-number=\"3\"></td><td id=\"file-server-js-LC3\"><span>const</span> <span>port</span> <span>=</span> <span>3000</span><span>;</span></td></tr><tr><td id=\"file-server-js-L4\" data-line-number=\"4\"></td><td id=\"file-server-js-LC4\"></td></tr><tr><td id=\"file-server-js-L5\" data-line-number=\"5\"></td><td id=\"file-server-js-LC5\"><span>app</span><span>.</span><span>get</span><span>(</span><span>\"/\"</span><span>,</span> <span>(</span><span>req</span><span>,</span> <span>res</span><span>)</span> <span>=&gt;</span> <span>{</span></td></tr><tr><td id=\"file-server-js-L6\" data-line-number=\"6\"></td><td id=\"file-server-js-LC6\"><span>res</span><span>.</span><span>send</span><span>(</span><span>\"Hello World!\"</span><span>)</span><span>;</span></td></tr><tr><td id=\"file-server-js-L7\" data-line-number=\"7\"></td><td id=\"file-server-js-LC7\"><span>}</span><span>)</span><span>;</span></td></tr><tr><td id=\"file-server-js-L8\" data-line-number=\"8\"></td><td id=\"file-server-js-LC8\"></td></tr><tr><td id=\"file-server-js-L9\" data-line-number=\"9\"></td><td id=\"file-server-js-LC9\"><span>app</span><span>.</span><span>get</span><span>(</span><span>\"/block\"</span><span>,</span> <span>(</span><span>req</span><span>,</span> <span>res</span><span>)</span> <span>=&gt;</span> <span>{</span></td></tr><tr><td id=\"file-server-js-L10\" data-line-number=\"10\"></td><td id=\"file-server-js-LC10\"><span>const</span> <span>startTime</span> <span>=</span> <span>Date</span><span>.</span><span>now</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id=\"file-server-js-L11\" data-line-number=\"11\"></td><td id=\"file-server-js-LC11\"><span>while</span> <span>(</span><span>Date</span><span>.</span><span>now</span><span>(</span><span>)</span> <span>-</span> <span>startTime</span> <span>&lt;</span> <span>1000</span><span>)</span> <span>{</span><span>}</span></td></tr><tr><td id=\"file-server-js-L12\" data-line-number=\"12\"></td><td id=\"file-server-js-LC12\"><span>res</span><span>.</span><span>send</span><span>(</span><span>\"Hello World!\"</span><span>)</span><span>;</span></td></tr><tr><td id=\"file-server-js-L13\" data-line-number=\"13\"></td><td id=\"file-server-js-LC13\"><span>}</span><span>)</span><span>;</span></td></tr><tr><td id=\"file-server-js-L14\" data-line-number=\"14\"></td><td id=\"file-server-js-LC14\"></td></tr><tr><td id=\"file-server-js-L15\" data-line-number=\"15\"></td><td id=\"file-server-js-LC15\"><span>app</span><span>.</span><span>get</span><span>(</span><span>\"/non-block\"</span><span>,</span> <span>(</span><span>req</span><span>,</span> <span>res</span><span>)</span> <span>=&gt;</span> <span>{</span></td></tr><tr><td id=\"file-server-js-L16\" data-line-number=\"16\"></td><td id=\"file-server-js-LC16\"><span>setTimeout</span><span>(</span><span>function</span> <span>(</span><span>)</span> <span>{</span></td></tr><tr><td id=\"file-server-js-L17\" data-line-number=\"17\"></td><td id=\"file-server-js-LC17\"><span>res</span><span>.</span><span>send</span><span>(</span><span>\"Hello World!\"</span><span>)</span><span>;</span></td></tr><tr><td id=\"file-server-js-L18\" data-line-number=\"18\"></td><td id=\"file-server-js-LC18\"><span>}</span><span>,</span> <span>1000</span><span>)</span><span>;</span></td></tr><tr><td id=\"file-server-js-L19\" data-line-number=\"19\"></td><td id=\"file-server-js-LC19\"><span>}</span><span>)</span><span>;</span></td></tr><tr><td id=\"file-server-js-L20\" data-line-number=\"20\"></td><td id=\"file-server-js-LC20\"></td></tr><tr><td id=\"file-server-js-L21\" data-line-number=\"21\"></td><td id=\"file-server-js-LC21\"><span>app</span><span>.</span><span>listen</span><span>(</span><span>port</span><span>,</span> <span>(</span><span>)</span> <span>=&gt;</span> <span>{</span></td></tr><tr><td id=\"file-server-js-L22\" data-line-number=\"22\"></td><td id=\"file-server-js-LC22\"><span>console</span><span>.</span><span>log</span><span>(</span><span>`Example app listening at http://localhost:<span><span>${</span><span>port</span><span>}</span></span>`</span><span>)</span><span>;</span></td></tr><tr><td id=\"file-server-js-L23\" data-line-number=\"23\"></td><td id=\"file-server-js-LC23\"><span>}</span><span>)</span><span>;</span></td></tr></tbody></table></div><p><strong>คำอธิบาย</strong></p><p>ระหว่าง /block และ /non-block จะได้ผลการทำงานที่แตกต่างกัน<br>เนื่องจาก NodeJS นั้นทำงานแบบ Single thread นั่นเอง<br>ถ้าเจอ code แบบ blocking เข้าไปแล้ว<br>request อื่น ๆ ก็ต้องรอเข้าคิวนั่นเอง<br>ทำให้การทำงานช้ามาก ๆ</p><p><strong>ผลการทดสอบแบบง่าย ๆ</strong></p><div itemprop=\"text\" id=\"gist107794715\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-result-txt-L1\" data-line-number=\"1\"></td><td id=\"file-result-txt-LC1\">// Hello world with express</td></tr><tr><td id=\"file-result-txt-L2\" data-line-number=\"2\"></td><td id=\"file-result-txt-LC2\">$wrk -c 100 -t 5 -d 10s http://localhost:3000/</td></tr><tr><td id=\"file-result-txt-L3\" data-line-number=\"3\"></td><td id=\"file-result-txt-LC3\"></td></tr><tr><td id=\"file-result-txt-L4\" data-line-number=\"4\"></td><td id=\"file-result-txt-LC4\">Running 10s test @ http://localhost:3000/</td></tr><tr><td id=\"file-result-txt-L5\" data-line-number=\"5\"></td><td id=\"file-result-txt-LC5\">5 threads and 100 connections</td></tr><tr><td id=\"file-result-txt-L6\" data-line-number=\"6\"></td><td id=\"file-result-txt-LC6\">Thread Stats Avg Stdev Max +/- Stdev</td></tr><tr><td id=\"file-result-txt-L7\" data-line-number=\"7\"></td><td id=\"file-result-txt-LC7\">Latency 10.36ms 2.75ms 43.63ms 91.91%</td></tr><tr><td id=\"file-result-txt-L8\" data-line-number=\"8\"></td><td id=\"file-result-txt-LC8\">Req/Sec 1.95k 315.46 2.24k 88.29%</td></tr><tr><td id=\"file-result-txt-L9\" data-line-number=\"9\"></td><td id=\"file-result-txt-LC9\">97902 requests in 10.11s, 22.31MB read</td></tr><tr><td id=\"file-result-txt-L10\" data-line-number=\"10\"></td><td id=\"file-result-txt-LC10\">Requests/sec: 9684.28</td></tr><tr><td id=\"file-result-txt-L11\" data-line-number=\"11\"></td><td id=\"file-result-txt-LC11\"></td></tr><tr><td id=\"file-result-txt-L12\" data-line-number=\"12\"></td><td id=\"file-result-txt-LC12\">// Hello world with Blocking + waiting 1000 ms</td></tr><tr><td id=\"file-result-txt-L13\" data-line-number=\"13\"></td><td id=\"file-result-txt-LC13\">$wrk -c 100 -t 5 -d 10s http://localhost:3000/block</td></tr><tr><td id=\"file-result-txt-L14\" data-line-number=\"14\"></td><td id=\"file-result-txt-LC14\"></td></tr><tr><td id=\"file-result-txt-L15\" data-line-number=\"15\"></td><td id=\"file-result-txt-LC15\">Running 10s test @ http://localhost:3000/block</td></tr><tr><td id=\"file-result-txt-L16\" data-line-number=\"16\"></td><td id=\"file-result-txt-LC16\">5 threads and 100 connections</td></tr><tr><td id=\"file-result-txt-L17\" data-line-number=\"17\"></td><td id=\"file-result-txt-LC17\">Thread Stats Avg Stdev Max +/- Stdev</td></tr><tr><td id=\"file-result-txt-L18\" data-line-number=\"18\"></td><td id=\"file-result-txt-LC18\">Latency 1.01s 0.00us 1.01s 100.00%</td></tr><tr><td id=\"file-result-txt-L19\" data-line-number=\"19\"></td><td id=\"file-result-txt-LC19\">Req/Sec 0.00 0.00 0.00 100.00%</td></tr><tr><td id=\"file-result-txt-L20\" data-line-number=\"20\"></td><td id=\"file-result-txt-LC20\">10 requests in 10.08s, 2.33KB read</td></tr><tr><td id=\"file-result-txt-L21\" data-line-number=\"21\"></td><td id=\"file-result-txt-LC21\">Socket errors: connect 0, read 0, write 0, timeout 9</td></tr><tr><td id=\"file-result-txt-L22\" data-line-number=\"22\"></td><td id=\"file-result-txt-LC22\">Requests/sec: 0.99</td></tr><tr><td id=\"file-result-txt-L23\" data-line-number=\"23\"></td><td id=\"file-result-txt-LC23\">Transfer/sec: 237.02B</td></tr><tr><td id=\"file-result-txt-L24\" data-line-number=\"24\"></td><td id=\"file-result-txt-LC24\"></td></tr><tr><td id=\"file-result-txt-L25\" data-line-number=\"25\"></td><td id=\"file-result-txt-LC25\">// Hello world with Non-Blocking + Callback + setTimeout 1000 ms</td></tr><tr><td id=\"file-result-txt-L26\" data-line-number=\"26\"></td><td id=\"file-result-txt-LC26\">$wrk -c 100 -t 5 -d 10s http://localhost:3000/non-block</td></tr><tr><td id=\"file-result-txt-L27\" data-line-number=\"27\"></td><td id=\"file-result-txt-LC27\"></td></tr><tr><td id=\"file-result-txt-L28\" data-line-number=\"28\"></td><td id=\"file-result-txt-LC28\">Running 10s test @ http://localhost:3000/non-block</td></tr><tr><td id=\"file-result-txt-L29\" data-line-number=\"29\"></td><td id=\"file-result-txt-LC29\">5 threads and 100 connections</td></tr><tr><td id=\"file-result-txt-L30\" data-line-number=\"30\"></td><td id=\"file-result-txt-LC30\">Thread Stats Avg Stdev Max +/- Stdev</td></tr><tr><td id=\"file-result-txt-L31\" data-line-number=\"31\"></td><td id=\"file-result-txt-LC31\">Latency 1.01s 9.44ms 1.04s 70.78%</td></tr><tr><td id=\"file-result-txt-L32\" data-line-number=\"32\"></td><td id=\"file-result-txt-LC32\">Req/Sec 39.11 44.21 184.00 82.81%</td></tr><tr><td id=\"file-result-txt-L33\" data-line-number=\"33\"></td><td id=\"file-result-txt-LC33\">900 requests in 10.10s, 210.06KB read</td></tr><tr><td id=\"file-result-txt-L34\" data-line-number=\"34\"></td><td id=\"file-result-txt-LC34\">Requests/sec: 89.13</td></tr><tr><td id=\"file-result-txt-L35\" data-line-number=\"35\"></td><td id=\"file-result-txt-LC35\">Transfer/sec: 20.80KB</td></tr></tbody></table></div><p>เขียน code เพื่อดูผล จะทำให้เข้าใจมากขึ้นเยอะเลย<br>ดังนั้นรูปแบบการเขียน code จึงสำคัญมากเช่นกัน</p></div><div><p><img alt=\"\" src=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=90&amp;d=mm&amp;r=g\" srcset=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=180&amp;d=mm&amp;r=g 2x\" height=\"90\" width=\"90\"></p><h4>Article by <a href=\"https://www.facebook.com/somkiatspns\">Somkiat Puisungnoen</a></h4><p>To be Craftmanship</p></div></div></article></div></div>","author":"somkiat","siteTitle":"cc :: somkiat","siteHash":"3a23a5a4389e1e40c6fbb16520a8cc20df5b3591c25145ce72aaa18b19e48201","entryHash":"bf2f4f6a341668453745ff2e875e06e0b7eff9918df40e556ae062f46ce81ffa","category":"Thai"}