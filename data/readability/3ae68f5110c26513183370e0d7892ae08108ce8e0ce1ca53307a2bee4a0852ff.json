{"title":"การจัดการ Transaction แบบง่าย ๆ กับ Spring Data JPA","link":"https://www.somkiat.cc/manage-transaction-in-spring-app/","date":1618490329000,"content":"<div id=\"readability-page-1\" class=\"page\"><div id=\"page\"><article><div id=\"content_box\"><header><div><p><time>April 15, 2021</time> <span><a href=\"https://www.somkiat.cc/category/programming/\" rel=\"category tag\">Programming</a></span></p></div></header><div><p>เห็นคำถามในกลุ่ม <a rel=\"noreferrer noopener\" href=\"https://www.facebook.com/groups/687453848266156/permalink/1498946413783558/\" target=\"_blank\">Spring Developer Thailand</a><br>เรื่องการจัดการ transaction ในการบันทึกข้อมูลลง database<br>ผ่าน repository layer ว่าทำอย่างไร ?<br>ก่อนที่จะรู้ว่าต้องทำอย่างไร<br>ควรต้องเข้าใจพฤติกรรมการทำงานพื้นฐานกันก่อน</p><p><strong>เริ่มต้นผมลองสร้าง project ด้วย</strong></p><ul><li>Spring Boot</li><li>Spring Data JPA ใชสำหรับจัดการกับ database</li><li>H2 คือ in-memory database</li></ul><p>จากนั้นทำการสร้าง Repository 3 ตัวตามคำถามจาก link ในกลุ่ม<br>ในส่วนของการจัดการบันทึกข้อมูลทั้ง 3 repository<br>จะทำงานใน Service Layer แบบปกติ ดังนี้</p><div itemprop=\"text\" id=\"gist109019116\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-demoservice-java-L1\" data-line-number=\"1\"></td><td id=\"file-demoservice-java-LC1\"><span>@Service</span></td></tr><tr><td id=\"file-demoservice-java-L2\" data-line-number=\"2\"></td><td id=\"file-demoservice-java-LC2\"><span>public</span> <span>class</span> <span>DemoService</span> {</td></tr><tr><td id=\"file-demoservice-java-L3\" data-line-number=\"3\"></td><td id=\"file-demoservice-java-LC3\"></td></tr><tr><td id=\"file-demoservice-java-L4\" data-line-number=\"4\"></td><td id=\"file-demoservice-java-LC4\"><span>@Autowired</span></td></tr><tr><td id=\"file-demoservice-java-L5\" data-line-number=\"5\"></td><td id=\"file-demoservice-java-LC5\"><span>private</span> <span>Repository1</span> repository1;</td></tr><tr><td id=\"file-demoservice-java-L6\" data-line-number=\"6\"></td><td id=\"file-demoservice-java-LC6\"><span>@Autowired</span></td></tr><tr><td id=\"file-demoservice-java-L7\" data-line-number=\"7\"></td><td id=\"file-demoservice-java-LC7\"><span>private</span> <span>Repository2</span> repository2;</td></tr><tr><td id=\"file-demoservice-java-L8\" data-line-number=\"8\"></td><td id=\"file-demoservice-java-LC8\"><span>@Autowired</span></td></tr><tr><td id=\"file-demoservice-java-L9\" data-line-number=\"9\"></td><td id=\"file-demoservice-java-LC9\"><span>private</span> <span>Repository3</span> repository3;</td></tr><tr><td id=\"file-demoservice-java-L10\" data-line-number=\"10\"></td><td id=\"file-demoservice-java-LC10\"></td></tr><tr><td id=\"file-demoservice-java-L11\" data-line-number=\"11\"></td><td id=\"file-demoservice-java-LC11\"></td></tr><tr><td id=\"file-demoservice-java-L12\" data-line-number=\"12\"></td><td id=\"file-demoservice-java-LC12\"><span>public</span> <span>String</span> <span>defaultTx</span>() {</td></tr><tr><td id=\"file-demoservice-java-L13\" data-line-number=\"13\"></td><td id=\"file-demoservice-java-LC13\">repository1<span>.</span>save(<span>new</span> <span>User</span>(<span>1</span>, <span><span>\"</span>user 01<span>\"</span></span>));</td></tr><tr><td id=\"file-demoservice-java-L14\" data-line-number=\"14\"></td><td id=\"file-demoservice-java-LC14\">repository2<span>.</span>save(<span>new</span> <span>User</span>(<span>2</span>, <span><span>\"</span>user 02<span>\"</span></span>));</td></tr><tr><td id=\"file-demoservice-java-L15\" data-line-number=\"15\"></td><td id=\"file-demoservice-java-LC15\">repository3<span>.</span>save(<span>new</span> <span>User</span>(<span>3</span>, <span><span>\"</span>user 03<span>\"</span></span>));</td></tr><tr><td id=\"file-demoservice-java-L16\" data-line-number=\"16\"></td><td id=\"file-demoservice-java-LC16\"></td></tr><tr><td id=\"file-demoservice-java-L17\" data-line-number=\"17\"></td><td id=\"file-demoservice-java-LC17\"><span>long</span> count <span>=</span> repository1<span>.</span>count();</td></tr><tr><td id=\"file-demoservice-java-L18\" data-line-number=\"18\"></td><td id=\"file-demoservice-java-LC18\"><span>return</span> <span><span>\"</span>down with <span>\"</span></span> <span>+</span> count;</td></tr><tr><td id=\"file-demoservice-java-L19\" data-line-number=\"19\"></td><td id=\"file-demoservice-java-LC19\">}</td></tr><tr><td id=\"file-demoservice-java-L20\" data-line-number=\"20\"></td><td id=\"file-demoservice-java-LC20\"></td></tr><tr><td id=\"file-demoservice-java-L21\" data-line-number=\"21\"></td><td id=\"file-demoservice-java-LC21\">}</td></tr></tbody></table></div><p><strong>จากนั้นทำการ config เรื่องการแสดง logging ของ Transaction และคำสั่ง SQL</strong></p><p>เพื่อดูการทำงานของระบบ</p><div itemprop=\"text\" id=\"gist109019116\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-application-properties-L1\" data-line-number=\"1\"></td><td id=\"file-application-properties-LC1\"><span>spring.jpa.show-sql</span>=true</td></tr><tr><td id=\"file-application-properties-L2\" data-line-number=\"2\"></td><td id=\"file-application-properties-LC2\"><span>logging.level.org.hibernate.engine.transaction.internal.TransactionImpl</span>=DEBUG</td></tr></tbody></table></div><p><strong>จากนั้นลอง run และดูผล</strong></p><p>จะเห็นได้ว่า จะทำการ commit ในแต่ละ repository<br>นั่นคือเกิด 3 transaction</p><div itemprop=\"text\" id=\"gist109019116\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-1-log-L1\" data-line-number=\"1\"></td><td id=\"file-1-log-LC1\">DEBUG 79625 --- [nio-8080-exec-1] o.h.e.t.internal.TransactionImpl : On TransactionImpl creation, JpaCompliance#isJpaTransactionComplianceEnabled == false</td></tr><tr><td id=\"file-1-log-L2\" data-line-number=\"2\"></td><td id=\"file-1-log-LC2\">DEBUG 79625 --- [nio-8080-exec-1] o.h.e.t.internal.TransactionImpl : begin</td></tr><tr><td id=\"file-1-log-L3\" data-line-number=\"3\"></td><td id=\"file-1-log-LC3\">Hibernate: select user0_.id as id1_0_0_, user0_.name as name2_0_0_ from user user0_ where user0_.id=?</td></tr><tr><td id=\"file-1-log-L4\" data-line-number=\"4\"></td><td id=\"file-1-log-LC4\">DEBUG 79625 --- [nio-8080-exec-1] o.h.e.t.internal.TransactionImpl : committing</td></tr><tr><td id=\"file-1-log-L5\" data-line-number=\"5\"></td><td id=\"file-1-log-LC5\">Hibernate: insert into user (name, id) values (?, ?)</td></tr><tr><td id=\"file-1-log-L6\" data-line-number=\"6\"></td><td id=\"file-1-log-LC6\">DEBUG 79625 --- [nio-8080-exec-1] o.h.e.t.internal.TransactionImpl : begin</td></tr><tr><td id=\"file-1-log-L7\" data-line-number=\"7\"></td><td id=\"file-1-log-LC7\">Hibernate: select user0_.id as id1_0_0_, user0_.name as name2_0_0_ from user user0_ where user0_.id=?</td></tr><tr><td id=\"file-1-log-L8\" data-line-number=\"8\"></td><td id=\"file-1-log-LC8\">DEBUG 79625 --- [nio-8080-exec-1] o.h.e.t.internal.TransactionImpl : committing</td></tr><tr><td id=\"file-1-log-L9\" data-line-number=\"9\"></td><td id=\"file-1-log-LC9\">Hibernate: insert into user (name, id) values (?, ?)</td></tr><tr><td id=\"file-1-log-L10\" data-line-number=\"10\"></td><td id=\"file-1-log-LC10\">DEBUG 79625 --- [nio-8080-exec-1] o.h.e.t.internal.TransactionImpl : begin</td></tr><tr><td id=\"file-1-log-L11\" data-line-number=\"11\"></td><td id=\"file-1-log-LC11\">Hibernate: select user0_.id as id1_0_0_, user0_.name as name2_0_0_ from user user0_ where user0_.id=?</td></tr><tr><td id=\"file-1-log-L12\" data-line-number=\"12\"></td><td id=\"file-1-log-LC12\">DEBUG 79625 --- [nio-8080-exec-1] o.h.e.t.internal.TransactionImpl : committing</td></tr><tr><td id=\"file-1-log-L13\" data-line-number=\"13\"></td><td id=\"file-1-log-LC13\">Hibernate: insert into user (name, id) values (?, ?)</td></tr><tr><td id=\"file-1-log-L14\" data-line-number=\"14\"></td><td id=\"file-1-log-LC14\">DEBUG 79625 --- [nio-8080-exec-1] o.h.e.t.internal.TransactionImpl : begin</td></tr><tr><td id=\"file-1-log-L15\" data-line-number=\"15\"></td><td id=\"file-1-log-LC15\">Hibernate: select count(*) as col_0_0_ from user user0_</td></tr><tr><td id=\"file-1-log-L16\" data-line-number=\"16\"></td><td id=\"file-1-log-LC16\">DEBUG 79625 --- [nio-8080-exec-1] o.h.e.t.internal.TransactionImpl : committing</td></tr></tbody></table></div><p><strong>แต่ถ้าเราต้องการให้ทั้ง 3 repositry ให้อยู่ใน Transaction เดียวกัน</strong></p><p>ให้ทำการจัดการในส่วนของ Service Layer ด้วยการใส่ @Transactional ไปดังนี้</p><div itemprop=\"text\" id=\"gist109019116\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-demoservice2-java-L1\" data-line-number=\"1\"></td><td id=\"file-demoservice2-java-LC1\"><span>@Service</span></td></tr><tr><td id=\"file-demoservice2-java-L2\" data-line-number=\"2\"></td><td id=\"file-demoservice2-java-LC2\"><span>public</span> <span>class</span> <span>DemoService</span> {</td></tr><tr><td id=\"file-demoservice2-java-L3\" data-line-number=\"3\"></td><td id=\"file-demoservice2-java-LC3\"></td></tr><tr><td id=\"file-demoservice2-java-L4\" data-line-number=\"4\"></td><td id=\"file-demoservice2-java-LC4\"><span>@Autowired</span></td></tr><tr><td id=\"file-demoservice2-java-L5\" data-line-number=\"5\"></td><td id=\"file-demoservice2-java-LC5\"><span>private</span> <span>Repository1</span> repository1;</td></tr><tr><td id=\"file-demoservice2-java-L6\" data-line-number=\"6\"></td><td id=\"file-demoservice2-java-LC6\"><span>@Autowired</span></td></tr><tr><td id=\"file-demoservice2-java-L7\" data-line-number=\"7\"></td><td id=\"file-demoservice2-java-LC7\"><span>private</span> <span>Repository2</span> repository2;</td></tr><tr><td id=\"file-demoservice2-java-L8\" data-line-number=\"8\"></td><td id=\"file-demoservice2-java-LC8\"><span>@Autowired</span></td></tr><tr><td id=\"file-demoservice2-java-L9\" data-line-number=\"9\"></td><td id=\"file-demoservice2-java-LC9\"><span>private</span> <span>Repository3</span> repository3;</td></tr><tr><td id=\"file-demoservice2-java-L10\" data-line-number=\"10\"></td><td id=\"file-demoservice2-java-LC10\"></td></tr><tr><td id=\"file-demoservice2-java-L11\" data-line-number=\"11\"></td><td id=\"file-demoservice2-java-LC11\"></td></tr><tr><td id=\"file-demoservice2-java-L12\" data-line-number=\"12\"></td><td id=\"file-demoservice2-java-LC12\"><span>@Transactional</span></td></tr><tr><td id=\"file-demoservice2-java-L13\" data-line-number=\"13\"></td><td id=\"file-demoservice2-java-LC13\"><span>public</span> <span>String</span> <span>defaultTx</span>() {</td></tr><tr><td id=\"file-demoservice2-java-L14\" data-line-number=\"14\"></td><td id=\"file-demoservice2-java-LC14\">repository1<span>.</span>save(<span>new</span> <span>User</span>(<span>1</span>, <span><span>\"</span>user 01<span>\"</span></span>));</td></tr><tr><td id=\"file-demoservice2-java-L15\" data-line-number=\"15\"></td><td id=\"file-demoservice2-java-LC15\">repository2<span>.</span>save(<span>new</span> <span>User</span>(<span>2</span>, <span><span>\"</span>user 02<span>\"</span></span>));</td></tr><tr><td id=\"file-demoservice2-java-L16\" data-line-number=\"16\"></td><td id=\"file-demoservice2-java-LC16\">repository3<span>.</span>save(<span>new</span> <span>User</span>(<span>3</span>, <span><span>\"</span>user 03<span>\"</span></span>));</td></tr><tr><td id=\"file-demoservice2-java-L17\" data-line-number=\"17\"></td><td id=\"file-demoservice2-java-LC17\"></td></tr><tr><td id=\"file-demoservice2-java-L18\" data-line-number=\"18\"></td><td id=\"file-demoservice2-java-LC18\"><span>long</span> count <span>=</span> repository1<span>.</span>count();</td></tr><tr><td id=\"file-demoservice2-java-L19\" data-line-number=\"19\"></td><td id=\"file-demoservice2-java-LC19\"><span>return</span> <span><span>\"</span>down with <span>\"</span></span> <span>+</span> count;</td></tr><tr><td id=\"file-demoservice2-java-L20\" data-line-number=\"20\"></td><td id=\"file-demoservice2-java-LC20\">}</td></tr><tr><td id=\"file-demoservice2-java-L21\" data-line-number=\"21\"></td><td id=\"file-demoservice2-java-LC21\"></td></tr><tr><td id=\"file-demoservice2-java-L22\" data-line-number=\"22\"></td><td id=\"file-demoservice2-java-LC22\">}</td></tr></tbody></table></div><p>ผลการทำงานจาก log จะเป็นดังนี้<br>ซึ่งเป็นไปตามที่ต้องการคือ อยู่ใน transaction เดียวกัน<br>ดังนั้นถ้ามี repository ใด ที่ fail ขึ้นมา<br>จะทำการ rollback transaction ให้เอง</p><div itemprop=\"text\" id=\"gist109019116\"><table data-tab-size=\"8\" data-paste-markdown-skip=\"\"><tbody><tr><td id=\"file-2-log-L1\" data-line-number=\"1\"></td><td id=\"file-2-log-LC1\">DEBUG 79667 --- [nio-8080-exec-1] o.h.e.t.internal.TransactionImpl : On TransactionImpl creation, JpaCompliance#isJpaTransactionComplianceEnabled == false</td></tr><tr><td id=\"file-2-log-L2\" data-line-number=\"2\"></td><td id=\"file-2-log-LC2\">DEBUG 79667 --- [nio-8080-exec-1] o.h.e.t.internal.TransactionImpl : begin</td></tr><tr><td id=\"file-2-log-L3\" data-line-number=\"3\"></td><td id=\"file-2-log-LC3\">Hibernate: select user0_.id as id1_0_0_, user0_.name as name2_0_0_ from user user0_ where user0_.id=?</td></tr><tr><td id=\"file-2-log-L4\" data-line-number=\"4\"></td><td id=\"file-2-log-LC4\">Hibernate: select user0_.id as id1_0_0_, user0_.name as name2_0_0_ from user user0_ where user0_.id=?</td></tr><tr><td id=\"file-2-log-L5\" data-line-number=\"5\"></td><td id=\"file-2-log-LC5\">Hibernate: select user0_.id as id1_0_0_, user0_.name as name2_0_0_ from user user0_ where user0_.id=?</td></tr><tr><td id=\"file-2-log-L6\" data-line-number=\"6\"></td><td id=\"file-2-log-LC6\">Hibernate: insert into user (name, id) values (?, ?)</td></tr><tr><td id=\"file-2-log-L7\" data-line-number=\"7\"></td><td id=\"file-2-log-LC7\">Hibernate: insert into user (name, id) values (?, ?)</td></tr><tr><td id=\"file-2-log-L8\" data-line-number=\"8\"></td><td id=\"file-2-log-LC8\">Hibernate: insert into user (name, id) values (?, ?)</td></tr><tr><td id=\"file-2-log-L9\" data-line-number=\"9\"></td><td id=\"file-2-log-LC9\">DEBUG 79667 --- [nio-8080-exec-1] o.h.e.t.internal.TransactionImpl : committing</td></tr></tbody></table></div><p>จะเห็นว่า เราสามารถจัดการ transaction พื้นฐานใน Service Layer ได้แล้ว</p></div><div><p><img alt=\"\" src=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=90&amp;d=mm&amp;r=g\" srcset=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=180&amp;d=mm&amp;r=g 2x\" height=\"90\" width=\"90\"></p><h4>Article by <a href=\"https://www.facebook.com/somkiatspns\">Somkiat Puisungnoen</a></h4><p>To be Craftmanship</p></div></div></article></div></div>","author":"somkiat","siteTitle":"cc :: somkiat","siteHash":"3a23a5a4389e1e40c6fbb16520a8cc20df5b3591c25145ce72aaa18b19e48201","entryHash":"3ae68f5110c26513183370e0d7892ae08108ce8e0ce1ca53307a2bee4a0852ff","category":"Thai"}