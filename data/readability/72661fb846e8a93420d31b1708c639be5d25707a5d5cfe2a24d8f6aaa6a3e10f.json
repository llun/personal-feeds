{"title":"[Nodejs] แจ้งเตือน Gitlab ผ่าน Line notify","link":"https://thanapon.info/gitlab-line-notification/","date":1612455927000,"content":"<div id=\"readability-page-1\" class=\"page\"><div id=\"post-588\"><div><p><span>February 4, 2021</span> <span><a href=\"https://thanapon.info/category/line-notify/\" rel=\"category tag\">Line-notify</a>, <a href=\"https://thanapon.info/category/nodejs/\" rel=\"category tag\">NodeJs</a></span></p></div><p><img width=\"800\" height=\"375\" src=\"https://thanapon.info/wp-content/uploads/2021/02/gitlab-line.png\" alt=\"[Nodejs] แจ้งเตือน Gitlab ผ่าน Line notify\" loading=\"lazy\" srcset=\"https://thanapon.info/wp-content/uploads/2021/02/gitlab-line.png 800w, https://thanapon.info/wp-content/uploads/2021/02/gitlab-line-300x141.png 300w, https://thanapon.info/wp-content/uploads/2021/02/gitlab-line-768x360.png 768w, https://thanapon.info/wp-content/uploads/2021/02/gitlab-line-600x281.png 600w\" sizes=\"(max-width: 800px) 100vw, 800px\"></p><div><p>สวัสดีครับ เชื่อว่าทุกคนคงเคยใช้พวก version control กันแล้วนะครับ พอดีช่วงก่อนผมได้มีโอกาสลองเล่น GitLab webhooks ก็เห็นว่าอาจจะมีประโยชน์สำหรับเพื่อนๆกัน เพราะว่ามันสามารถเอามาใช้ในการแจ้งเตือน event ต่างๆที่มากระทำกับ repository ของเราโดยสามารถเข้าไปที่ Setting =&gt; Webhooks ส่วนตัว trigger event นั้นจะให้เราเลือกได้ว่าสามารถ trigger อะไรได้บ้าง ซึ่งจากตัวอย่างนั้นก็จะมี <strong>Push events</strong>, <strong>Merge request events</strong> หรือว่า <strong>Pipeline events</strong> นะครับ หากใครอยากทราบว่าแต่ละอันคืออะไรลองเข้าไปอ่านใน document ของเขาได้เลยครับ</p><div><figure><img loading=\"lazy\" src=\"https://thanapon.info/wp-content/uploads/2021/01/image-1024x970.png\" alt=\"\" width=\"512\" height=\"485\" srcset=\"https://thanapon.info/wp-content/uploads/2021/01/image-1024x970.png 1024w, https://thanapon.info/wp-content/uploads/2021/01/image-300x284.png 300w, https://thanapon.info/wp-content/uploads/2021/01/image-768x727.png 768w, https://thanapon.info/wp-content/uploads/2021/01/image-600x568.png 600w, https://thanapon.info/wp-content/uploads/2021/01/image.png 1360w\" sizes=\"(max-width: 512px) 100vw, 512px\"></figure></div><blockquote><p><a href=\"https://docs.gitlab.com/ee/user/project/integrations/webhooks.html\" target=\"_blank\" rel=\"noreferrer noopener\">Webhooks&nbsp;are “<em>user-defined HTTP callbacks</em>”. They are usually triggered by some event….</a></p><cite><a href=\"https://docs.gitlab.com/ee/user/project/integrations/webhooks.html\" target=\"_blank\" rel=\"noreferrer noopener\">https://docs.gitlab.com/ee/user/project/integrations/webhooks.html</a></cite></blockquote><p>ซึ่งเวลาเรา Commit อะไรไป ตัว Gitlab webhook นี้ก็จะส่ง Request ไปยัง endpoint ที่เราได้ตั้งค่าไว้นะครับ ซึ่งสำหรับวันนี้ผมจะลองเอา Body นั้นมาใช้ แล้วส่งเข้าไปยัง Line notify สำหรับแจ้งเตือนให้ทีมทราบว่าตอนนี้มีใคร Commit อะไรบ้าง มีการ Merge request หรือแจ้งสถานะ CI/CD pipeline [success, pending, failed] ครับ</p><p>โดยหลักๆแล้ว ตัว Webhooks จะใช้ POST method ในการยิง Request มาที่ Server ของเรา ซึ่งโปรเจคนี้ผมจะพัฒนาโดยใช้ Nodejs express นะครับ</p><p>เริ่มต้นลอง clone โปรเจคจาก git มาลองดูนะครับ</p><div><pre data-lang=\"Git\"><code data-hcb-clip=\"1\">git clone https://github.com/toygame/gitlab-line-notify.git</code></pre></div><p>จากนั้นลองเข้าไปที่ Directory =&gt; routes =&gt; handleEvents =&gt; index.js ซึ่งจะเป็นไฟล์ที่ใช้สำหรับแมพข้อความที่จะส่งเข้ามาทาง Line notify โดยเบื้องต้นผมจะสร้าง CommitEvent, MergeRequestEvent, PipelineEvent ให้นะครับ</p><p>ส่วน Request ที่ยิงไป Line notify ก็ใช้ Axios โดยใช้ HTTP method POST เข้าไปแล้วก็ตั้งค่าส่วน Header เป็น</p><ul><li>authorization: bearer {TOKEN}</li><li>content-type: application/x-www-form-urlencoded</li></ul><p>เป็นอันเสร็จเรียบร้อย</p><h4>เอา Token มาจาก Line-notify ยังไง?</h4><div><figure><img loading=\"lazy\" width=\"976\" height=\"146\" src=\"https://thanapon.info/wp-content/uploads/2021/01/image-1.png\" alt=\"\" srcset=\"https://thanapon.info/wp-content/uploads/2021/01/image-1.png 976w, https://thanapon.info/wp-content/uploads/2021/01/image-1-300x45.png 300w, https://thanapon.info/wp-content/uploads/2021/01/image-1-768x115.png 768w, https://thanapon.info/wp-content/uploads/2021/01/image-1-600x90.png 600w\" sizes=\"(max-width: 976px) 100vw, 976px\"></figure></div><p>อันดับแรกเข้าไปที่ <a rel=\"noreferrer noopener\" href=\"https://notify-bot.line.me/en/\" target=\"_blank\">https://notify-bot.line.me/en/</a> จากนั้นก็ log-in โดยใช้ username/password ของเรานี้หล่ะครับ</p><div><figure><img loading=\"lazy\" src=\"https://thanapon.info/wp-content/uploads/2021/01/image-2-1024x396.png\" alt=\"\" width=\"512\" height=\"198\" srcset=\"https://thanapon.info/wp-content/uploads/2021/01/image-2-1024x396.png 1024w, https://thanapon.info/wp-content/uploads/2021/01/image-2-300x116.png 300w, https://thanapon.info/wp-content/uploads/2021/01/image-2-768x297.png 768w, https://thanapon.info/wp-content/uploads/2021/01/image-2-600x232.png 600w, https://thanapon.info/wp-content/uploads/2021/01/image-2.png 1066w\" sizes=\"(max-width: 512px) 100vw, 512px\"></figure></div><p>จากนั้นตรงปุ่ม “ชื่อ” ของเราเลือก My page เราก็จะเห็นหน้า dashboard ที่แสดง Line-notify ของเราเชื่อมต่อกับ Bot ตัวไหนอยู่ เมื่อเลื่อนหน้าจอลงมาข้างล่างก็จะมีปุ่มกด Generate token ก็จัดการกดเลยครับ</p><figure><img loading=\"lazy\" src=\"https://thanapon.info/wp-content/uploads/2021/01/image-5-1024x367.png\" alt=\"\" width=\"512\" height=\"184\" srcset=\"https://thanapon.info/wp-content/uploads/2021/01/image-5-1024x367.png 1024w, https://thanapon.info/wp-content/uploads/2021/01/image-5-300x107.png 300w, https://thanapon.info/wp-content/uploads/2021/01/image-5-768x275.png 768w, https://thanapon.info/wp-content/uploads/2021/01/image-5-1536x550.png 1536w, https://thanapon.info/wp-content/uploads/2021/01/image-5-600x215.png 600w, https://thanapon.info/wp-content/uploads/2021/01/image-5.png 1816w\" sizes=\"(max-width: 512px) 100vw, 512px\"></figure><p>มันก็จะเด้ง Pop-up ขึ้นให้เราใส่ชื่อ bot ของเราและให้เลือกว่า bot ของเราจะคุยกับเราแบบ 1-1 ไหมหรือว่าคุยในกลุ่ม เสร็จแล้วก็ generate token โลดดดด!</p><div><figure><img loading=\"lazy\" src=\"https://thanapon.info/wp-content/uploads/2021/01/image-6-699x1024.png\" alt=\"\" width=\"350\" height=\"512\" srcset=\"https://thanapon.info/wp-content/uploads/2021/01/image-6-699x1024.png 699w, https://thanapon.info/wp-content/uploads/2021/01/image-6-205x300.png 205w, https://thanapon.info/wp-content/uploads/2021/01/image-6-768x1126.png 768w, https://thanapon.info/wp-content/uploads/2021/01/image-6-600x880.png 600w, https://thanapon.info/wp-content/uploads/2021/01/image-6.png 1026w\" sizes=\"(max-width: 350px) 100vw, 350px\"></figure></div><h4>Config environment file ใน Application ของเรา</h4><p>อย่าลืมสร้างไฟล์ <strong>.env</strong> ด้วยนะครับ สามารถสร้างได้จาก <strong>.dev.env</strong> นะครับหรือจะคัดลอกจากข้างล่างนี้ก็ได้ !!!!</p><div><pre><code data-hcb-clip=\"2\">PORT=8082 // พอร์ทของ web-app ของเรา\nGITLAB_TOKEN=TEST-LINE-NOTIFY // ตั้งค่า GITLAB-TOKEN ชื่ออะไรก็ได้\nLINE_NOTIFY=&lt;YOUR-TOKEN&gt; // เอา Line token มาใส่ตรงนี้\nLINE_NOTIFY_URL=https://notify-api.line.me/api/notify // Line notify endpoint</code></pre></div><h4>Running NodeJS Application!!</h4><h4>ทดสอบ Server ของเราโดยใช้ Ngrok</h4><p>ใส่ส่วนนี้ผมจะใช้ ngrok extension ของ Visual studio code แทนนะครับเพราะสะดวกดีครับ ส่วนวิธีตั้งค่า ngrok ผมจะไม่พูดถึงจะครับ</p><p>จัดการ start ngrok แล้วกำหนด port เป็น 8082 เลยครับ หลังจากนั้นเราก็จะได้ endpoint เอาไว้ใช้ใน Gitlab-webhook นะครับ</p><div><figure><img loading=\"lazy\" src=\"https://thanapon.info/wp-content/uploads/2021/01/image-8.png\" alt=\"\" width=\"461\" height=\"101\" srcset=\"https://thanapon.info/wp-content/uploads/2021/01/image-8.png 922w, https://thanapon.info/wp-content/uploads/2021/01/image-8-300x66.png 300w, https://thanapon.info/wp-content/uploads/2021/01/image-8-768x168.png 768w, https://thanapon.info/wp-content/uploads/2021/01/image-8-600x131.png 600w\" sizes=\"(max-width: 461px) 100vw, 461px\"></figure></div><h4>ตั้งค่า Gitlab-webhooks</h4><p>เริ่มต้นให้เราเข้าไปที่ Gitlab repository ที่เราต้องการจะให้ส่ง Line notify มานะครับ โดยเข้าไปที่ <strong>Setting =&gt; Webhook</strong></p><figure><img loading=\"lazy\" width=\"1024\" height=\"469\" src=\"https://thanapon.info/wp-content/uploads/2021/02/image-2-1024x469.png\" alt=\"\" srcset=\"https://thanapon.info/wp-content/uploads/2021/02/image-2-1024x469.png 1024w, https://thanapon.info/wp-content/uploads/2021/02/image-2-300x137.png 300w, https://thanapon.info/wp-content/uploads/2021/02/image-2-768x351.png 768w, https://thanapon.info/wp-content/uploads/2021/02/image-2-1536x703.png 1536w, https://thanapon.info/wp-content/uploads/2021/02/image-2-600x275.png 600w, https://thanapon.info/wp-content/uploads/2021/02/image-2.png 1932w\" sizes=\"(max-width: 1024px) 100vw, 1024px\"></figure><p>หลังจากนั้นก็เพิ่ม <strong>URL</strong> กับ <strong>Secret Token</strong> เบื้องต้นผมเลือก Push event เท่านั้นนะครับสำหรับท่านอื่นๆสามารถเลือก event อื่นๆได้นะครับแต่อาจจะต้องไปแกะ JSON ที่ webhook ส่งมานิดนึ่งครับ</p><figure><img loading=\"lazy\" width=\"1024\" height=\"318\" src=\"https://thanapon.info/wp-content/uploads/2021/02/image-3-1024x318.png\" alt=\"\" srcset=\"https://thanapon.info/wp-content/uploads/2021/02/image-3-1024x318.png 1024w, https://thanapon.info/wp-content/uploads/2021/02/image-3-300x93.png 300w, https://thanapon.info/wp-content/uploads/2021/02/image-3-768x238.png 768w, https://thanapon.info/wp-content/uploads/2021/02/image-3-1536x476.png 1536w, https://thanapon.info/wp-content/uploads/2021/02/image-3-600x186.png 600w, https://thanapon.info/wp-content/uploads/2021/02/image-3.png 1870w\" sizes=\"(max-width: 1024px) 100vw, 1024px\"></figure><p>เสร็จแล้วกดบันทึกแล้วลอง Test =&gt; Push events ได้เลยครับ</p><div><figure><img loading=\"lazy\" src=\"https://thanapon.info/wp-content/uploads/2021/02/image-5-608x1024.png\" alt=\"\" width=\"304\" height=\"512\" srcset=\"https://thanapon.info/wp-content/uploads/2021/02/image-5-608x1024.png 608w, https://thanapon.info/wp-content/uploads/2021/02/image-5-178x300.png 178w, https://thanapon.info/wp-content/uploads/2021/02/image-5-768x1293.png 768w, https://thanapon.info/wp-content/uploads/2021/02/image-5-912x1536.png 912w, https://thanapon.info/wp-content/uploads/2021/02/image-5-600x1010.png 600w, https://thanapon.info/wp-content/uploads/2021/02/image-5.png 938w\" sizes=\"(max-width: 304px) 100vw, 304px\"></figure></div><p>เรียบร้อยครับ ทีนี้เราก็สามารถรับการแจ้งเตือนผ่าน Line notify ได้แล้วครับ สำหรับตัว Gitlab webhook นั้นจริงๆเราสามารถเอา URL ที่เราใส่ไปนั้น เพิ่มเข้ากับ Repository อื่นๆก็ได้นะครับไม่จำเป็นต้องใช้กับแค่ Repo ใด Repo หนึ่งเท่านั้น</p><p>สำหรับวันนี้ขอบคุณและสวัสดีครับผม…..</p><hr><blockquote><p><a href=\"https://github.com/toygame/gitlab-line-notify\">GITLAB LINE NOTIFY</a>: <a href=\"https://github.com/toygame/gitlab-line-notify\">toygame/gitlab-line-notify (github.com)</a></p><cite><a href=\"https://github.com/toygame\">toygame</a>/<strong><a href=\"https://github.com/toygame/gitlab-line-notify\">gitlab-line-notify</a></strong></cite></blockquote></div></div></div>","author":"thanapon.tap","siteTitle":"Thanapon","siteHash":"6a039c2f54d76e4c49227d80968f2a30de5427cc57525c047c383ea3563cde5f","entryHash":"72661fb846e8a93420d31b1708c639be5d25707a5d5cfe2a24d8f6aaa6a3e10f","category":"Thai"}